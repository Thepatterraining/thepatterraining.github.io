<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="YwTcBpc08sCpJAE8mKZglCGHjZc1BiK9UUagC8ldlaA">
  <meta name="msvalidate.01" content="true">
  <meta name="yandex-verification" content="true">
  <meta name="baidu-site-verification" content="3PbJKzlOf0">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"thepatterraining.github.io","root":"/","scheme":"Mist","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="dream">
<meta property="og:url" content="https://thepatterraining.github.io/index.html">
<meta property="og:site_name" content="dream">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Thepatter">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://thepatterraining.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>dream</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="dream" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">dream</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">一个菜鸟程序员的成长历程</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://thepatterraining.github.io/DDD%E4%B8%BA%E4%BB%80%E4%B9%88%E5%A4%A7%E5%8E%82%E9%83%BD%E5%BC%80%E5%A7%8B%E4%BD%BF%E7%94%A8DDD%E4%BA%86.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpeg">
      <meta itemprop="name" content="Thepatter">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/DDD%E4%B8%BA%E4%BB%80%E4%B9%88%E5%A4%A7%E5%8E%82%E9%83%BD%E5%BC%80%E5%A7%8B%E4%BD%BF%E7%94%A8DDD%E4%BA%86.html" class="post-title-link" itemprop="url">为什么大厂都开始使用DDD了</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-02-27 16:51:30" itemprop="dateCreated datePublished" datetime="2025-02-27T16:51:30+08:00">2025-02-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-02-28 11:18:10" itemprop="dateModified" datetime="2025-02-28T11:18:10+08:00">2025-02-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DDD/" itemprop="url" rel="index"><span itemprop="name">DDD</span></a>
                </span>
            </span>

          
            <span id="/DDD%E4%B8%BA%E4%BB%80%E4%B9%88%E5%A4%A7%E5%8E%82%E9%83%BD%E5%BC%80%E5%A7%8B%E4%BD%BF%E7%94%A8DDD%E4%BA%86.html" class="post-meta-item leancloud_visitors" data-flag-title="为什么大厂都开始使用DDD了" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/DDD%E4%B8%BA%E4%BB%80%E4%B9%88%E5%A4%A7%E5%8E%82%E9%83%BD%E5%BC%80%E5%A7%8B%E4%BD%BF%E7%94%A8DDD%E4%BA%86.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/DDD%E4%B8%BA%E4%BB%80%E4%B9%88%E5%A4%A7%E5%8E%82%E9%83%BD%E5%BC%80%E5%A7%8B%E4%BD%BF%E7%94%A8DDD%E4%BA%86.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>大家好，我是大头，职高毕业，现在大厂资深开发，前上市公司架构师，管理过10人团队！<br>我将持续分享成体系的知识以及我自身的转码经验、面试经验、架构技术分享、AI技术分享等！<br>愿景是带领更多人完成破局、打破信息差！我自身知道走到现在是如何艰难，因此让以后的人少走弯路！<br>无论你是统本CS专业出身、专科出身、还是我和一样职高毕业等。都可以跟着我学习，一起成长！一起涨工资挣钱！<br>关注我一起挣大钱！文末有惊喜哦！</p>
</blockquote>
<blockquote>
<p>关注我发送“MySQL知识图谱”领取完整的MySQL学习路线。<br>发送“电子书”即可领取价值上千的电子书资源。<br>发送“大厂内推”即可获取京东、美团等大厂内推信息，祝你获得高薪职位。<br>发送“AI”即可领取AI学习资料。</p>
</blockquote>
<p>这里插入名片</p>
<h1 id="什么是领域驱动设计DDD"><a href="#什么是领域驱动设计DDD" class="headerlink" title="什么是领域驱动设计DDD"></a>什么是领域驱动设计DDD</h1><p>领域驱动设计（Domain-Driven Design，简称DDD）是由美国软件专家埃里克・埃文斯（Eric Evans）在2004年提出的软件设计方法论，旨在解决复杂软件系统开发过程中业务逻辑与技术实现之间的矛盾，提升软件系统的可维护性、可扩展性和灵活性。</p>
<p>说人话就是：</p>
<ul>
<li>What: 它是一种设计思想、一种指导原则。</li>
<li>When: 设计微服务的时候，或者说，不知道怎么拆分微服务的时候。</li>
<li>Why：为什么要用它，上面其实说了，不知道怎么拆分微服务的时候，可以用它来指导你如何拆分微服务。</li>
<li>How：这个后面讲。</li>
</ul>
<p>很多人都说，DDD是用来处理<code>复杂</code>业务逻辑的，那<code>多复杂</code>才算<code>复杂</code>业务呢？</p>
<p>这个问题，其实和<code>微服务什么时候用</code>是一个问题。</p>
<p>所有的技术都不是<code>银弹</code>。都有适合它的使用场景。</p>
<p>拿微服务来说，你一个小公司，就两三个开发，硬要上微服务，拆好几个服务出来，有什么<code>意义</code>吗？</p>
<p>是提升性能了？</p>
<p>是增加开发效率了？</p>
<p>都不是，你会发现拆分完以后，程序反而<code>三高</code>了。</p>
<ul>
<li>高复杂度：程序变得更加复杂了。</li>
<li>高维护成本：程序的维护成本增加了、当有需求需要修改的时候、开发效率反而降低了。</li>
<li>高运维成本：原来一台机器就满足了，你拆的服务多了，一台机器不够了。要么加机器性能要么加机器数量。</li>
</ul>
<p>所以，<code>适合</code>很重要。</p>
<blockquote>
<p>俗话说的好，见人说人话，见鬼说鬼话。技术也一样。</p>
</blockquote>
<h3 id="为什么大厂都开始使用DDD了？"><a href="#为什么大厂都开始使用DDD了？" class="headerlink" title="为什么大厂都开始使用DDD了？"></a>为什么大厂都开始使用DDD了？</h3><p>回到我们的问题，为什么大厂都开始使用DDD了？</p>
<p>因为大厂<code>人傻钱多</code>？</p>
<p>不是，有的人会说，因为大厂的业务足够<code>复杂</code>。</p>
<p>说对了一半。</p>
<blockquote>
<p>大厂通过DDD来指导微服务的拆分，解决了复杂的业务逻辑。</p>
</blockquote>
<p>这里面有一些点，我们再细细的拆分一下。</p>
<h3 id="为什么要拆分微服务？"><a href="#为什么要拆分微服务？" class="headerlink" title="为什么要拆分微服务？"></a>为什么要拆分微服务？</h3><p>再问大家一个问题，为什么要拆分微服务？</p>
<p>这个问题，千人千面。没有标准答案。</p>
<p>但是呢，总的有一些所谓的<code>最佳实践</code>。</p>
<ol>
<li>当公司成长了，流量增长了，单机很难<code>支撑</code>了。</li>
</ol>
<p>比如，你是一个做电商的公司，你某天的成交量<code>突然飙升</code>。如何解决？最简单的做法，扩容机器。</p>
<p>如果你是单机系统，你扩容的机器其实相当于扩容了整个系统，但是，你只有某几个接口的流量很大而已，其他的接口白白浪费了机器的成本。</p>
<p>再比如。你家公司的流量不是<code>突然飙升</code>，而是每天都很大，但是呢，仅限于交易模块。和上面的问题是一样的。</p>
<ol start="2">
<li>当公司成长了，需求变多了。</li>
</ol>
<p>很多人开发一个项目，代码写的很乱，大家每次<code>合并代码</code>都会出现一堆<code>冲突</code>。</p>
<p>如果你拆分成微服务的话，天然的限制和约束就可以减少冲突，因为<code>粒度</code>变小了。</p>
<p>至于为什么拆分微服务，不再赘述了。</p>
<h3 id="如何拆分微服务？"><a href="#如何拆分微服务？" class="headerlink" title="如何拆分微服务？"></a>如何拆分微服务？</h3><p>先给大家看两个例子吧。</p>
<h4 id="拆分方案1"><a href="#拆分方案1" class="headerlink" title="拆分方案1"></a>拆分方案1</h4><p>小李在一家电商公司A，A公司目前的代码架构如下：</p>
<p><img src="https://thepatterraining.github.io/images/ddd/ddd1-1.png" alt="ddd1-1"></p>
<p>现在，A公司说，要开始拆分微服务了。小李负责拆分微服务。</p>
<p>小李一想，这个很简单啊，直接拆呗，一个模块一个服务就行了。交易量大只需要扩容交易服务，很完美啊。</p>
<p>所以，拆分完成以后，架构如下：</p>
<p><img src="https://thepatterraining.github.io/images/ddd/ddd1-2.png" alt="ddd1-2"></p>
<p>一开始，小李觉得挺好，但是，逐渐发现问题了。</p>
<p>依赖严重，一个<code>购买接口</code>要跨域多个微服务。</p>
<p>既要从<code>用户服务</code>获取用户信息，又要从<code>商品服务</code>获取商品信息，还要从<code>支付服务</code>进行支付，还要从<code>库存服务</code>扣减库存，等等。。。</p>
<p>导致链路很长，接口的<code>响应速度</code>反而降低了。因为网络请求太多了。</p>
<p>写代码的时候又发现问题了，原来呢，只需要写逻辑就行了，现在还要写RPC接口。开发效率也降低了。</p>
<p>最后吧，代码写完了，又发现问题了，这事务怎么处理啊，只能上分布式事务了。开发成本又上去了。</p>
<p>结果就是，小李被领导一顿臭骂。</p>
<p>小李不语，只是默默承受着。。。</p>
<h4 id="拆分方案2"><a href="#拆分方案2" class="headerlink" title="拆分方案2"></a>拆分方案2</h4><p>小李觉得诸事不顺，跳槽去了另外一家电商公司B。</p>
<p>B公司也要拆分微服务了，领导见小李有过拆分微服务的经验，就将这个重要的任务交给了小李。</p>
<p>小李：。。。</p>
<p>小李无奈、只好继续重操旧业。</p>
<p>有了上次的失败经验，小李也学聪明了。</p>
<p>小李接下来复盘了上次的问题：</p>
<ol>
<li>微服务粒度不对</li>
<li>接口链路太长导致速度下降</li>
<li>分布式事务等导致开发效率下降，且分布式事务也导致响应时间增加。</li>
</ol>
<p>小李痛定思痛。要解决这几个问题。</p>
<p>终于，小李想到了好主意。</p>
<blockquote>
<p>我不按照模块拆分不就完了！！！</p>
</blockquote>
<p>我按照业务拆分。</p>
<p>比如，<code>购买接口</code>就放在交易服务里面。</p>
<p>那么他需要用户信息的时候自己取，不调用用户服务了，其他的逻辑也是。</p>
<p>这样确实解决了上面的一些问题，但是，<code>购买</code>还应该放在<code>交易服务</code>里面吗？</p>
<p>当需要增加一个接口的时候，我们如何判断它属于哪个服务呢？</p>
<p>小李又陷入了另外一个问题。</p>
<p>最后的结果，导致微服务里面代码很乱。</p>
<h4 id="使用DDD拆分微服务"><a href="#使用DDD拆分微服务" class="headerlink" title="使用DDD拆分微服务"></a>使用DDD拆分微服务</h4><p>上面的两个案例，不知道大家遇到过没有呢？</p>
<p>还有很多其他的错误案例，大抵意思都差不多，就是不知道如何<code>正确的</code>拆分微服务。</p>
<p>DDD就是干这个活的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DDD是指导我们如何正确拆分微服务的一种方法。</span><br></pre></td></tr></table></figure>

<h5 id="DDD的一些基本概念"><a href="#DDD的一些基本概念" class="headerlink" title="DDD的一些基本概念"></a>DDD的一些基本概念</h5><p>DDD里面有很多的概念，很难一下子说清楚，因此，这里简单介绍一下。</p>
<ul>
<li>实体：使用充血模型实现的实体，既有属性、也有方法。</li>
<li>值对象：只有属性的类。</li>
<li>聚合根：一个特殊的实体，聚合的入口。</li>
<li>聚合：聚合是一个概念、也可以理解成一个模块。聚合内包含了聚合根、实体、值对象。</li>
<li>限界上下文：分割领域的边界、也是分割微服务的边界，通过这个边界明确这个接口属于哪个领域，也就是属于哪个微服务。每个领域有每个领域的上下文。</li>
<li>领域：领域也就是我们的领域模型，也可以是一个微服务。</li>
<li>子领域：一个领域可以分成多个子领域。这个就是粒度的问题了。</li>
<li>领域事件：领域之间通信的方法。通过这个来调用其他的微服务。</li>
</ul>
<p>还有一些核心领域、支撑领域、通用领域等，都是领域的一种，作用不同而已。</p>
<p>一个<code>领域</code>里面包含了多个<code>子领域</code>，如图所示。</p>
<p><img src="https://thepatterraining.github.io/images/ddd/ddd1-3.png" alt="ddd1-3"></p>
<p>一个<code>子领域</code>里面包含了多个<code>聚合</code>，每个聚合里又有一个<code>聚合根</code>作为入口，还有若干个<code>实体</code>和<code>值对象</code>。</p>
<p><img src="https://thepatterraining.github.io/images/ddd/ddd1-4.png" alt="ddd1-4"></p>
<p>通过DDD我们可以来拆分微服务。</p>
<p>DDD是围绕<code>业务概念</code>来进行领域建模的，后续的接口也是根据业务概念来划分到对应的领域中。从而解决开发过程中，业务演进的问题。</p>
<p>因为当业务改变了，那么领域就改变了，对应的代码也就跟着变就好了。</p>
<p>所以DDD和微服务不一样，不是一种具体的架构，只是一种指导方法。</p>
<p>它可以划分出清晰的<code>业务边界</code>也就是微服务的边界，从而让微服务的拆分更加符合业务。而不是乱拆分。</p>
<p>他也有一些步骤</p>
<ul>
<li>战略设计：战略设计从业务的视角上看待问题，建立领域边界、划分领域、子领域等等。</li>
<li>战术设计：战术设计从技术的视角上看待问题，将领域转化成微服务，将业务实体转化成代码实体等等。</li>
<li>事件风暴：通过事件风暴，大家一起来想业务，并将业务转化成领域、子领域、领域事件、实体等等。</li>
</ul>
<p>首先，需要进行<code>事件风暴</code>，梳理出一些和业务逻辑有关的<code>词汇</code>。</p>
<p>以电商举例，<code>用户</code>，<code>购买者</code>，<code>订单</code>，<code>商品</code>，<code>库存</code>，<code>收货地址</code>，<code>商家</code>，<code>价格</code>，<code>购买行为</code>，<code>下单</code>，<code>支付</code>，<code>取消订单</code>，<code>退款</code>，<code>发货</code>等等。</p>
<p>接下来进行一些<code>识别</code>。</p>
<p>识别什么呢？识别上面的概念，也就是哪些是<code>实体</code>、<code>值对象</code>和<code>领域事件</code>。</p>
<p>说的再简单一些，<code>名词</code>就是实体或者值对象。如果只有属性值的就是值对象。<code>动词</code>就是领域事件。</p>
<p>比如上面的这些里面，哪些是领域事件呢？</p>
<ul>
<li>下单</li>
<li>支付</li>
<li>取消订单</li>
<li>购买</li>
<li>退款</li>
<li>发货</li>
</ul>
<p>哪些是实体呢？</p>
<ul>
<li>用户</li>
<li>购买者</li>
<li>商家</li>
<li>商品</li>
</ul>
<p>哪些是值对象呢？</p>
<ul>
<li>价格：价格仅仅是一个属性，价格变化的时候就是整个值对象进行变化。</li>
<li>收货地址：收货地址也仅仅是一个属性或者一些属性，没有方法。</li>
<li>库存：库存也同样。</li>
</ul>
<p>有些人看到这里就会有疑问了？用户和购买者不是一个东西吗？</p>
<p>这里就需要提到另外一个概念了。<code>限界上下文</code>。</p>
<p>这个在上面简单介绍过。这里再说一下。</p>
<p>这个概念有两个意思</p>
<ul>
<li>边界：用来划分领域的边界，也就是微服务的边界。</li>
<li>上下文：在划分的边界之内，有着上下文。同样的一个东西，在不同领域里面，也就是在不同的上下文环境中，意思是不一样的。</li>
</ul>
<p>比如<code>笨蛋</code>这个词吧。</p>
<p>在小情侣你侬我侬之间说，<code>哎呀，你个笨蛋</code>。就是打情骂俏的意思。当然不是说你真的笨了。</p>
<p>那换一个环境呢，你在学习的时候，老师跟你说：<code>你真是个笨蛋！</code>。这里就是真的在说你笨了。</p>
<p>所以呢，不同的环境，不同的上下文里面，一个词语的意思是不一样的。</p>
<p>这里也是，都是用户，但是在浏览商品的时候他只是<code>用户</code>。但是在购买的时候，他就是<code>购买者</code>了。</p>
<p>这样，他就在两个领域里面存在了。在<code>用户领域</code>里面是用户实体，在<code>交易领域</code>里面是购买者实体。</p>
<p>接下来可以进行<code>聚合</code>操作，也就是将意思相近、内容相近的放到一起，放到一个聚合里面。再根据聚合的内容划分出领域、子领域等。</p>
<p>比如</p>
<ul>
<li>用户聚合：里面就包含了用户实体。</li>
<li>商品聚合：里面包含了商品实体、价格值对象、库存值对象。</li>
<li>订单聚合：里面包含了订单实体、购买者实体、收货地址值对象。</li>
</ul>
<p>。。。</p>
<p>每个聚合里面还要有一个<code>聚合根</code>作为聚合的入口。</p>
<p>接下来将聚合划分到领域中就可以了。</p>
<p>比如</p>
<ul>
<li>用户领域：包含了用户聚合</li>
<li>交易领域：包含了商品聚合和订单聚合。也可以划分成两个子领域，一个子领域包含一个聚合。</li>
</ul>
<p>。。。</p>
<p>还有一些领域事件。作为通信。</p>
<p>比如</p>
<ul>
<li>下单领域事件：用户聚合发起事件 -》 订单聚合接受事件。完成下单操作。</li>
</ul>
<h5 id="DDD的分层架构"><a href="#DDD的分层架构" class="headerlink" title="DDD的分层架构"></a>DDD的分层架构</h5><p>DDD的分层和传统的MVC分层不太一样。</p>
<p>传统的后端服务一般是这样的层次</p>
<ul>
<li>controller：入口层</li>
<li>service：业务逻辑层</li>
<li>dao：数据层</li>
</ul>
<p>DDD则是分成了下面四层</p>
<ul>
<li>用户接口层：也就是传统的入口层</li>
<li>应用层：应用层调用领域层的聚合来完成操作，进行服务编排。可以调用多个聚合来共同完成操作。但是应用层和传统的业务逻辑层不同，它不负责完成业务逻辑，仅仅是服务编排，具体的业务逻辑由领域层实现。</li>
<li>领域层：领域层是核心，包含了聚合、实体、值对象和聚合根。每个实体都是充血模型，包含了逻辑操作。</li>
<li>基础层：基础层提供了基础服务，比如缓存、队列、数据库等等。</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>我们简单的走了一遍DDD进行领域拆分。也让大家明白了为什么大厂会采用DDD。</p>
<p>因为大厂的微服务架构很完善了，他们的微服务复杂，使用DDD来指导微服务的拆分是一种有效的方法。</p>
<p>可以让代码和业务契合，当业务改变的时候代码随之改变。</p>
<p>这里插入名片</p>
<h2 id="文末福利"><a href="#文末福利" class="headerlink" title="文末福利"></a>文末福利</h2><blockquote>
<p>关注我发送“MySQL知识图谱”领取完整的MySQL学习路线。<br>发送“电子书”即可领取价值上千的电子书资源。<br>发送“大厂内推”即可获取京东、美团等大厂内推信息，祝你获得高薪职位。<br>发送“AI”即可领取AI学习资料。<br>部分电子书如图所示。</p>
</blockquote>
<p><img src="https://thepatterraining.github.io/images/bottom1.png" alt="概念学习"></p>
<p><img src="https://thepatterraining.github.io/images/bottom2.png" alt="概念学习"></p>
<p><img src="https://thepatterraining.github.io/images/bottom3.png" alt="概念学习"></p>
<p><img src="https://thepatterraining.github.io/images/bottom4.png" alt="概念学习"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://thepatterraining.github.io/DeepSeek%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpeg">
      <meta itemprop="name" content="Thepatter">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/DeepSeek%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7.html" class="post-title-link" itemprop="url">七招教你玩转DeepSeek，我求求你别再花钱买课了！</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-02-16 10:12:47" itemprop="dateCreated datePublished" datetime="2025-02-16T10:12:47+08:00">2025-02-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-02-17 10:21:34" itemprop="dateModified" datetime="2025-02-17T10:21:34+08:00">2025-02-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
                </span>
            </span>

          
            <span id="/DeepSeek%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7.html" class="post-meta-item leancloud_visitors" data-flag-title="七招教你玩转DeepSeek，我求求你别再花钱买课了！" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/DeepSeek%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/DeepSeek%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>大家好，我是大头，职高毕业，现在大厂资深开发，前上市公司架构师，管理过10人团队！<br>我将持续分享成体系的知识以及我自身的转码经验、面试经验、架构技术分享、AI技术分享等！<br>愿景是带领更多人完成破局、打破信息差！我自身知道走到现在是如何艰难，因此让以后的人少走弯路！<br>无论你是统本CS专业出身、专科出身、还是我和一样职高毕业等。都可以跟着我学习，一起成长！一起涨工资挣钱！<br>关注我一起挣大钱！文末有惊喜哦！</p>
</blockquote>
<blockquote>
<p>关注我发送“MySQL知识图谱”领取完整的MySQL学习路线。<br>发送“电子书”即可领取价值上千的电子书资源。<br>发送“大厂内推”即可获取京东、美团等大厂内推信息，祝你获得高薪职位。<br>发送“AI”即可领取AI学习资料。</p>
</blockquote>
<h1 id="七招教你玩转DeepSeek，我求求你别再花钱买课了！"><a href="#七招教你玩转DeepSeek，我求求你别再花钱买课了！" class="headerlink" title="七招教你玩转DeepSeek，我求求你别再花钱买课了！"></a>七招教你玩转DeepSeek，我求求你别再花钱买课了！</h1><p>最近这段时间DeepSeek越来越火，很多人都开始使用了，以至于DeepSeek频繁出现“服务器繁忙，请稍后再试”问题。</p>
<p>其实，随着前几年<code>OpenAI</code>发布了<code>ChatGPT</code>开始，这种<code>生成式AI大模型</code>就开始爆火。</p>
<p>到今年<code>DeepSeek</code>爆火，又一次点燃了大家的热情。</p>
<p>但是。。。。。。</p>
<p>很多人还是<code>不知道</code>该怎么和AI聊天，毕竟AI不是真人，大家都知道AI能力强大，可是如何用好它呢？</p>
<p>很多人在使用过程中都发现AI给的<code>回答不理想</code>，和自己想要的相差甚远。</p>
<p>这是AI的问题？还是使用者的问题呢？</p>
<p>这就是<code>信息差</code>，有些人已经用AI<code>年入百万</code>了，有些人还觉得<code>AI能力太弱</code>，回答的问题<code>乱七八糟</code>。</p>
<p>网上还有很多人靠着信息差<code>挣钱</code>割韭菜。</p>
<p>很多<code>付费教程</code>多如牛毛，还是有很多人乐此不疲。</p>
<p>今天，大头<code>免费</code>教你们如何<code>使用AI</code>，解放他们真正的能力，不要再去<code>花钱</code>买课了，不要再当<code>韭菜</code>了，那些钱你买点好吃的好玩的给自己它不香吗？</p>
<h2 id="为什么大家用不好AI？"><a href="#为什么大家用不好AI？" class="headerlink" title="为什么大家用不好AI？"></a>为什么大家用不好AI？</h2><p>大家在使用过程中，可以问问自己，为什么同样都是<code>AI</code>，别人用的AI跟<code>爱迪生</code>似的，自己用起来就跟<code>人工智障</code>一样？</p>
<p>有的人可能知道一点，就是<code>Prompt</code>，中文就是AI提示词。也就是你需要问的准确，AI才能给你想要的回答。</p>
<p>来看一个例子：</p>
<p>背景：你要和对象出去旅游，出发地是北京，目的地是成都。两个人打算玩五一5天。<br>需求：你想要AI给你出一个旅游规划。</p>
<p>大家通常会这么询问AI。</p>
<blockquote>
<p>给我写一个去成都的旅游攻略</p>
</blockquote>
<p>来看一下AI的回答。</p>
<p><img src="https://thepatterraining.github.io/images/AI/deepseek3-2.png" alt="deepseek3-2"></p>
<p>乍一看，这个推荐也像这么回事，但是你仔细看一看，会发现AI回答的很<code>宽泛</code>。</p>
<ul>
<li>给出了时间建议</li>
<li>给出了景点建议</li>
<li>给出了交通住宿建议</li>
<li>给出了3天的旅游规划</li>
</ul>
<p>可是再看我们的需求，明显不符合我们的需求啊。</p>
<p><code>问题</code>出在哪呢？出在我们给AI的问题上面！</p>
<p>我们问的<code>问题不明确</code>，至少在AI的理解里面，我们的问题不明确！</p>
<h2 id="第一招：问题要具体"><a href="#第一招：问题要具体" class="headerlink" title="第一招：问题要具体"></a>第一招：问题要具体</h2><blockquote>
<p>第一招：问题要具体</p>
</blockquote>
<p>你不能只告诉他给一个成都的旅游攻略，这就像你问别人一样，他也只能给你一个宽泛的回答，一些简单的推荐而已。</p>
<p>✅ 正确示范：我要和我对象出去旅游，从北京到成都，给我规划一个五一的旅游攻略。</p>
<p>这里交代清楚了时间、地点、人物要素。</p>
<p><img src="https://thepatterraining.github.io/images/AI/deepseek3-1.png" alt="deepseek3-1"></p>
<p>看看AI的回答。跟上面比明显更好了！</p>
<p>想要更细致的回答，还有其他的招式。可以继续优化。</p>
<h2 id="第二招：设定角色，让AI知道自己是谁"><a href="#第二招：设定角色，让AI知道自己是谁" class="headerlink" title="第二招：设定角色，让AI知道自己是谁"></a>第二招：设定角色，让AI知道自己是谁</h2><blockquote>
<p>第二招：设定角色，让AI知道自己是谁</p>
</blockquote>
<p>解释一下，你可以给AI设定一个<code>角色</code>，让他<code>代入</code>进去，那么他就会更<code>擅长</code>做某事。</p>
<p>大家都知道，JAVA开发更擅长JAVA、川菜大厨更擅长做川菜、成都本地导游更擅长做成都的旅游规划。</p>
<p>数学专家更擅长数学题、物理专家更擅长物理题。当你<code>赋予</code>AI一个角色以后，AI就会摇身一变，变成数学专家、物理专家、川菜大厨、成都本地导游等。</p>
<p>这样的话，他就能更好的回答你的问题了！</p>
<p>❌ 错误示范：帮我优化这个代码…</p>
<p>✅ 正确示范：假设你是一个有十多年经验的JAVA专家，你会如何优化这个代码…</p>
<p>❌ 错误示范：给我写一个去成都的旅游攻略</p>
<p>✅ 正确示范：假设你是一个有二十多年导游经验的成都本地资深导游。我要和我对象出去旅游，从北京到成都，请给我规划一个五一的旅游攻略。</p>
<p>AI给出的回答如下，可以看到，给出来的回答更加好了。不仅有具体的时间安排，还有对应的推荐菜以及推荐玩法。还有本地人的放坑指南等等。</p>
<p><img src="https://thepatterraining.github.io/images/AI/deepseek3-3.png" alt="deepseek3-3"></p>
<p>这份攻略明显更好了！</p>
<h2 id="第三招：细化问题，逐步求精"><a href="#第三招：细化问题，逐步求精" class="headerlink" title="第三招：细化问题，逐步求精"></a>第三招：细化问题，逐步求精</h2><p>有的时候，可能我们希望得到更加细化的东西，比如说上面的旅游攻略，我们还想知道住宿安排，交通推荐。</p>
<p>再比如交通上我们希望比较火车、高铁、飞机的价格和时间等等。</p>
<p>为什么不<code>一次性</code>给AI呢？</p>
<p>因为AI<code>无法理解</code>太过<code>复杂</code>的问题，他毕竟不是人类。但是你一步步跟他说，他就能明白了。每次简单一些。</p>
<p>这就像大象装进冰箱有几步</p>
<ol>
<li>打开冰箱</li>
<li>放大象</li>
<li>关冰箱</li>
</ol>
<p>我们也可以继续追问</p>
<ul>
<li>请给出详细的交通方案，首先给出火车的</li>
<li>接下来给出高铁的</li>
<li>接下来给出飞机的</li>
</ul>
<p>❌ 错误示范：帮我规划一个五一的旅游攻略，从北京到成都，要求给出详细的交通方案、住宿方案、游玩方案。包括时间、价格、性价比等细节。</p>
<p>✅ 正确示范：帮我规划一个五一的旅游攻略，从北京到成都，第一步，给出交通方案的时间、价格信息。第二步，给出住宿的推荐、价格、和景点的距离。第三步，给出景点的游玩信息、高峰期、路线、门票。</p>
<p><img src="https://thepatterraining.github.io/images/AI/deepseek3-4.png" alt="deepseek3-3"></p>
<h2 id="第四招：结合上下文，深入交流"><a href="#第四招：结合上下文，深入交流" class="headerlink" title="第四招：结合上下文，深入交流"></a>第四招：结合上下文，深入交流</h2><p>上面的结果AI确实按照我们的要求来了，但是结果并不是太好。</p>
<p>我们<code>一次性</code>给出三步，对于AI来说，还是有点理解<code>困难</code>。</p>
<p>所以我们可以让AI结合上下文。来一步步问。</p>
<p>什么是<code>上下文</code>？</p>
<p>就是在一次<code>AI对话</code>里面的<code>所有内容</code>。当我们点击<code>开启新对话</code>。就开启了一个新的上下文。这个对话里面的所有信息，都是上下文，AI可以根据上下文来回答我们的问题。</p>
<p>✅ 正确示范：假设你是一个有二十多年导游经验的成都本地资深导游。我要和我对象出去旅游，从北京到成都，请给我规划一个五一的旅游攻略。</p>
<p>接下来，我们再次输入：</p>
<ul>
<li>请帮我细化从北京到成都的交通方案，给出交通方案的时间、价格信息等</li>
<li>请帮我细化成都的住宿推荐，给出住宿的推荐、价格、和景点的距离等</li>
<li>根据这些信息帮我细化景点的游玩信息、高峰期、路线、门票等</li>
</ul>
<p><img src="https://thepatterraining.github.io/images/AI/deepseek3-5.png" alt="deepseek3-3"></p>
<p>可以看到同样的问题，AI的回答明显别上次的更加好了。还给出了一些方案对比。很适合我们选择。</p>
<h2 id="第五招：提供参考方案"><a href="#第五招：提供参考方案" class="headerlink" title="第五招：提供参考方案"></a>第五招：提供参考方案</h2><p>就像写论文的时候，大家都需要<code>参考文献</code>一样，如果你想让AI给你输出一些很好的内容，也可以给AI一些参考文献。</p>
<p>大家都知道，AI有一个<code>联网搜索</code>功能。这其实就是AI会去网上搜索一些文章做为<code>参考文献</code>。</p>
<p>我们也可以自主给他一些参考文献。</p>
<p>❌ 错误示范：帮我写一遍古诗词</p>
<p>✅ 正确示范：假如你是一个诗人，请帮我写一遍类似《将进酒》的古诗词。</p>
<h2 id="第六招：多轮对话引导"><a href="#第六招：多轮对话引导" class="headerlink" title="第六招：多轮对话引导"></a>第六招：多轮对话引导</h2><p>之前已经经过<code>上下文</code>了。那么基于上下文，我们就可以进行多轮提问。</p>
<p>有很多人使用AI的时候，问了一次得不到正确答案，就不再继续提问了。</p>
<p>❌ 错误示范：帮我写一个牙齿的广告词。</p>
<p>✅ 正确示范：帮我写一个牙齿的广告词。</p>
<p>接下来的回答不满意，我们可以继续让AI修改回答。</p>
<p>✅ 第二轮问题：要求体现出我们的技术，口腔技术一流。</p>
<p>接下来的回答可能还是不满意，我们继续引导AI修改。</p>
<p>✅ 第二轮问题：修改广告词，控制在10个字以内。</p>
<p>就这样一轮一轮的引导。通过不断的引导修正。最终可以得到我们想要的答案。</p>
<h2 id="第七招：多个方案。不同角度对比选择"><a href="#第七招：多个方案。不同角度对比选择" class="headerlink" title="第七招：多个方案。不同角度对比选择"></a>第七招：多个方案。不同角度对比选择</h2><p>除了上面的方法以外，还可以让AI从不同的角度给出多个方案，我们自己从中选出一个适合的方案。</p>
<p>当然了，如果多个方案都不满意，我们还可以通过多轮对话的方式，引导AI再次给出多个方案。</p>
<p>❌ 错误示范：帮我写一个牙齿的广告词。</p>
<p>✅ 正确示范：从不同的角度，给出5个牙齿的广告词。</p>
<p>如果对5个不满意，可以继续多轮对话。</p>
<p>…….</p>
<h2 id="一些万能模板推荐"><a href="#一些万能模板推荐" class="headerlink" title="一些万能模板推荐"></a>一些万能模板推荐</h2><p>👉 设定角色：如资深导游、JAVA专家等。<br>👉 设定字数要求：如广告词给出10个字以内的、爆款标题给出20个字以内的。论文开题报告1000字以内。<br>👉 设定不同角度<br>👉 设定不想要的回答<br>👉 给出参考文献<br>👉 给定格式、语气、输入输出等。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过这些技巧，可以让AI更好的为我们服务，你会发现AI变成了<code>生活中的小助手</code>，而不再是<code>人工智障</code>。</p>
<blockquote>
<p>工具永远都只是工具。如何用好工具才是我们应该做的。</p>
</blockquote>
<p>没有完美的工具，只有完美使用工具的人类。</p>
<p>通过AI提效，解放双手。有更多的时间学习、玩耍、祝大家都升职加薪！！！</p>
<h2 id="文末福利"><a href="#文末福利" class="headerlink" title="文末福利"></a>文末福利</h2><blockquote>
<p>关注我发送“MySQL知识图谱”领取完整的MySQL学习路线。<br>发送“电子书”即可领取价值上千的电子书资源。<br>发送“大厂内推”即可获取京东、美团等大厂内推信息，祝你获得高薪职位。<br>发送“AI”即可领取AI学习资料。<br>部分电子书如图所示。</p>
</blockquote>
<p><img src="https://thepatterraining.github.io/images/bottom1.png" alt="概念学习"></p>
<p><img src="https://thepatterraining.github.io/images/bottom2.png" alt="概念学习"></p>
<p><img src="https://thepatterraining.github.io/images/bottom3.png" alt="概念学习"></p>
<p><img src="https://thepatterraining.github.io/images/bottom4.png" alt="概念学习"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://thepatterraining.github.io/Java%E4%B8%AD%E7%9A%84try-with-resources%20%E4%BC%98%E9%9B%85%E7%9A%84%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E6%96%B9%E5%BC%8F.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpeg">
      <meta itemprop="name" content="Thepatter">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Java%E4%B8%AD%E7%9A%84try-with-resources%20%E4%BC%98%E9%9B%85%E7%9A%84%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E6%96%B9%E5%BC%8F.html" class="post-title-link" itemprop="url">还在手动管理资源？还在经常陷入OOM？一招教你快速解决</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-02-12 10:12:47 / 修改时间：11:30:55" itemprop="dateCreated datePublished" datetime="2025-02-12T10:12:47+08:00">2025-02-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          
            <span id="/Java%E4%B8%AD%E7%9A%84try-with-resources%20%E4%BC%98%E9%9B%85%E7%9A%84%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E6%96%B9%E5%BC%8F.html" class="post-meta-item leancloud_visitors" data-flag-title="还在手动管理资源？还在经常陷入OOM？一招教你快速解决" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/Java%E4%B8%AD%E7%9A%84try-with-resources%20%E4%BC%98%E9%9B%85%E7%9A%84%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E6%96%B9%E5%BC%8F.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Java%E4%B8%AD%E7%9A%84try-with-resources%20%E4%BC%98%E9%9B%85%E7%9A%84%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E6%96%B9%E5%BC%8F.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>大家好，我是大头，职高毕业，现在大厂资深开发，前上市公司架构师，管理过10人团队！<br>我将持续分享成体系的知识以及我自身的转码经验、面试经验、架构技术分享、AI技术分享等！<br>愿景是带领更多人完成破局、打破信息差！我自身知道走到现在是如何艰难，因此让以后的人少走弯路！<br>无论你是统本CS专业出身、专科出身、还是我和一样职高毕业等。都可以跟着我学习，一起成长！一起涨工资挣钱！<br>关注我一起挣大钱！文末有惊喜哦！</p>
</blockquote>
<h1 id="还在手动管理资源？还在经常陷入OOM？一招教你快速解决"><a href="#还在手动管理资源？还在经常陷入OOM？一招教你快速解决" class="headerlink" title="还在手动管理资源？还在经常陷入OOM？一招教你快速解决"></a>还在手动管理资源？还在经常陷入OOM？一招教你快速解决</h1><p>你是否还在为了手动管理资源而发愁？打开文件以后还要记得关闭文件，这些资源全部要手动管理，一旦忘了就有可能OOM！</p>
<p>一招教你使用<code>try-with-resources</code>来自动管理资源，不需要再手动关闭资源了，再也不怕忘记关闭资源了。</p>
<h2 id="try-with-resources"><a href="#try-with-resources" class="headerlink" title="try-with-resources"></a>try-with-resources</h2><p>在Java开发中，资源管理一直是一个重要的问题。</p>
<p>无论是文件操作、数据库连接还是网络通信，都需要确保资源在使用后能够正确关闭，以避免资源泄漏和潜在的错误。</p>
<p><code>try-with-resources</code>语句的引入，为Java开发者提供了一种简洁而优雅的资源管理方式，大大简化了代码的复杂性，同时也提高了代码的可读性和安全性。</p>
<h2 id="传统资源管理的痛点"><a href="#传统资源管理的痛点" class="headerlink" title="传统资源管理的痛点"></a>传统资源管理的痛点</h2><p>首先，我们来看看<code>try-with-resources</code>解决了什么问题。</p>
<ol>
<li>冗长的代码：传统资源管理的方式，通常需要在<code>finally</code>块里面手动关闭资源。但是这样既麻烦，又导致代码很多，而这些代码增加以后，比如多个资源关闭，嵌套关闭等，会导致可读性变差，代码难以管理。</li>
<li>容易出错：当代码复杂、可读性差、难以管理以后，就很容易出错了。还有如果在关闭资源的时候抛出异常，那么资源可能就无法关闭了，从而导致资源泄漏问题。</li>
<li>异常处理复杂：通常在<code>finally</code>中关闭资源的时候，还要在套一层<code>try...catch</code>，导致异常处理变多、复杂等问题</li>
</ol>
<h3 id="冗长的代码"><a href="#冗长的代码" class="headerlink" title="冗长的代码"></a>冗长的代码</h3><p>在<code>try-with-resources</code>出现之前，Java开发者通常使用<code>try-finally</code>语句来确保资源被正确关闭。例如，当操作文件时，代码通常如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FileInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    inputStream = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;example.txt&quot;</span>);</span><br><span class="line">    <span class="comment">// 读取文件内容</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (inputStream != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            inputStream.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种写法虽然能够确保资源被关闭，但代码显得冗长且复杂。特别是当需要管理多个资源时，finally块中的关闭逻辑会变得更加繁琐。</p>
<h3 id="容易出错"><a href="#容易出错" class="headerlink" title="容易出错"></a>容易出错</h3><p>手动管理资源时，开发者需要在<code>finally</code>块中显式调用资源的<code>close()</code>方法。如果忘记关闭资源，或者在关闭资源时抛出异常而未正确处理，就可能导致资源泄漏或其他问题。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FileInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;example.txt&quot;</span>);</span><br><span class="line"><span class="comment">// 使用inputStream读取文件内容</span></span><br><span class="line">inputStream.close(); <span class="comment">// 如果这里抛出异常，资源可能无法正确关闭</span></span><br></pre></td></tr></table></figure>

<h3 id="异常处理复杂"><a href="#异常处理复杂" class="headerlink" title="异常处理复杂"></a>异常处理复杂</h3><p>在<code>finally</code>块中关闭资源时，如果资源的<code>close()</code>方法抛出异常，而try块中也抛出了异常，处理这些异常会变得非常复杂。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FileInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    inputStream = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;example.txt&quot;</span>);</span><br><span class="line">    <span class="comment">// 读取文件内容，可能抛出异常</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (inputStream != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            inputStream.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果try块和finally块都抛出异常，处理这些异常会变得非常复杂，容易导致错误。</p>
<h2 id="什么是try-with-resources"><a href="#什么是try-with-resources" class="headerlink" title="什么是try-with-resources?"></a>什么是try-with-resources?</h2><p><code>try-with-resources</code>是<code>Java 7</code>引入的一种语法结构，用于<code>自动管理资源</code>。</p>
<p>它允许在try语句中声明一个或多个资源，这些资源必须实现了<code>AutoCloseable接口</code>或其子接口Closeable。</p>
<p>当try语句块执行完毕后，无论是否发生异常，<code>try-with-resources</code>都会自动调用资源的<code>close()</code>方法来关闭资源。</p>
<h3 id="核心特性"><a href="#核心特性" class="headerlink" title="核心特性"></a>核心特性</h3><ul>
<li>自动关闭资源：try-with-resources会自动调用资源的close()方法，确保资源被正确关闭。</li>
<li>简化代码：无需手动在finally块中关闭资源，减少了代码冗余。</li>
<li>支持多个资源：可以同时管理多个资源，每个资源之间用分号隔开。</li>
<li>异常处理：如果资源的close()方法抛出异常，而try语句块中也抛出了异常，try语句块中抛出的异常会被传播，而资源关闭时抛出的异常会被抑制（suppressed）。</li>
</ul>
<h2 id="为什么使用try-with-resources"><a href="#为什么使用try-with-resources" class="headerlink" title="为什么使用try-with-resources"></a>为什么使用try-with-resources</h2><p>上面已经介绍了传统资源管理的痛点问题，所以使用<code>try-with-resources</code>主要就是解决这些痛点。</p>
<p>当然了，除了能解决这些问题以外，还有一些其他的好处。</p>
<p>毕竟，Java语言使用了这么长时间，能使它自身提供的一些特性，都是很有用的。</p>
<ul>
<li>解决传统资源管理的痛点：解决上述的痛点问题。</li>
<li>提高代码的可读性和安全性：try-with-resources通过自动管理资源，简化了代码结构，提高了代码的可读性和安全性。它确保了资源在使用后能够正确关闭，减少了因资源泄漏导致的潜在问题。</li>
<li>支持自定义资源类：除了Java标准库中提供的资源类（如FileInputStream、FileOutputStream等），我们还可以自定义实现AutoCloseable接口的资源类，以便在try-with-resources中使用。</li>
</ul>
<h2 id="何时使用try-with-resources"><a href="#何时使用try-with-resources" class="headerlink" title="何时使用try-with-resources"></a>何时使用try-with-resources</h2><h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><p>上面已经介绍了很多了，接下来看一下，有哪些使用场景。</p>
<ul>
<li>文件操作：读取或写入文件时，使用FileInputStream、FileOutputStream等类。</li>
<li>数据库操作：使用Connection、Statement、ResultSet等资源时。</li>
<li>网络通信：使用Socket、ServerSocket等资源时。</li>
<li>自定义资源：任何实现了AutoCloseable接口的资源类。</li>
</ul>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><p>没有任何方法是一种<code>银弹</code>。技术方案没有黑魔法！所以在使用的时候也需要注意一些事项。</p>
<ul>
<li>确保资源实现AutoCloseable接口：只有实现了AutoCloseable接口或Closeable接口的资源类才能在try-with-resources中使用。</li>
<li>异常处理：虽然try-with-resources会自动关闭资源，但仍然需要处理可能抛出的异常。</li>
<li>性能考虑：虽然try-with-resources简化了代码，但调用close()方法可能会增加一定的开销。在资源较多时，需要注意性能影响。</li>
</ul>
<h2 id="如何使用try-with-resources"><a href="#如何使用try-with-resources" class="headerlink" title="如何使用try-with-resources"></a>如何使用try-with-resources</h2><p>经过上面的介绍，相信你已经对<code>try-with-resources</code>很了解了，接下来看一下到底该如何实战吧！</p>
<h3 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h3><p><code>try-with-resources</code>语句允许在<code>try</code>块中声明一个或多个资源，这些资源必须实现了<code>AutoCloseable</code>接口或其子接口<code>Closeable</code>。当<code>try</code>块执行完毕后，无论是否发生异常，<code>try-with-resources</code>都会自动调用资源的<code>close()</code>方法来关闭资源。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (资源声明) &#123;</span><br><span class="line">    <span class="comment">// 使用资源</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (异常类型 异常变量) &#123;</span><br><span class="line">    <span class="comment">// 处理异常</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h3><p>以下是一个使用try-with-resources读取文件内容的示例:</p>
<p>可以看到，我们把资源的获取放在了try后面的小括号里面，而不是以前一样放在了大括号里面。</p>
<p>这样的话，就不需要在<code>finally</code>里面关闭资源了，因为会自动关闭。</p>
<p>这也是因为<code>FileInputStream</code>实现了<code>Closeable</code>接口，因此可以作为资源在try-with-resources中声明。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (<span class="type">FileInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;example.txt&quot;</span>)) &#123;</span><br><span class="line">    <span class="comment">// 使用inputStream读取文件内容</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="管理多个资源"><a href="#管理多个资源" class="headerlink" title="管理多个资源"></a>管理多个资源</h3><p>try-with-resources不仅可以管理单个资源，还可以同时管理多个资源。例如，当需要同时读取和写入文件时，可以这样写：</p>
<p>在这个例子中，inputStream和outputStream都被声明为资源，它们的close()方法都会在try语句块执行完毕后自动调用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (<span class="type">FileInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;input.txt&quot;</span>);</span><br><span class="line">     <span class="type">FileOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;output.txt&quot;</span>)) &#123;</span><br><span class="line">    <span class="comment">// 使用inputStream读取文件内容并写入outputStream</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="自定义资源类"><a href="#自定义资源类" class="headerlink" title="自定义资源类"></a>自定义资源类</h3><p>除了Java标准库中提供的资源类（如FileInputStream、FileOutputStream等），我们还可以自定义实现AutoCloseable接口的资源类，以便在try-with-resources中使用。例如：</p>
<p>只要我们自己的资源类，实现了<code>AutoCloseable</code>接口，就可以了。很简单吧！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyResource</span> <span class="keyword">implements</span> <span class="title class_">AutoCloseable</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;资源已关闭&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来就可以和上面一样的使用方法来使用我们自定义的资源类了！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (<span class="type">MyResource</span> <span class="variable">myResource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyResource</span>()) &#123;</span><br><span class="line">    <span class="comment">// 使用myResource</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><code>try-with-resources</code>是Java 7引入的一种非常有用的语法结构，</p>
<p>它能够自动管理资源，简化了资源关闭的代码，提高了代码的可读性和安全性。</p>
<p>通过实现AutoCloseable接口或Closeable接口，我们可以自定义资源类，并在try-with-resources中使用它们。</p>
<p>在实际开发中，合理使用try-with-resources可以有效避免资源泄漏，提高代码质量。</p>
<h2 id="文末福利"><a href="#文末福利" class="headerlink" title="文末福利"></a>文末福利</h2><blockquote>
<p>关注我发送“MySQL知识图谱”领取完整的MySQL学习路线。<br>发送“电子书”即可领取价值上千的电子书资源。<br>发送“大厂内推”即可获取京东、美团等大厂内推信息，祝你获得高薪职位。<br>部分电子书如图所示。</p>
</blockquote>
<p><img src="https://thepatterraining.github.io/images/bottom1.png" alt="概念学习"></p>
<p><img src="https://thepatterraining.github.io/images/bottom2.png" alt="概念学习"></p>
<p><img src="https://thepatterraining.github.io/images/bottom3.png" alt="概念学习"></p>
<p><img src="https://thepatterraining.github.io/images/bottom4.png" alt="概念学习"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://thepatterraining.github.io/DeepSeek%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpeg">
      <meta itemprop="name" content="Thepatter">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/DeepSeek%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2.html" class="post-title-link" itemprop="url">DeepSeek R1本地部署,解决服务器繁忙，请稍后再试问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-02-10 10:12:47 / 修改时间：14:48:41" itemprop="dateCreated datePublished" datetime="2025-02-10T10:12:47+08:00">2025-02-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
                </span>
            </span>

          
            <span id="/DeepSeek%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2.html" class="post-meta-item leancloud_visitors" data-flag-title="DeepSeek R1本地部署,解决服务器繁忙，请稍后再试问题" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/DeepSeek%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/DeepSeek%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="DeepSeek-R1本地部署"><a href="#DeepSeek-R1本地部署" class="headerlink" title="DeepSeek R1本地部署"></a>DeepSeek R1本地部署</h1><h2 id="DeepSeek大火-但天下苦服务器繁忙，请稍后再试久矣"><a href="#DeepSeek大火-但天下苦服务器繁忙，请稍后再试久矣" class="headerlink" title="DeepSeek大火,但天下苦服务器繁忙，请稍后再试久矣."></a>DeepSeek大火,但天下苦服务器繁忙，请稍后再试久矣.</h2><p>近期,DeepSeek大模型大火,一举超越ChatGPT登顶下载榜首.</p>
<p>DeepSeek从很少人知道一下子变成了人尽皆知的大厂,招聘薪资更是开出了年薪百万的价格,应届生都可以去.可谓是梦中情厂.</p>
<p>但是,就连DeepSeek自己可能都没想到自己这么火.因此招架不住大家的热情,频繁的出现<code>服务器繁忙，请稍后再试</code>.</p>
<p>使用体验实在糟糕.</p>
<p>好在,DeepSeek开源了自己的大模型,我们可以将DeepSeek部署到本地进行使用,这样的话就可以不再担心服务器繁忙了.可以尽情的蹂躏DeepSeek了!!!</p>
<p>关于DeepSeek的技术有兴趣的可以看看他们的论文.<br><a target="_blank" rel="noopener" href="https://github.com/deepseek-ai/DeepSeek-R1/blob/main/DeepSeek_R1.pdf">DeepSeekR1论文</a></p>
<ul>
<li>DeepSeek-R1 遵循 MIT License，允许用户通过蒸馏技术借助 R1 训练其他模型。</li>
<li>DeepSeek-R1 上线 API，对用户开放思维链输出，通过设置 model&#x3D;’deepseek-reasoner’ 即可调用。</li>
<li>DeepSeek 官网与 App 即日起同步更新上线。</li>
</ul>
<p>DeepSeek-R1 在后训练阶段大规模使用了强化学习技术，在仅有极少标注数据的情况下，极大提升了模型推理能力。在数学、代码、自然语言推理等任务上，性能比肩 OpenAI o1 正式版。</p>
<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><ol>
<li><p><strong>硬件要求</strong></p>
<ul>
<li>需要至少一个 CPU 核心（推荐使用多核处理器）。</li>
<li>内存建议至少 4GB，具体内存可以根据实际需求调整。</li>
<li>磁盘空间建议至少 20GB 可用空间。</li>
</ul>
</li>
<li><p><strong>操作系统</strong></p>
<ul>
<li>Windows、Linux 或 macOS 均可支持。</li>
</ul>
</li>
</ol>
<h2 id="蒸馏模型"><a href="#蒸馏模型" class="headerlink" title="蒸馏模型"></a>蒸馏模型</h2><p>DeepSeek本地部署的基本是蒸馏模型,简单理解为阉割版.</p>
<p>为什么?因为本地无法支持真正大模型的算力.</p>
<p>蒸馏模型虽然无法和完整版一样,但是胜在我们可以本地部署,自己玩.还避免了服务器繁忙的苦恼.毕竟,东西再好,你用不了也是白搭啊.</p>
<p><code>DeepSeek</code> 在开源 <code>DeepSeek-R1-Zero</code> 和 <code>DeepSeek-R1</code> 两个 660B 模型的同时，通过 <code>DeepSeek-R1</code> 的输出，蒸馏了 <code>6个小模型</code>开源给社区，其中 32B 和 70B 模型在多项能力上实现了对标 <code>OpenAI o1-mini</code> 的效果。</p>
<p><img src="https://thepatterraining.github.io/images/ai/deepseek2-1.png" alt="deepseek2-1"></p>
<p>满血版DeepSeek 671B的要求:</p>
<ul>
<li>显存需求：完整版（未量化）的显存需求极高，<code>BF16</code>精度下需 <code>1342GB</code>显存，即使使用<code>FP16</code>精度也需约 <code>350GB</code>显存</li>
<li>硬件配置：需多节点分布式计算，例如8张NVIDIA A100&#x2F;H100（每卡80GB显存）并行运行，或更高端的超算集群</li>
<li>性能限制：单卡无法支持，即使最新RTX 5090（32GB显存）也无法有效运行，推理速度极低（低于每秒10个token）</li>
</ul>
<p><img src="https://thepatterraining.github.io/images/ai/deepseek2-2.jpg" alt="deepseek2-1"></p>
<p>看一下蒸馏版的要求和推荐配置.</p>
<table>
<thead>
<tr>
<th>版本名称</th>
<th>参数数量</th>
<th>显存需求 (FP16)</th>
<th>内存需求</th>
<th>推荐Mac配置</th>
<th>推荐Windows配置</th>
</tr>
</thead>
<tbody><tr>
<td>DeepSeek-R1-1.5B</td>
<td>1.5B</td>
<td>~3GB</td>
<td>8GB+</td>
<td>M1&#x2F;M2芯片，8GB统一内存[^2^]</td>
<td>GTX 1650&#x2F;RTX 2060，4GB+显存[^5^]</td>
</tr>
<tr>
<td>DeepSeek-R1-7B</td>
<td>7B</td>
<td>~14GB</td>
<td>16GB+</td>
<td>M1 Pro&#x2F;M2 Pro，16GB统一内存[^2^]</td>
<td>RTX 3060&#x2F;4070 Ti，12GB显存[^2^]</td>
</tr>
<tr>
<td>DeepSeek-R1-14B</td>
<td>14B</td>
<td>~28GB</td>
<td>32GB+</td>
<td>M1 Max&#x2F;M2 Max，32GB统一内存[^2^]</td>
<td>RTX 4090&#x2F;A100 40G，24GB+显存[^2^]</td>
</tr>
<tr>
<td>DeepSeek-R1-32B</td>
<td>32B</td>
<td>~64GB</td>
<td>64GB+</td>
<td>M1 Ultra&#x2F;M2 Ultra，64GB统一内存[^2^]</td>
<td>2x RTX 4090&#x2F;A100 80G，48GB+显存[^2^]</td>
</tr>
<tr>
<td>DeepSeek-R1-70B</td>
<td>70B</td>
<td>~140GB</td>
<td>128GB+</td>
<td>需要更高配置的Mac Pro[^6^]</td>
<td>4x RTX 4090&#x2F;A100 80G[^6^]</td>
</tr>
</tbody></table>
<p><img src="https://thepatterraining.github.io/images/ai/deepseek2-3.jpg" alt="deepseek2-1"></p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>介绍完以后,开始安装吧.</p>
<p>安装相对来说比较简单,可以使用<code>Ollama</code>这个东西.</p>
<p>直接在<a target="_blank" rel="noopener" href="https://ollama.com/">Ollama官网</a>下载就可以了.</p>
<p>在如下界面,直接点击<code>DownLoad</code>就可以了.</p>
<p><img src="https://thepatterraining.github.io/images/ai/deepseek2-4.jpg" alt="deepseek2-1"></p>
<p>接下来选择版本,Mac、Linux或者Windows.</p>
<p><img src="https://thepatterraining.github.io/images/ai/deepseek2-5.png" alt="deepseek2-1"></p>
<p>等待下载完成以后,运行<code>Ollama</code>.这个东西可以理解为大模型的运行环境.</p>
<p><img src="https://thepatterraining.github.io/images/ai/deepseek2-6.png" alt="deepseek2-1"></p>
<p>接下来点击Ollama官网左上角的<code>Models</code>可以准备大模型了.</p>
<p><img src="https://thepatterraining.github.io/images/ai/deepseek2-7.png" alt="deepseek2-1"></p>
<p>选择我们要部署的<code>DeepSeek R1</code>大模型.</p>
<p>接下里可以选择要部署的版本.版本信息上面已经介绍过了.</p>
<p><img src="https://thepatterraining.github.io/images/ai/deepseek2-8.png" alt="deepseek2-8"></p>
<p>选择以后右侧的命令会改变,直接复制右侧的命令即可.比如我选择<code>7b</code>版本,右侧的命令就是<code>ollama run deepseek-r1:7b</code>.</p>
<p><img src="https://thepatterraining.github.io/images/ai/deepseek2-9.png" alt="deepseek2-9"></p>
<p>直接在命令行中输入这个命令就可以了.<code>Windows</code>使用<code>CMD</code>或者<code>终端</code>都可以.<code>Mac</code>使用<code>终端</code>或者<code>Iterm2</code>都可以.运行以后会先开始下载大模型.</p>
<blockquote>
<p>在windows下,可以在下面的搜索里面输入CMD打开终端程序,或者按住键盘Win + R两个键,然后在里面输入CMD打开终端程序.</p>
</blockquote>
<p><img src="https://thepatterraining.github.io/images/ai/deepseek2-10.png" alt="deepseek2-9"></p>
<p>下载完成以后进入大模型的输入界面,是命令行格式的,可以直接输入.</p>
<p>比如我输入<code>你是谁</code>.回答中的<think>标签里面对应的是思考的内容.</p>
<p><img src="https://thepatterraining.github.io/images/ai/deepseek2-11.png" alt="deepseek2-9"></p>
<p>到这里其实就安装完成了,不过如果需要UI界面在浏览器中使用的话,也可以再安装一个UI界面.</p>
<p>后续如果还想运行的话依然是两个步骤</p>
<ol>
<li>打开Ollama程序</li>
<li>运行命令ollama run deepseek-r1:7b, 注意替换成你自己的命令.</li>
</ol>
<h3 id="可视化界面安装"><a href="#可视化界面安装" class="headerlink" title="可视化界面安装"></a>可视化界面安装</h3><p>有很多人可能使用不惯命令行程序来输入,因此可以安装一个可视化界面,这样就和在DeepSeek官网使用一样了.</p>
<p>接下来我们看看如何安装UI界面吧!</p>
<p>可视化界面使用<a target="_blank" rel="noopener" href="https://github.com/open-webui/open-webui">Open-Web UI</a>提供的界面程序.可以先下载Docker,使用<code>Docker</code>运行<code>Open-Web UI</code>.</p>
<h4 id="安装Docker"><a href="#安装Docker" class="headerlink" title="安装Docker"></a>安装Docker</h4><p>进入<a target="_blank" rel="noopener" href="https://www.docker.com/">Docker官网</a>,进行下载.选择要下载的版本.</p>
<p><img src="https://thepatterraining.github.io/images/ai/deepseek2-12.png" alt="deepseek2-9"></p>
<p>下载以后进行安装,安装完成以后,打开程序,使用推荐配置就可以了.</p>
<p><img src="https://thepatterraining.github.io/images/ai/deepseek2-13.png" alt="deepseek2-9"></p>
<h4 id="安装Open-Web-UI"><a href="#安装Open-Web-UI" class="headerlink" title="安装Open Web-UI"></a>安装Open Web-UI</h4><p>接下来就可以安装<code>Open Web-UI</code>了.</p>
<p>使用如下命令即可.和之前一样,在CMD或者终端程序中运行如下命令.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 3000:8080 --add-host=host.docker.internal:host-gateway -v open-webui:/app/backend/data --name open-webui --restart always ghcr.io/open-webui/open-webui:main</span><br></pre></td></tr></table></figure>

<p>接下来等待下载完成就可以了.</p>
<p><img src="https://thepatterraining.github.io/images/ai/deepseek2-14.png" alt="deepseek2-9"></p>
<p>现在打开浏览器,输入<code>http://localhost:3000/</code>即可进入本地部署的可视化界面了!</p>
<p>第一次的话需要创建管理员账号,输入名称、邮箱、密码就可以了.</p>
<p>进来以后如图所示.</p>
<p><img src="https://thepatterraining.github.io/images/ai/deepseek2-15.png" alt="deepseek2-9"></p>
<p>使用体验如下</p>
<p><img src="https://thepatterraining.github.io/images/ai/deepseek2-16.png" alt="deepseek2-9"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这样就算安装完成了,可以使用命令行或者界面,看个人喜好了!</p>
<p>通过以上步骤，您可以在本地部署 DeepSeek。请根据实际需求调整配置并确保所有依赖项已正确安装。如果在运行过程中遇到问题，请参考官方文档或联系技术支持团队。</p>
<p>希望这份指南对您有所帮助！</p>
<h2 id="文末福利"><a href="#文末福利" class="headerlink" title="文末福利"></a>文末福利</h2><blockquote>
<p>关注我发送“MySQL知识图谱”领取完整的MySQL学习路线。<br>发送“电子书”即可领取价值上千的电子书资源。<br>发送“大厂内推”即可获取京东、美团等大厂内推信息，祝你获得高薪职位。<br>部分电子书如图所示。</p>
</blockquote>
<p><img src="https://thepatterraining.github.io/images/bottom1.png" alt="概念学习"></p>
<p><img src="https://thepatterraining.github.io/images/bottom2.png" alt="概念学习"></p>
<p><img src="https://thepatterraining.github.io/images/bottom3.png" alt="概念学习"></p>
<p><img src="https://thepatterraining.github.io/images/bottom4.png" alt="概念学习"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://thepatterraining.github.io/%E4%BB%80%E4%B9%88%E6%98%AF%E7%94%A8%E6%88%B7%E7%94%BB%E5%83%8F%EF%BC%8C%E6%8A%96%E9%9F%B3%E5%A6%82%E4%BD%95%E5%81%9A%E5%88%B0%E8%AE%A9%E4%BD%A0%E7%9C%8B%E4%BD%A0%E5%96%9C%E6%AC%A2%E7%9A%84.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpeg">
      <meta itemprop="name" content="Thepatter">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/%E4%BB%80%E4%B9%88%E6%98%AF%E7%94%A8%E6%88%B7%E7%94%BB%E5%83%8F%EF%BC%8C%E6%8A%96%E9%9F%B3%E5%A6%82%E4%BD%95%E5%81%9A%E5%88%B0%E8%AE%A9%E4%BD%A0%E7%9C%8B%E4%BD%A0%E5%96%9C%E6%AC%A2%E7%9A%84.html" class="post-title-link" itemprop="url">DeepSeek R1本地部署,解决服务器繁忙，请稍后再试问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-02-10 10:12:47 / 修改时间：15:54:03" itemprop="dateCreated datePublished" datetime="2025-02-10T10:12:47+08:00">2025-02-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
                </span>
            </span>

          
            <span id="/%E4%BB%80%E4%B9%88%E6%98%AF%E7%94%A8%E6%88%B7%E7%94%BB%E5%83%8F%EF%BC%8C%E6%8A%96%E9%9F%B3%E5%A6%82%E4%BD%95%E5%81%9A%E5%88%B0%E8%AE%A9%E4%BD%A0%E7%9C%8B%E4%BD%A0%E5%96%9C%E6%AC%A2%E7%9A%84.html" class="post-meta-item leancloud_visitors" data-flag-title="DeepSeek R1本地部署,解决服务器繁忙，请稍后再试问题" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/%E4%BB%80%E4%B9%88%E6%98%AF%E7%94%A8%E6%88%B7%E7%94%BB%E5%83%8F%EF%BC%8C%E6%8A%96%E9%9F%B3%E5%A6%82%E4%BD%95%E5%81%9A%E5%88%B0%E8%AE%A9%E4%BD%A0%E7%9C%8B%E4%BD%A0%E5%96%9C%E6%AC%A2%E7%9A%84.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/%E4%BB%80%E4%B9%88%E6%98%AF%E7%94%A8%E6%88%B7%E7%94%BB%E5%83%8F%EF%BC%8C%E6%8A%96%E9%9F%B3%E5%A6%82%E4%BD%95%E5%81%9A%E5%88%B0%E8%AE%A9%E4%BD%A0%E7%9C%8B%E4%BD%A0%E5%96%9C%E6%AC%A2%E7%9A%84.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="什么是用户画像，抖音如何做到让你看你喜欢的"><a href="#什么是用户画像，抖音如何做到让你看你喜欢的" class="headerlink" title="什么是用户画像，抖音如何做到让你看你喜欢的"></a>什么是用户画像，抖音如何做到让你看你喜欢的</h1><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这样就算安装完成了,可以使用命令行或者界面,看个人喜好了!</p>
<p>通过以上步骤，您可以在本地部署 DeepSeek。请根据实际需求调整配置并确保所有依赖项已正确安装。如果在运行过程中遇到问题，请参考官方文档或联系技术支持团队。</p>
<p>希望这份指南对您有所帮助！</p>
<h2 id="文末福利"><a href="#文末福利" class="headerlink" title="文末福利"></a>文末福利</h2><blockquote>
<p>关注我发送“MySQL知识图谱”领取完整的MySQL学习路线。<br>发送“电子书”即可领取价值上千的电子书资源。<br>发送“大厂内推”即可获取京东、美团等大厂内推信息，祝你获得高薪职位。<br>部分电子书如图所示。</p>
</blockquote>
<p><img src="https://thepatterraining.github.io/images/bottom1.png" alt="概念学习"></p>
<p><img src="https://thepatterraining.github.io/images/bottom2.png" alt="概念学习"></p>
<p><img src="https://thepatterraining.github.io/images/bottom3.png" alt="概念学习"></p>
<p><img src="https://thepatterraining.github.io/images/bottom4.png" alt="概念学习"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://thepatterraining.github.io/DeepSeek%E9%AB%98%E4%BB%B7%E6%8B%9B%E8%81%98.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpeg">
      <meta itemprop="name" content="Thepatter">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/DeepSeek%E9%AB%98%E4%BB%B7%E6%8B%9B%E8%81%98.html" class="post-title-link" itemprop="url">DeepSeek百万年薪招聘：AI领域人才争夺战的“顶配”条件与薪资揭秘</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-02-08 10:12:47" itemprop="dateCreated datePublished" datetime="2025-02-08T10:12:47+08:00">2025-02-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-02-10 15:19:25" itemprop="dateModified" datetime="2025-02-10T15:19:25+08:00">2025-02-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
                </span>
            </span>

          
            <span id="/DeepSeek%E9%AB%98%E4%BB%B7%E6%8B%9B%E8%81%98.html" class="post-meta-item leancloud_visitors" data-flag-title="DeepSeek百万年薪招聘：AI领域人才争夺战的“顶配”条件与薪资揭秘" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/DeepSeek%E9%AB%98%E4%BB%B7%E6%8B%9B%E8%81%98.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/DeepSeek%E9%AB%98%E4%BB%B7%E6%8B%9B%E8%81%98.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="DeepSeek百万年薪招聘：AI领域人才争夺战的“顶配”条件与薪资揭秘"><a href="#DeepSeek百万年薪招聘：AI领域人才争夺战的“顶配”条件与薪资揭秘" class="headerlink" title="DeepSeek百万年薪招聘：AI领域人才争夺战的“顶配”条件与薪资揭秘"></a>DeepSeek百万年薪招聘：AI领域人才争夺战的“顶配”条件与薪资揭秘</h1><p>随着人工智能技术的飞速发展，中国AI初创企业DeepSeek（杭州深度求索人工智能基础技术研究有限公司）凭借其高性价比的大模型与开源创新举措，迅速成为全球科技界的焦点。为支撑业务扩张与技术突破，DeepSeek近期发布了大规模招聘计划，52个在招职位涵盖深度学习、系统研发、UI设计等领域，并开出了<code>年薪最高154万元</code>的诱人待遇，引发行业热议</p>
<p>AI人才如此值钱的当下，我们程序员该何去何从？</p>
<p>想要拿到如此高的薪资，需要什么条件？</p>
<p>DeepSeek甚至给校招实习生开出了<code>1000元</code>每天的工资，这些实习生的工资已经超过了大部分一线城市的程序员了。</p>
<p>最重要的在于一句话<code>不看经验只看能力</code>。只要你能力够好，那么Deepseek就可以给你高薪。</p>
<p>如同之前马斯克发的一句话，只要你能力够好，我们就可以给你发offer。</p>
<h2 id="公司背景与行业趋势"><a href="#公司背景与行业趋势" class="headerlink" title="公司背景与行业趋势"></a>公司背景与行业趋势</h2><p>DeepSeek成立于2023年7月，由量化投资巨头幻方量化创立，2025年1月发布的DeepSeek-R1和DeepSeek-V3大模型因“低成本、高性能”引发全球关注，用户量激增，日活跃用户（DAU）突破2000万，跻身全球AI产品榜第二。此次招聘规模超现有团队1&#x2F;3（现有员工约150人），凸显其快速扩张需求。</p>
<p>行业层面，AI人才缺口持续扩大。《2024年度人才迁徙报告》显示，大模型相关岗位占据技术岗平均月薪前十名的半数，算法工程师需求激增，预计到2030年中国AI人才缺口将达400万</p>
<h2 id="招聘特点与竞争门槛"><a href="#招聘特点与竞争门槛" class="headerlink" title="招聘特点与竞争门槛"></a>招聘特点与竞争门槛</h2><ul>
<li>学历放宽，校招优先：部分岗位（如核心系统研发工程师）对本科生开放，且校招薪酬高于社招，吸引年轻人才。</li>
<li>成果导向：深度学习研究员需以论文、竞赛成绩或开源项目证明研究能力，强调“创新品味”与对AGI的信仰。</li>
<li>抗压能力与热情：公司更青睐“年轻、反应敏捷、有冲劲”的候选人，要求具备持续学习能力和跨学科视野。</li>
</ul>
<h2 id="核心岗位与薪资结构"><a href="#核心岗位与薪资结构" class="headerlink" title="核心岗位与薪资结构"></a>核心岗位与薪资结构</h2><ol>
<li>深度学习研究员-AGI</li>
</ol>
<ul>
<li>薪资水平：月薪8万至11万元，按14薪计算，年薪最高达154万元。</li>
<li>岗位要求：<ul>
<li>精通机器学习和深度学习，需具备创新研究能力；</li>
<li>熟练掌握至少两种编程语言（如Python、C++）；</li>
<li>有国际顶会（如NeurIPS、ICML）或顶级期刊论文发表经验；<ul>
<li>在知名AI竞赛中取得优异成绩者优先。</li>
</ul>
</li>
</ul>
</li>
<li>目标人群：博士学历为主，优秀硕士或本科生亦可参与实习。</li>
</ul>
<ol start="2">
<li>核心系统研发工程师（校招）</li>
</ol>
<ul>
<li>薪资范围：月薪6万至9万元，年薪最高126万元。</li>
<li>岗位要求：围绕大模型预训练、算法优化等展开工程化实现，要求熟悉软硬件协同开发，具备高性能计算经验</li>
</ul>
<p><img src="https://thepatterraining.github.io/images/ai/deepseek1-2.png" alt="deepseek1"></p>
<ol start="3">
<li>全栈开发工程师</li>
</ol>
<ul>
<li>薪资水平：月薪4万至7万元，年薪最高98万元。</li>
<li>能力要求：扎实的编程能力，优秀的设计能力和代码品味，较强的责任心。对主流开源软件有深入了解并对此有贡献者优先。具有自我驱动和自我管理能力。</li>
</ul>
<p><img src="https://thepatterraining.github.io/images/ai/deepseek1-3.png" alt="deepseek1"></p>
<ol start="4">
<li>实习生岗位</li>
</ol>
<ul>
<li>AGI大模型实习生日薪500至1000元，按每月22天计算，月薪可达1.1万至2.2万元，要求掌握PyTorch框架，并有论文或开源项目经验。主要是顶会论文。</li>
</ul>
<p><img src="https://thepatterraining.github.io/images/ai/deepseek1-1.png" alt="deepseek1"></p>
<h2 id="我们如何努力破局？"><a href="#我们如何努力破局？" class="headerlink" title="我们如何努力破局？"></a>我们如何努力破局？</h2><p>目前有3类人急需掌握AI能力</p>
<ol>
<li>还没入行但是想入行的</li>
<li>已经是程序员但是想破局的</li>
<li>本科生、研究生、博士生这类学生。</li>
</ol>
<p>其实，看到这些招聘信息，我们可以提炼出几点信息。</p>
<ol>
<li>不看经验只看能力：所以能力尤为重要，我们需要尽快提升自己，那么如何提升自己？</li>
<li>名校毕业生：如何成为名校毕业生？</li>
<li>顶会论文：如何发表顶会论文？</li>
</ol>
<h3 id="如何提升自己"><a href="#如何提升自己" class="headerlink" title="如何提升自己"></a>如何提升自己</h3><p>提升自己的能力最重要的是持续学习能力，要持续不断的学习新的知识。利用业余时间、碎片时间等。</p>
<p>学习知识也是有技巧的，需要<code>系统性学习</code>、<code>有目的的去学习</code>、找到<code>学习方法</code>、有正确的<code>学习路径</code>。</p>
<p>在现在这个互联网发达的社会，网上的<code>学习资料</code>成百上千，如何选择？</p>
<p>大头作为工作了快10年的开发，当过<code>上市公司的架构师</code>，当过<code>大厂资深研发</code>，管理过<code>10人团队</code>。</p>
<p>大头会持续分享自身的经验以及学习方法、系统性的学习路径、教程。</p>
<p>所有的信息都由大头本身经过严格的筛选，大家不需要自己去选择，以免走歪路。如果有想学习的小伙伴可以私信大头，免费1对1交流。</p>
<p>目前大头正在输出<code>mysql数据库零基础教程</code>。后续还会输出更多的<code>系统性教程</code>。</p>
<h3 id="如何提升学历"><a href="#如何提升学历" class="headerlink" title="如何提升学历"></a>如何提升学历</h3><p>从上面的招聘也可以看出来，虽然是看能力，可其实大多数要求还是要本科的。像顶会论文这些也需要名校的学生才能发布，其他的学校教学能力有限，学生很难发布顶会论文。</p>
<p>尤其现在大环境不好，大头最开始工作的时候，完全不看学历，现在，就连外包都要求统招本科了。</p>
<p>大头也遇见过很多优秀的人才，干的好好的，今年却被突然要求本科毕业证，哪怕是非统招的也可以，要不然就会面临不续合同、被裁员等。</p>
<p>因此，提升学历也很重要。</p>
<p>但是，如此多的提升学历的方法，如此多付费的广告，该如何选择呢？</p>
<p>现在提升学历无非几种方案。</p>
<ul>
<li>非统招<ul>
<li>成考&#x2F;业余&#x2F;函授&#x2F;非脱产：这四个现在是一样的，没区别，今年开始统一叫<code>非脱产</code>形式了。需要参加<code>成人高考</code>。相对来说比较简单，入学以后多数学校需要在周末去上课，参加考试，有平时分，毕业很简单。</li>
<li>网络教育：无需上课，网上学习，参加考试即可毕业。也是很多机构推的方案。不过现在已经取消了。所以大家不要再相信了。</li>
<li>国家开放大学：入学以后有的需要到学校学习，和非脱产类似，但是比非脱产容易毕业。</li>
<li>自考：极难、没有入学一说，只要参加这个专业所有课程的考试并且考试合格就可以了。也不用到学校学习，适合有自制力且有时间的人。</li>
</ul>
</li>
<li>统招：参加高考上大学，很多人有误区，以为现在不能高考了，其实没有年龄限制，只要你想还是可以去参加的。</li>
</ul>
<p>上面说的是本科，那么对于研究生来说也是一样的。</p>
<ul>
<li>非统招：参加研究生统一考试，入学以后工作日晚上和周末去上课，和统招的统一毕业条件，因此学习年限更久。学费更多。但是入学分数要低一些。因为竞争者少。</li>
<li>统招：参加研究生统一考试，正常上课毕业。</li>
<li>在职：在职研究生属于只有毕业证没有学位证的研究生，是以前的一种形式，以后会被非统招代替。在职研究生入学简单，毕业简单。</li>
</ul>
<h3 id="如何发表顶会论文"><a href="#如何发表顶会论文" class="headerlink" title="如何发表顶会论文"></a>如何发表顶会论文</h3><p>要满足顶会论文的要求，需从选题创新性、实验设计、论文写作、格式规范、投稿流程等多个环节系统把控。</p>
<p>此外，需要不断的阅读优秀的文献，比如其他的顶会论文，学习他们的技巧。</p>
<p>需要有不错的idea和综合能力支撑你的论文发表。</p>
<p>平常可以多练习写作。</p>
<p>对于已经工作的该如何做呢？</p>
<p>可以多撰写软著、专利等。</p>
<p>再比如提升自身的影响力，发表书籍等。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>DeepSeek的高薪招聘不仅反映了AI行业对顶尖人才的渴求，也揭示了技术驱动型企业“以薪酬换速度”的竞争策略。对于求职者而言，扎实的学术背景、工程能力与持续创新意识，是叩开百万年薪大门的核心钥匙。未来，随着AGI研发的深入，这场人才争夺战或将愈演愈烈。</p>
<h2 id="文末福利"><a href="#文末福利" class="headerlink" title="文末福利"></a>文末福利</h2><blockquote>
<p>关注我发送“MySQL知识图谱”领取完整的MySQL学习路线。<br>发送“电子书”即可领取价值上千的电子书资源。<br>发送“大厂内推”即可获取京东、美团等大厂内推信息，祝你获得高薪职位。<br>部分电子书如图所示。</p>
</blockquote>
<p><img src="https://thepatterraining.github.io/images/bottom1.png" alt="概念学习"></p>
<p><img src="https://thepatterraining.github.io/images/bottom2.png" alt="概念学习"></p>
<p><img src="https://thepatterraining.github.io/images/bottom3.png" alt="概念学习"></p>
<p><img src="https://thepatterraining.github.io/images/bottom4.png" alt="概念学习"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://thepatterraining.github.io/%E6%94%AF%E4%BB%98%E5%AE%9D%20P0%20%E4%BA%8B%E6%95%85%EF%BC%8C%E5%A4%AA%E7%A6%BB%E8%B0%B1%E4%BA%86%E3%80%82%E3%80%82%E3%80%82.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpeg">
      <meta itemprop="name" content="Thepatter">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/%E6%94%AF%E4%BB%98%E5%AE%9D%20P0%20%E4%BA%8B%E6%95%85%EF%BC%8C%E5%A4%AA%E7%A6%BB%E8%B0%B1%E4%BA%86%E3%80%82%E3%80%82%E3%80%82.html" class="post-title-link" itemprop="url">支付宝 P0 事故，太离谱了。。。</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-01-19 10:12:47" itemprop="dateCreated datePublished" datetime="2025-01-19T10:12:47+08:00">2025-01-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-01-26 10:07:53" itemprop="dateModified" datetime="2025-01-26T10:07:53+08:00">2025-01-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">算法</span></a>
                </span>
            </span>

          
            <span id="/%E6%94%AF%E4%BB%98%E5%AE%9D%20P0%20%E4%BA%8B%E6%95%85%EF%BC%8C%E5%A4%AA%E7%A6%BB%E8%B0%B1%E4%BA%86%E3%80%82%E3%80%82%E3%80%82.html" class="post-meta-item leancloud_visitors" data-flag-title="支付宝 P0 事故，太离谱了。。。" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/%E6%94%AF%E4%BB%98%E5%AE%9D%20P0%20%E4%BA%8B%E6%95%85%EF%BC%8C%E5%A4%AA%E7%A6%BB%E8%B0%B1%E4%BA%86%E3%80%82%E3%80%82%E3%80%82.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/%E6%94%AF%E4%BB%98%E5%AE%9D%20P0%20%E4%BA%8B%E6%95%85%EF%BC%8C%E5%A4%AA%E7%A6%BB%E8%B0%B1%E4%BA%86%E3%80%82%E3%80%82%E3%80%82.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="支付宝P0事故"><a href="#支付宝P0事故" class="headerlink" title="支付宝P0事故"></a>支付宝P0事故</h2><p>大家好，我是大头。<br>就在2025年1月16号，支付宝平台被曝出现了P0级事故，真可谓是2025年的过年惊喜啊。</p>
<p>怎么回事呢？<br>有网友晒出，在昨天下午14:40-14:45的这段时间里，通过支付宝支付时，均被提示“政府补贴”，减免优惠20%。</p>
<p><img src="/../images/640.jpg" alt="P0"></p>
<p>而这些优惠包括支付以及转账，什么概念呢？</p>
<p>也就是说假设你手里有1万块钱，你把1万转给你媳妇，你只需要支付8000，你媳妇收到1万，白嫖2000。你媳妇再转给你，又能白嫖2000.</p>
<p>来钱简直不要太快啊。如果你有100万呢？一次就是20万啊。</p>
<p>不过呢，真这样可能有点刑。。。</p>
<p>那么什么是P0事故呢？在互联网大厂里面，如何对事故定级呢？</p>
<p>为什么支付宝可以如此快的处理这种事故？</p>
<p>如果我们的公司遇到这种事故该如何处理？</p>
<h3 id="什么是P0事故"><a href="#什么是P0事故" class="headerlink" title="什么是P0事故"></a>什么是P0事故</h3><p>在互联网企业中，P0代表最高级别的事故，通常是核心业务重要功能不可用，且影响范围广泛。以目前这起事故的严重程度来看，绝对是妥妥的P0级别事故了。</p>
<p>除此之外，还会对于涉及到的金额进行资金定损，比如这一次事故中，造成了多少资金损失。</p>
<p>大家别看只是短短的5分钟，对于支付宝这个体量来说，其造成的损失数额绝对不小，不过对于支付宝来说，可能洒洒水啦。</p>
<p>那么除了P0事故来说，还有别的事故等级吗？</p>
<p>当然是有的，还有P1、P2等等，其中P0是最严重的。</p>
<p>相信对于程序员来说，最关心的一点还是，出了这么大的事故，对我有什么影响吗？</p>
<p>不同的事故等级对应的影响也不一样。</p>
<ul>
<li>最低级的事故：可能只是通报批评，下次注意</li>
<li>有一定损失或者影响的事故：比如P2事故，可能会影响你的当年绩效了</li>
<li>有不少损失或者影响的事故：比如P1事故，那么不仅影响你当年的绩效奖金了，还会影响到你的评优、内部的奖项以及最重要的晋升，还可能影响到你直属leader的绩效奖金。</li>
<li>有很大损失或者影响的事故：比如P0事故，那么不光影响上面那些，还包括了你leader的评优、奖项以及晋升。可能还会导致你们团队负责人的绩效、评优、晋升。再严重一些还会收到辞退。</li>
</ul>
<h3 id="为什么支付宝可以如此快的处理这种事故？"><a href="#为什么支付宝可以如此快的处理这种事故？" class="headerlink" title="为什么支付宝可以如此快的处理这种事故？"></a>为什么支付宝可以如此快的处理这种事故？</h3><p>大厂通常都有完善的上线流程以及监控处理。</p>
<p>如何监控呢？</p>
<ul>
<li>链路服务监控</li>
<li>日志机制</li>
<li>报警机制</li>
</ul>
<p>大厂内部都有自己研发的一整套监控报警系统，所以可以快速的发现事故，并依据一整套完善的事故处理机制进行处理。</p>
<p>那对于我们其他公司来说如何处理呢？</p>
<p>对于链路服务监控，我们可以使用<code>SkyWalking</code>来进行监控，以及日志收集，那么当日志收集以后我们还需要进行报警，比如发送报警邮件、短信或者微信提醒。</p>
<p>SkyWalking是什么？</p>
<p>SkyWalking是分布式系统的应用程序性能监控工具，专为微服务、云原生和基于容器（Kubernetes）架构而设计。</p>
<p>下面是SkyWalking官网。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://skywalking.apache.org/">https://skywalking.apache.org/</a></p>
</blockquote>
<p>那么当发现事故以后，我们第一步该做什么？定位问题，然后修改？不不不….</p>
<p>当然是第一时间回滚止损了。</p>
<p>接下来才是定位问题、修复。</p>
<p>这么一来就会发现，还需要完善的上线流程、回滚方案。事故处理方案。</p>
<p>对于很多小问题的修改或者需求，我们可能会下意识的觉得，就改动这么点东西，没问题，上了吧。</p>
<p>如果这个时候出了问题，你可能就傻了，根本没想过出问题的解决方案。而且出的问题可能和你改动的东西八竿子打不着，你都想不到是因为你上线导致的。</p>
<p>所以大家切记，上线方案很重要！！！</p>
<p>经验主义害死人啊！！！实践才是检验真理的唯一标准！！！</p>
<h3 id="如果我们的公司遇到这种事故该如何处理"><a href="#如果我们的公司遇到这种事故该如何处理" class="headerlink" title="如果我们的公司遇到这种事故该如何处理"></a>如果我们的公司遇到这种事故该如何处理</h3><p>接下来，如果我们的公司遇到这种事故该如何处理？</p>
<p>首先，像上面说的，我们需要几个方案</p>
<ol>
<li>完善的监控机制，可以使用SkyWalking</li>
<li>完善的日志机制，可以帮助我们快速定位问题</li>
<li>完善的报警机制，可以帮助我们发现问题</li>
<li>完善的上线流程，这里包括代码Review，回滚方案，git分支管理方案等。可以帮助我们快速的解决问题</li>
<li>完善的事故处理流程，当事故发生以后我们该如何处理</li>
</ol>
<h4 id="监控机制"><a href="#监控机制" class="headerlink" title="监控机制"></a>监控机制</h4><p>使用 SkyWalking 即可，官网已经放在上面了，可以根据官方文档进行学习。</p>
<h4 id="日志机制"><a href="#日志机制" class="headerlink" title="日志机制"></a>日志机制</h4><p>不同的日志等级代表不同的日志，并且分开不同的文件，还有在一次请求的时候，需要有唯一ID来检查这一次请求的所有日志。</p>
<p>此外，哪些地方需要记录日志呢？</p>
<ul>
<li>输入</li>
<li>输出</li>
<li>重要处理节点</li>
<li>重要计算结果</li>
<li>异常处理</li>
<li>其他</li>
</ul>
<p>根据这些来快速定位问题。</p>
<p>这里要注意：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">不要在日志中记录一些容易报错的代码，你不能因为日志报错而影响主流程。</span><br></pre></td></tr></table></figure>

<h4 id="报警机制"><a href="#报警机制" class="headerlink" title="报警机制"></a>报警机制</h4><p>当监控检测到错误的时候，我们可以进行报警通知，通过邮件、微信、短信等手段进行通知相关人员。</p>
<p>这样可以快速的让相关人员知道出现事故了。接下来才能解决。</p>
<h4 id="上线流程"><a href="#上线流程" class="headerlink" title="上线流程"></a>上线流程</h4><p>上线流程最重要的几点</p>
<ul>
<li>代码Review</li>
<li>完善的测试</li>
<li>回滚方案</li>
</ul>
<p>上线的时候一定要经过这些，哪怕是需求再小 or 改动再小。</p>
<p>因为你永远不知道意外和明天哪一个先来。。。</p>
<h4 id="事故处理流程"><a href="#事故处理流程" class="headerlink" title="事故处理流程"></a>事故处理流程</h4><p>当发现事故以后，如何处理就成为了重点。</p>
<p>当报警机制触发以后，我们首先应该根据上线方案进行回滚。</p>
<p>回滚以后，我们需要发送一些通知，让其他成员知道回滚了。以防止有人稀里糊涂的又把代码发布了或者覆盖了。</p>
<p>接下来根据日志信息配合测试一起快速的定位问题。</p>
<p>……</p>
<p>最终将问题修复。</p>
<p>再次上线。</p>
<p>并将这次事故记录，复盘。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>话说回来了。那么支付宝这次事故。钱会不会追回呢？</p>
<p><img src="/../images/641.jpg" alt="P0"></p>
<p>答案是不会追回资金，支付宝还是很强大的，选择了自己承担这笔损失，当然了，具体哪些程序员倒霉就不知道了。</p>
<p>如果你收到追回短信等，不要相信，都是骗子！！！</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://thepatterraining.github.io/%E6%88%91%E6%98%AF%E5%A6%82%E4%BD%95%E4%B8%80%E4%B8%AA%E5%B0%8F%E6%97%B6%E6%95%99%E4%BC%9A%E5%B0%8F%E7%99%BD%E6%89%8B%E5%86%99netty%E6%A1%86%E6%9E%B6%E7%9A%84.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpeg">
      <meta itemprop="name" content="Thepatter">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/%E6%88%91%E6%98%AF%E5%A6%82%E4%BD%95%E4%B8%80%E4%B8%AA%E5%B0%8F%E6%97%B6%E6%95%99%E4%BC%9A%E5%B0%8F%E7%99%BD%E6%89%8B%E5%86%99netty%E6%A1%86%E6%9E%B6%E7%9A%84.html" class="post-title-link" itemprop="url">我是如何一个小时教会小白手写netty框架的</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-12-15 10:12:47" itemprop="dateCreated datePublished" datetime="2024-12-15T10:12:47+08:00">2024-12-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-01-26 10:07:53" itemprop="dateModified" datetime="2025-01-26T10:07:53+08:00">2025-01-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
            </span>

          
            <span id="/%E6%88%91%E6%98%AF%E5%A6%82%E4%BD%95%E4%B8%80%E4%B8%AA%E5%B0%8F%E6%97%B6%E6%95%99%E4%BC%9A%E5%B0%8F%E7%99%BD%E6%89%8B%E5%86%99netty%E6%A1%86%E6%9E%B6%E7%9A%84.html" class="post-meta-item leancloud_visitors" data-flag-title="我是如何一个小时教会小白手写netty框架的" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/%E6%88%91%E6%98%AF%E5%A6%82%E4%BD%95%E4%B8%80%E4%B8%AA%E5%B0%8F%E6%97%B6%E6%95%99%E4%BC%9A%E5%B0%8F%E7%99%BD%E6%89%8B%E5%86%99netty%E6%A1%86%E6%9E%B6%E7%9A%84.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/%E6%88%91%E6%98%AF%E5%A6%82%E4%BD%95%E4%B8%80%E4%B8%AA%E5%B0%8F%E6%97%B6%E6%95%99%E4%BC%9A%E5%B0%8F%E7%99%BD%E6%89%8B%E5%86%99netty%E6%A1%86%E6%9E%B6%E7%9A%84.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="netty"><a href="#netty" class="headerlink" title="netty"></a>netty</h1><h3 id="socket"><a href="#socket" class="headerlink" title="socket"></a>socket</h3><p>今天，小白的老师让小白写一个服务器，小白学艺不精，过来向大头求救了。</p>
<p><img src="/../images/java/netty1.png" alt="netty服务器"></p>
<p><img src="/../images/java/netty2.png" alt="netty服务器"></p>
<p><img src="/../images/java/netty3.png" alt="netty服务器"></p>
<p>那么socket究竟是什么呢？套接字接口(socket interface)是一组函数，它们和Unix I &#x2F;O函数结合起来，用以创建网络应用。从Linux内核的角度来看， 一个套接字就是通信的一个端点。从Linux程序的角度来看，套接字就是一个有相应描述符的打开文件。</p>
<p>下图来源于CSAPP的书。</p>
<p><img src="/../images/csapp/csapp11-2.png" alt="page table"></p>
<p>这张图清晰的表明了socket是个啥，从逻辑上说，这玩意就是个接口，从这个接口能发送和接收数据，从物理上说，这玩意就是个文件，发送数据就是往这个文件里面写入数据，接收数据就是从这个文件里面读取数据。所以Socket也是个IO操作。只不过这个文件的数据不存储在你电脑的硬盘里面，而是通过网络发送出去了。</p>
<p>通过<code>socket</code>函数可以打开一个文件，返回一个文件描述符。文件描述符可以简单的理解为文件的ID，唯一标识，一般默认打开的3个文件描述符就是标准输入，标准输出，错误输出，对应0、1、2.假设我们打开了一个socket文件，描述符是3.</p>
<p>接下来通过服务器通过<code>bind</code>函数，可以将这个socket文件，和一个IP还有端口号进行绑定。绑定以后写入这个文件的数据就会从这个IP端口读取出来或者发送出去。</p>
<p>socket分为客户端和服务器，客户端主动发起请求，服务器被动接受请求，<code>listen</code>函数就是告诉Linux内核，我这个socket是一个服务器，而不是一个客户端。</p>
<p>最后通过<code>accept</code>函数，来等待客户端的连接.accept函数会返回一个新的文件描述符，通过这个新的文件进行传递数据，而老的文件仅仅负责建立连接。</p>
<p>下图为accept的时候服务器的状态，这个时候等待连接。<br><img src="/../images/java/netty4.png" alt="netty服务器"></p>
<p>当连接建立以后，会通过新的文件描述符4进行通信。</p>
<p><img src="/../images/java/netty5.png" alt="netty服务器"></p>
<p>基于上述理论知识，学过哲学的都知道，<code>实践是检验真理的唯一标准</code>。所以小白用java实现了第一版socket服务器。端口号是8888，祝看到这里的兄弟们发发发发。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SocketServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FILE_PATH</span> <span class="operator">=</span> <span class="string">&quot;HelloWorld.java&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">readFileAsString</span><span class="params">(String filePath)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">contentBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">FileReader</span>(filePath))) &#123;</span><br><span class="line">            String currentLine;</span><br><span class="line">            <span class="keyword">while</span> ((currentLine = br.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                System.out.println(currentLine); <span class="comment">// 打印读取的每一行</span></span><br><span class="line">                contentBuilder.append(currentLine).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> contentBuilder.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">8888</span>; <span class="comment">// 服务器监听的端口号</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 创建服务器端的ServerSocket，绑定端口号</span></span><br><span class="line">            <span class="type">ServerSocket</span> <span class="variable">serverSocket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(port);</span><br><span class="line">            System.out.println(<span class="string">&quot;Server is running and listening on port &quot;</span> + port);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 服务器无限循环，等待客户端连接</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="comment">// 服务器调用accept()方法，阻塞并等待客户端连接</span></span><br><span class="line">                <span class="type">Socket</span> <span class="variable">clientSocket</span> <span class="operator">=</span> serverSocket.accept();</span><br><span class="line">                System.out.println(<span class="string">&quot;Client connected.&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 读取HTTP请求</span></span><br><span class="line">                    <span class="type">BufferedReader</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(clientSocket.getInputStream()));</span><br><span class="line">                    String inputLine;</span><br><span class="line">                    <span class="type">StringBuilder</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                    <span class="keyword">while</span> ((inputLine = in.readLine()) != <span class="literal">null</span> &amp;&amp; !inputLine.isEmpty()) &#123;</span><br><span class="line">                        request.append(inputLine).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 发送HTTP响应</span></span><br><span class="line">                    <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintWriter</span>(clientSocket.getOutputStream(), <span class="literal">true</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">fileContent</span> <span class="operator">=</span> readFileAsString(FILE_PATH);</span><br><span class="line">                    <span class="type">long</span> <span class="variable">contentLength</span> <span class="operator">=</span> fileContent.getBytes().length;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> <span class="string">&quot;HTTP/1.1 200 OK\r\n&quot;</span> +</span><br><span class="line">                            <span class="string">&quot;Content-Type: application/json\r\n&quot;</span> +</span><br><span class="line">                            <span class="string">&quot;Content-Length: &quot;</span> + contentLength + <span class="string">&quot;\r\n&quot;</span> +</span><br><span class="line">                            <span class="string">&quot;Connection: close\r\n&quot;</span> +</span><br><span class="line">                            <span class="string">&quot;\r\n&quot;</span> +</span><br><span class="line">                            fileContent;</span><br><span class="line">                    out.println(response);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 关闭连接</span></span><br><span class="line">                    clientSocket.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">&quot;Client says: hello world!&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 关闭连接</span></span><br><span class="line">                clientSocket.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个代码里面没有<code>bind</code>和<code>listen</code>。这是因为被java封装起来了。如果看看<code>ServerSocket</code>里面的代码就能看见这两个函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ServerSocket</span><span class="params">(<span class="type">int</span> port)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//调用了另外一个构造函数</span></span><br><span class="line">    <span class="built_in">this</span>(port, <span class="number">50</span>, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ServerSocket</span><span class="params">(<span class="type">int</span> port, <span class="type">int</span> backlog, InetAddress bindAddr)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  <span class="comment">// 参数检测</span></span><br><span class="line">  <span class="keyword">if</span> (port &lt; <span class="number">0</span> || port &gt; <span class="number">0xFFFF</span>)</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Port value out of range: &quot;</span> + port);</span><br><span class="line">  <span class="keyword">if</span> (backlog &lt; <span class="number">1</span>)</span><br><span class="line">      backlog = <span class="number">50</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建了一个实现类</span></span><br><span class="line">  <span class="built_in">this</span>.impl = createImpl();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 调用了bind方法</span></span><br><span class="line">      bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(bindAddr, port), backlog);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException | SecurityException e) &#123;</span><br><span class="line">      close();</span><br><span class="line">      <span class="keyword">throw</span> e;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面能看到调用了<code>bind</code>方法。再看看<code>bind</code>里面呢。能看到这个里面有<code>getImpl().bind</code>和<code>getImpl().listen</code>。这就是上面说的<code>bind</code>和<code>listen</code>函数了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将服务器Socket绑定到指定的端点地址并设置监听队列长度</span></span><br><span class="line"><span class="comment"> * 此方法确保Socket未关闭且未绑定，并验证端点地址和backlog参数的合法性</span></span><br><span class="line"><span class="comment"> * 如果满足所有条件，则进行绑定和监听设置</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> endpoint 要绑定的端点地址，如果为null，则创建一个未指定端口的InetSocketAddress实例</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> backlog 监听队列的长度，如果小于1，则使用默认值50</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException 如果绑定或监听过程中发生I/O错误</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> SocketException 如果Socket已关闭、已绑定、地址未解析或不支持的地址类型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IllegalArgumentException 如果端点地址类型不受支持</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bind</span><span class="params">(SocketAddress endpoint, <span class="type">int</span> backlog)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 检查Socket是否已关闭</span></span><br><span class="line">    <span class="keyword">if</span> (isClosed())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SocketException</span>(<span class="string">&quot;Socket is closed&quot;</span>);</span><br><span class="line">    <span class="comment">// 检查Socket是否已绑定</span></span><br><span class="line">    <span class="keyword">if</span> (isBound())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SocketException</span>(<span class="string">&quot;Already bound&quot;</span>);</span><br><span class="line">    <span class="comment">// 如果未指定端点地址，则创建一个未指定端口的InetSocketAddress实例</span></span><br><span class="line">    <span class="keyword">if</span> (endpoint == <span class="literal">null</span>)</span><br><span class="line">        endpoint = <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 检查端点地址是否为InetSocketAddress类型</span></span><br><span class="line">    <span class="keyword">if</span> (!(endpoint <span class="keyword">instanceof</span> InetSocketAddress epoint))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unsupported address type&quot;</span>);</span><br><span class="line">    <span class="comment">// 检查端点地址是否已解析</span></span><br><span class="line">    <span class="keyword">if</span> (epoint.isUnresolved())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SocketException</span>(<span class="string">&quot;Unresolved address&quot;</span>);</span><br><span class="line">    <span class="comment">// 检查backlog参数是否合法</span></span><br><span class="line">    <span class="keyword">if</span> (backlog &lt; <span class="number">1</span>)</span><br><span class="line">        backlog = <span class="number">50</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 安全检查，确保有权限监听指定端口</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;removal&quot;)</span></span><br><span class="line">    <span class="type">SecurityManager</span> <span class="variable">security</span> <span class="operator">=</span> System.getSecurityManager();</span><br><span class="line">    <span class="keyword">if</span> (security != <span class="literal">null</span>)</span><br><span class="line">        security.checkListen(epoint.getPort());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 同步块，确保线程安全</span></span><br><span class="line">    <span class="keyword">synchronized</span> (stateLock) &#123;</span><br><span class="line">        <span class="comment">// 再次检查Socket是否已关闭或绑定</span></span><br><span class="line">        <span class="keyword">if</span> (closed)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SocketException</span>(<span class="string">&quot;Socket is closed&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (bound)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SocketException</span>(<span class="string">&quot;Already bound&quot;</span>);</span><br><span class="line">        <span class="comment">// 调用实现类的方法进行实际的绑定和监听设置</span></span><br><span class="line">        getImpl().bind(epoint.getAddress(), epoint.getPort());</span><br><span class="line">        getImpl().listen(backlog);</span><br><span class="line">        <span class="comment">// 设置绑定状态为true</span></span><br><span class="line">        bound = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/../images/java/netty6.png" alt="第一版socket"></p>
<p><img src="/../images/java/netty7.png" alt="第一版socket"></p>
<p>让我们用<code>wrk</code>压测一下。可以发现很垃圾。仅仅处理了4个请求，虽然响应时间很快。可是吞吐量太低了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Running 30s test @ http://localhost:8888</span><br><span class="line">  10 threads and 10000 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency    55.33ms  326.77us  55.72ms   50.00%</span><br><span class="line">    Req/Sec    40.00      0.00    40.00    100.00%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%   55.44ms</span><br><span class="line">     75%   55.72ms</span><br><span class="line">     90%   55.72ms</span><br><span class="line">     99%   55.72ms</span><br><span class="line">  4 requests in 30.10s, 852.00B read</span><br><span class="line">  Socket errors: connect 7967, read 196512, write 14, timeout 0</span><br><span class="line">Requests/sec:      0.13</span><br><span class="line">Transfer/sec:      28.30B</span><br></pre></td></tr></table></figure>

<p><img src="/../images/java/netty8.png" alt="第一版socket"></p>
<p><img src="/../images/java/netty9.png" alt="第一版socket"></p>
<p><img src="/../images/java/netty10.png" alt="第一版socket"></p>
<p>接下来，上线程池，小白实现了第二版代码。这次的代码加入了线程池，所有的客户端请求建立以后通过线程池的线程进行处理。建立10个线程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleHttpServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PORT</span> <span class="operator">=</span> <span class="number">8888</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FILE_PATH</span> <span class="operator">=</span> <span class="string">&quot;HelloWorld.java&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">ServerSocket</span> <span class="variable">serverSocket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(PORT)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Server is running at http://localhost:&quot;</span> + PORT);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">Socket</span> <span class="variable">clientSocket</span> <span class="operator">=</span> serverSocket.accept();</span><br><span class="line">                threadPool.execute(<span class="keyword">new</span> <span class="title class_">ClientHandler</span>(clientSocket));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ClientHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Socket clientSocket;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">ClientHandler</span><span class="params">(Socket clientSocket)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.clientSocket = clientSocket;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 读取HTTP请求</span></span><br><span class="line">                <span class="type">BufferedReader</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(clientSocket.getInputStream()));</span><br><span class="line">                String inputLine;</span><br><span class="line">                <span class="type">StringBuilder</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                <span class="keyword">while</span> ((inputLine = in.readLine()) != <span class="literal">null</span> &amp;&amp; !inputLine.isEmpty()) &#123;</span><br><span class="line">                    request.append(inputLine).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 发送HTTP响应</span></span><br><span class="line">                <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintWriter</span>(clientSocket.getOutputStream(), <span class="literal">true</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">fileContent</span> <span class="operator">=</span> readFileAsString(FILE_PATH);</span><br><span class="line">                <span class="type">long</span> <span class="variable">contentLength</span> <span class="operator">=</span> fileContent.getBytes().length;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> <span class="string">&quot;HTTP/1.1 200 OK\r\n&quot;</span> +</span><br><span class="line">                            <span class="string">&quot;Content-Type: application/json\r\n&quot;</span> +</span><br><span class="line">                            <span class="string">&quot;Content-Length: &quot;</span> + contentLength + <span class="string">&quot;\r\n&quot;</span> +</span><br><span class="line">                            <span class="string">&quot;Connection: close\r\n&quot;</span> +</span><br><span class="line">                            <span class="string">&quot;\r\n&quot;</span> +</span><br><span class="line">                            fileContent;</span><br><span class="line">                    out.println(response);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 关闭连接</span></span><br><span class="line">                clientSocket.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String <span class="title function_">readFileAsString</span><span class="params">(String filePath)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">contentBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">FileReader</span>(filePath))) &#123;</span><br><span class="line">                String currentLine;</span><br><span class="line">                <span class="keyword">while</span> ((currentLine = br.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                    System.out.println(currentLine); <span class="comment">// 打印读取的每一行</span></span><br><span class="line">                    contentBuilder.append(currentLine).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> contentBuilder.toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>接下来在看压测结果。同样30s，处理了13个请求，处理时间虽然略有上升，但是整体性能提升了很多。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Running 30s test @ http://localhost:8888</span><br><span class="line">  10 threads and 10000 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency   118.94ms   32.73ms 148.30ms   53.85%</span><br><span class="line">    Req/Sec    17.50     21.62    60.00     83.33%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%  147.83ms</span><br><span class="line">     75%  148.02ms</span><br><span class="line">     90%  148.25ms</span><br><span class="line">     99%  148.30ms</span><br><span class="line">  13 requests in 30.10s, 2.70KB read</span><br><span class="line">  Socket errors: connect 7967, read 198469, write 1, timeout 0</span><br><span class="line">Requests/sec:      0.43</span><br><span class="line">Transfer/sec:      91.99B</span><br></pre></td></tr></table></figure>

<p><img src="/../images/java/netty11.png" alt="第一版socket"></p>
<p><img src="/../images/java/netty12.png" alt="第一版socket"></p>
<h3 id="IO"><a href="#IO" class="headerlink" title="IO"></a>IO</h3><p>在 Java 中，BIO、NIO 和 AIO 是三种不同的 I&#x2F;O 模型，它们各自的工作原理和使用场景有所不同。下面简要说明这三种 I&#x2F;O 模型：</p>
<h4 id="BIO（Blocking-I-x2F-O，阻塞-I-x2F-O）"><a href="#BIO（Blocking-I-x2F-O，阻塞-I-x2F-O）" class="headerlink" title="BIO（Blocking I&#x2F;O，阻塞 I&#x2F;O）"></a>BIO（Blocking I&#x2F;O，阻塞 I&#x2F;O）</h4><p>BIO就类似于你去胖东来，但是人太多了，要排队进去，而且你这个时候走了，那么你的位置就没了，需要重新排队，所以你不能离开，你只能排队等着！！！这就是所谓的同步阻塞。</p>
<p><img src="/../images/java/netty13.png" alt="第一版socket"></p>
<p>原理：<br>BIO 是传统的 I&#x2F;O 模型，在这个模型中，每次读取或写入数据时，线程都会被阻塞，直到操作完成。<br>每个连接对应一个线程，线程会一直阻塞，直到 I&#x2F;O 操作完成后才能继续执行其他任务。</p>
<p>特性：</p>
<ul>
<li>阻塞：每次读写操作都会等待数据的到来或写入完成，阻塞当前线程。</li>
<li>线程绑定：每个客户端连接都会占用一个独立的线程。</li>
<li>简单直观：编程模型简单，适合小规模应用，但不适合高并发的场景。</li>
</ul>
<p>优缺点：</p>
<ul>
<li>优点：实现简单，编程模型直观。</li>
<li>缺点：性能差，尤其是在高并发场景下，线程过多导致资源浪费（线程上下文切换开销大）。</li>
</ul>
<p>使用场景：<br>适合低并发、连接数不多的应用场景，例如小型 Web 服务。</p>
<h4 id="NIO（New-I-x2F-O，新-I-x2F-O）"><a href="#NIO（New-I-x2F-O，新-I-x2F-O）" class="headerlink" title="NIO（New I&#x2F;O，新 I&#x2F;O）"></a>NIO（New I&#x2F;O，新 I&#x2F;O）</h4><p>NIO通过操作系统提供的IO多路复用机制，可以实现多线程的性能，因为IO多路复用，本质上是单线程的，所以省去了操作系统线程切换的开销。</p>
<p>拿胖东来说，BIO你只能等着，但如果你是NIO，那么胖东来说，我给你发个号吧，你是88号，接下来你爱干啥干啥去，等我叫88号了，你过来就行了。但是呢，我只负责叫号，你离远了听不见那是你的事，你的时不时的过来问我一下，到88号了吗？到了你就进去，没到你就等着。</p>
<p><img src="/../images/java/netty14.png" alt="第一版socket"></p>
<p>从代码来说，就是通过select进行订阅。比如select订阅文件描述符3号的状态，操作系统如果发现有数据从网络中传输过来，那么就写入3号文件，写完以后，操作系统就改变3号文件的状态，这个时候select如果过来判断3号的状态，发现变了，就知道可以执行对应的操作了，比如服务器开始运行，然后读取文件内容发送给客户端。</p>
<p><img src="/../images/java/netty15.png" alt="第一版socket"></p>
<p>原理：<br>NIO 提供了 非阻塞 I&#x2F;O 的能力，支持多路复用技术，允许一个线程同时处理多个 I&#x2F;O 操作。<br>通过使用 Selector 和 Channel，NIO 可以在一个线程中处理多个客户端的 I&#x2F;O 请求。<br>非阻塞：读取和写入操作不会阻塞线程，如果没有数据可用，线程会继续执行其他任务。</p>
<p>特性：</p>
<ul>
<li>非阻塞 I&#x2F;O：可以通过轮询和事件通知的方式处理 I&#x2F;O 请求，而不必阻塞等待。</li>
<li>多路复用：通过 Selector 实现一个线程管理多个 Channel，处理多个连接。</li>
<li>高效：减少了线程的开销，适用于高并发场景。</li>
</ul>
<p>优缺点：</p>
<ul>
<li>优点：比 BIO 更高效，适合高并发、高负载的应用。</li>
<li>缺点：编程模型较为复杂，需要理解 Selector、Channel、Buffer 的使用方式，开发成本较高。</li>
</ul>
<p>使用场景：<br>高并发、大规模连接的网络应用，如服务器（HTTP、Chat Server 等）、数据库连接池、文件上传下载等。</p>
<h4 id="AIO（Asynchronous-I-x2F-O，异步-I-x2F-O）"><a href="#AIO（Asynchronous-I-x2F-O，异步-I-x2F-O）" class="headerlink" title="AIO（Asynchronous I&#x2F;O，异步 I&#x2F;O）"></a>AIO（Asynchronous I&#x2F;O，异步 I&#x2F;O）</h4><p>AIO就是说，在胖东来排队的时候，你找他要号的时候，还留了个手机号码，告诉他，到我了你就给我打电话，他给你88号，等叫到88号了，他就给你打电话说，到你了，过来吧。和NIO的区别就是你不用老过来问了，到了我打电话叫你。</p>
<p><img src="/../images/java/netty16.png" alt="第一版socket"></p>
<p>原理：<br>AIO 是 Java 7 引入的异步 I&#x2F;O 模型，它的关键特性是完全异步，即操作完成后系统会通过回调通知应用程序。<br>在 AIO 中，线程发起 I&#x2F;O 请求后，不会阻塞等待，而是返回，等 I&#x2F;O 操作完成时，操作系统会通知 Java 程序，程序再通过回调函数获取结果。</p>
<p>特性：</p>
<ul>
<li>异步：I&#x2F;O 操作发起后，线程立即返回，不会等待操作完成。</li>
<li>事件驱动：操作完成后，系统通过回调通知应用程序处理结果。</li>
<li>无需轮询：不同于 NIO，AIO 不需要手动轮询 Selector，操作完成后直接通过回调处理结果。</li>
</ul>
<p>优缺点：</p>
<ul>
<li>优点：可以进一步减少线程和上下文切换，性能非常高，适合超高并发的应用。</li>
<li>缺点：复杂度最高，需要理解回调和事件处理机制，调试较为困难。</li>
</ul>
<p>使用场景：<br>适用于极高并发的应用场景，如实时数据流处理、大规模分布式系统等。</p>
<table>
<thead>
<tr>
<th><strong>特性</strong></th>
<th><strong>BIO</strong></th>
<th><strong>NIO</strong></th>
<th><strong>AIO</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>阻塞方式</strong></td>
<td>阻塞（每个操作阻塞当前线程）</td>
<td>非阻塞（通过轮询和事件驱动）</td>
<td>异步（操作完成后通过回调通知）</td>
</tr>
<tr>
<td><strong>线程管理</strong></td>
<td>每个连接一个线程</td>
<td>一个线程处理多个连接</td>
<td>一个线程发起请求，回调通知结果</td>
</tr>
<tr>
<td><strong>编程复杂度</strong></td>
<td>低</td>
<td>中</td>
<td>高</td>
</tr>
<tr>
<td><strong>性能</strong></td>
<td>性能差，适用于低并发场景</td>
<td>性能优越，适用于高并发场景</td>
<td>性能最优，适用于超高并发场景</td>
</tr>
<tr>
<td><strong>适用场景</strong></td>
<td>小规模服务，低并发应用</td>
<td>高并发应用，如 Web 服务器</td>
<td>极高并发应用，如大数据流处理</td>
</tr>
</tbody></table>
<h4 id="NIO实现"><a href="#NIO实现" class="headerlink" title="NIO实现"></a>NIO实现</h4><p>说了这么多，小白也实现了NIO版本的服务器。代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NIOHttpServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PORT</span> <span class="operator">=</span> <span class="number">8888</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FILE_TO_SERVE</span> <span class="operator">=</span> <span class="string">&quot;HelloWorld.java&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 打开一个 Selector，用于管理多个通道的 I/O 事件</span></span><br><span class="line">            <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. 打开一个 ServerSocketChannel，用于监听客户端连接</span></span><br><span class="line">            <span class="type">ServerSocketChannel</span> <span class="variable">serverSocketChannel</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3. 绑定到指定端口，并配置为非阻塞模式</span></span><br><span class="line">            serverSocketChannel.bind(<span class="keyword">new</span> <span class="title class_">java</span>.net.InetSocketAddress(PORT));</span><br><span class="line">            serverSocketChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4. 将 ServerSocketChannel 注册到 Selector，监听 ACCEPT 事件</span></span><br><span class="line">            serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;NIO HTTP Server started on port &quot;</span> + PORT);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="comment">// 5. 阻塞等待事件发生（或超时返回）</span></span><br><span class="line">                selector.select();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 6. 获取所有准备好的事件</span></span><br><span class="line">                Set&lt;SelectionKey&gt; selectedKeys = selector.selectedKeys();</span><br><span class="line">                Iterator&lt;SelectionKey&gt; iterator = selectedKeys.iterator();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                    <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">                    iterator.remove(); <span class="comment">// 移除已处理的事件</span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line">                        <span class="comment">// 处理新的客户端连接</span></span><br><span class="line">                        handleAccept(key);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">                        <span class="comment">// 处理客户端请求</span></span><br><span class="line">                        handleRead(key);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 接受客户端连接</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handleAccept</span><span class="params">(SelectionKey key)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ServerSocketChannel</span> <span class="variable">serverSocketChannel</span> <span class="operator">=</span> (ServerSocketChannel) key.channel();</span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">clientChannel</span> <span class="operator">=</span> serverSocketChannel.accept();</span><br><span class="line">        clientChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        <span class="comment">// 注册客户端通道到 Selector，监听 READ 事件</span></span><br><span class="line">        clientChannel.register(key.selector(), SelectionKey.OP_READ);</span><br><span class="line">        System.out.println(<span class="string">&quot;Accepted new connection from &quot;</span> + clientChannel.getRemoteAddress());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取客户端请求并响应</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handleRead</span><span class="params">(SelectionKey key)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">clientChannel</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取客户端发送的数据</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">bytesRead</span> <span class="operator">=</span> clientChannel.read(buffer);</span><br><span class="line">        <span class="keyword">if</span> (bytesRead == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// 客户端关闭连接</span></span><br><span class="line">            clientChannel.close();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        buffer.flip();</span><br><span class="line">        <span class="type">byte</span>[] requestData = <span class="keyword">new</span> <span class="title class_">byte</span>[buffer.remaining()];</span><br><span class="line">        buffer.get(requestData);</span><br><span class="line">        <span class="type">String</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(requestData);</span><br><span class="line">        System.out.println(<span class="string">&quot;Received request:\n&quot;</span> + request);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取 HelloWorld.java 文件内容</span></span><br><span class="line">        String fileContent;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fileContent = Files.readString(Paths.get(FILE_TO_SERVE));</span><br><span class="line">            System.out.println(<span class="string">&quot;Read file content:\n&quot;</span> + fileContent);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            fileContent = <span class="string">&quot;Error reading file: &quot;</span> + e.getMessage();</span><br><span class="line">            System.err.println(fileContent);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造 HTTP 响应</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> <span class="string">&quot;HTTP/1.1 200 OK\r\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;Content-Type: application/json\r\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;Content-Length: &quot;</span> + fileContent.length() + <span class="string">&quot;\r\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\r\n&quot;</span> +</span><br><span class="line">                fileContent;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将响应写入客户端</span></span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">responseBuffer</span> <span class="operator">=</span> ByteBuffer.wrap(response.getBytes());</span><br><span class="line">        clientChannel.write(responseBuffer);</span><br><span class="line">        clientChannel.close(); <span class="comment">// 响应完成后关闭连接</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在执行一下压测,结果表明处理了24个请求，吞吐量大大增加了。性能有明显提升，而且更加稳定。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Running 30s test @ http://localhost:8888</span><br><span class="line">  10 threads and 10000 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency   145.80ms    9.32ms 170.26ms   87.50%</span><br><span class="line">    Req/Sec    14.88      8.95    30.00     62.50%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%  142.46ms</span><br><span class="line">     75%  142.72ms</span><br><span class="line">     90%  168.73ms</span><br><span class="line">     99%  170.26ms</span><br><span class="line">  24 requests in 30.09s, 4.52KB read</span><br><span class="line">  Socket errors: connect 7967, read 192317, write 0, timeout 0</span><br><span class="line">Requests/sec:      0.80</span><br><span class="line">Transfer/sec:     153.92B</span><br></pre></td></tr></table></figure>

<p><img src="/../images/java/netty17.png" alt="第一版socket"></p>
<p><img src="/../images/java/netty18.png" alt="第一版socket"></p>
<p><img src="/../images/java/netty19.png" alt="第一版socket"></p>
<p>小白又把代码重新改了一遍。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Path;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NIOHttpServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PORT</span> <span class="operator">=</span> <span class="number">8888</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FILE_PATH</span> <span class="operator">=</span> <span class="string">&quot;HelloWorld.java&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">NIOHttpServer</span>().start();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Server error: &quot;</span> + e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br><span class="line">        <span class="type">ServerSocketChannel</span> <span class="variable">serverChannel</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">        serverChannel.bind(<span class="keyword">new</span> <span class="title class_">java</span>.net.InetSocketAddress(PORT));</span><br><span class="line">        serverChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        serverChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;Server started on port &quot;</span> + PORT);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            selector.select();</span><br><span class="line">            Set&lt;SelectionKey&gt; selectedKeys = selector.selectedKeys();</span><br><span class="line">            Iterator&lt;SelectionKey&gt; keyIterator = selectedKeys.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (keyIterator.hasNext()) &#123;</span><br><span class="line">                <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> keyIterator.next();</span><br><span class="line">                keyIterator.remove();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line">                    handleAccept(key, selector);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">                    handleRead(key);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleAccept</span><span class="params">(SelectionKey key, Selector selector)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ServerSocketChannel</span> <span class="variable">serverChannel</span> <span class="operator">=</span> (ServerSocketChannel) key.channel();</span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">clientChannel</span> <span class="operator">=</span> serverChannel.accept();</span><br><span class="line">        clientChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        clientChannel.register(selector, SelectionKey.OP_READ);</span><br><span class="line">        System.out.println(<span class="string">&quot;Accepted connection from &quot;</span> + clientChannel.getRemoteAddress());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleRead</span><span class="params">(SelectionKey key)</span> &#123;</span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">clientChannel</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">bytesRead</span> <span class="operator">=</span> clientChannel.read(buffer);</span><br><span class="line">            <span class="keyword">if</span> (bytesRead == -<span class="number">1</span>) &#123;</span><br><span class="line">                clientChannel.close();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            buffer.flip();</span><br><span class="line">            <span class="type">String</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(buffer.array(), <span class="number">0</span>, buffer.limit());</span><br><span class="line">            System.out.println(<span class="string">&quot;Received request: \n&quot;</span> + request);</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">fileContent</span> <span class="operator">=</span> readFileContent(FILE_PATH);</span><br><span class="line">            <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> constructHttpResponse(fileContent);</span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">responseBuffer</span> <span class="operator">=</span> ByteBuffer.wrap(response.getBytes());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (responseBuffer.hasRemaining()) &#123;</span><br><span class="line">                clientChannel.write(responseBuffer);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            clientChannel.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Error handling client request: &quot;</span> + e.getMessage());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                clientChannel.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">                System.err.println(<span class="string">&quot;Error closing client connection: &quot;</span> + ex.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">constructHttpResponse</span><span class="params">(String bodyContent)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">headers</span> <span class="operator">=</span> constructHttpHeaders(bodyContent.length());</span><br><span class="line">        <span class="keyword">return</span> headers + bodyContent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">constructHttpHeaders</span><span class="params">(<span class="type">int</span> contentLength)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;HTTP/1.1 200 OK\r\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;Content-Type: text/plain\r\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;Content-Length: &quot;</span> + contentLength + <span class="string">&quot;\r\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">readFileContent</span><span class="params">(String filePath)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Path</span> <span class="variable">path</span> <span class="operator">=</span> Paths.get(filePath);</span><br><span class="line">            <span class="keyword">return</span> Files.readString(path);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Error reading file: &quot;</span> + e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;File not found or error reading file.&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/../images/java/netty23.png" alt="netty"></p>
<p><img src="/../images/java/netty24.png" alt="netty"></p>
<h3 id="零拷贝技术"><a href="#零拷贝技术" class="headerlink" title="零拷贝技术"></a>零拷贝技术</h3><p>现在代码中读取文件内容在返回的过程如下图所示。可以看到一共有7步，有多次IO，而且内存里面有两份一样的数据，空间占用大。</p>
<p><img src="/../images/java/netty25.png" alt="netty"></p>
<p>零拷贝是操作系统提供的一种技术，操作系统提供了一个函数，通过这个函数就可以实现零拷贝，看一下零拷贝的过程吧。</p>
<p>零拷贝可以减少IO操作次数，减少内存空间占用，内存里面实际上只有一份内容，网络发送读取的就是那个内容。没有发送内存拷贝动作。</p>
<p><img src="/../images/java/netty26.png" alt="netty"></p>
<p>用零拷贝技术重写代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Path;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NIOZeroCopyHttpServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PORT</span> <span class="operator">=</span> <span class="number">8888</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FILE_PATH</span> <span class="operator">=</span> <span class="string">&quot;HelloWorld.java&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">NIOZeroCopyHttpServer</span>().start();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Server error: &quot;</span> + e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br><span class="line">        <span class="type">ServerSocketChannel</span> <span class="variable">serverChannel</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">        serverChannel.bind(<span class="keyword">new</span> <span class="title class_">java</span>.net.InetSocketAddress(PORT));</span><br><span class="line">        serverChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        serverChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;Server started on port &quot;</span> + PORT);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            selector.select();</span><br><span class="line">            Set&lt;SelectionKey&gt; selectedKeys = selector.selectedKeys();</span><br><span class="line">            Iterator&lt;SelectionKey&gt; keyIterator = selectedKeys.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (keyIterator.hasNext()) &#123;</span><br><span class="line">                <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> keyIterator.next();</span><br><span class="line">                keyIterator.remove();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line">                    handleAccept(key, selector);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">                    handleRead(key);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleAccept</span><span class="params">(SelectionKey key, Selector selector)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ServerSocketChannel</span> <span class="variable">serverChannel</span> <span class="operator">=</span> (ServerSocketChannel) key.channel();</span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">clientChannel</span> <span class="operator">=</span> serverChannel.accept();</span><br><span class="line">        clientChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        clientChannel.register(selector, SelectionKey.OP_READ);</span><br><span class="line">        System.out.println(<span class="string">&quot;Accepted connection from &quot;</span> + clientChannel.getRemoteAddress());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleRead</span><span class="params">(SelectionKey key)</span> &#123;</span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">clientChannel</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">bytesRead</span> <span class="operator">=</span> clientChannel.read(buffer);</span><br><span class="line">            <span class="keyword">if</span> (bytesRead == -<span class="number">1</span>) &#123;</span><br><span class="line">                clientChannel.close();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            buffer.flip();</span><br><span class="line">            <span class="type">String</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(buffer.array(), <span class="number">0</span>, buffer.limit());</span><br><span class="line">            System.out.println(<span class="string">&quot;Received request: \n&quot;</span> + request);</span><br><span class="line"></span><br><span class="line">            sendFileUsingZeroCopy(clientChannel, FILE_PATH);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Error handling client request: &quot;</span> + e.getMessage());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                clientChannel.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">                System.err.println(<span class="string">&quot;Error closing client connection: &quot;</span> + ex.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendFileUsingZeroCopy</span><span class="params">(SocketChannel clientChannel, String filePath)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">FileChannel</span> <span class="variable">fileChannel</span> <span class="operator">=</span> FileChannel.open(Paths.get(filePath))) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">fileSize</span> <span class="operator">=</span> fileChannel.size();</span><br><span class="line">            <span class="type">String</span> <span class="variable">headers</span> <span class="operator">=</span> constructHttpHeaders(fileSize);</span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">headerBuffer</span> <span class="operator">=</span> ByteBuffer.wrap(headers.getBytes());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Write headers first</span></span><br><span class="line">            <span class="keyword">while</span> (headerBuffer.hasRemaining()) &#123;</span><br><span class="line">                clientChannel.write(headerBuffer);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 零拷贝</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">position</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (position &lt; fileSize) &#123;</span><br><span class="line">                position += fileChannel.transferTo(position, fileSize - position, clientChannel);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            clientChannel.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Error sending file: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">constructHttpHeaders</span><span class="params">(<span class="type">long</span> contentLength)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;HTTP/1.1 200 OK\r\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;Content-Type: text/plain\r\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;Content-Length: &quot;</span> + contentLength + <span class="string">&quot;\r\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;Connection: close\r\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次使用wrk压测。可以看到同样30s内，处理了48个请求，吞吐量再次提升。性能更加强大了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Running 30s test @ http://localhost:8888</span><br><span class="line">  10 threads and 10000 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency   100.27ms   64.55ms 208.10ms   72.92%</span><br><span class="line">    Req/Sec    36.45     88.79   303.00     90.91%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%   62.63ms</span><br><span class="line">     75%  200.92ms</span><br><span class="line">     90%  204.08ms</span><br><span class="line">     99%  208.10ms</span><br><span class="line">  48 requests in 30.10s, 9.66KB read</span><br><span class="line">  Socket errors: connect 7967, read 195016, write 3, timeout 0</span><br><span class="line">Requests/sec:      1.59</span><br><span class="line">Transfer/sec:     328.50B</span><br></pre></td></tr></table></figure>

<p><img src="/../images/java/netty27.png" alt="netty"></p>
<h3 id="零拷贝-线程池"><a href="#零拷贝-线程池" class="headerlink" title="零拷贝+线程池"></a>零拷贝+线程池</h3><p>小白又给代码加上了线程池。代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NIOThreadZeroCopyHttpServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PORT</span> <span class="operator">=</span> <span class="number">8888</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FILE_PATH</span> <span class="operator">=</span> <span class="string">&quot;HelloWorld.java&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">THREAD_POOL_SIZE</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(THREAD_POOL_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">NIOThreadZeroCopyHttpServer</span>().start();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Server error: &quot;</span> + e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br><span class="line">        <span class="type">ServerSocketChannel</span> <span class="variable">serverChannel</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">        serverChannel.bind(<span class="keyword">new</span> <span class="title class_">java</span>.net.InetSocketAddress(PORT));</span><br><span class="line">        serverChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        serverChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;Server started on port &quot;</span> + PORT);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            selector.select(); <span class="comment">// Block until events are available</span></span><br><span class="line">            Set&lt;SelectionKey&gt; selectedKeys = selector.selectedKeys();</span><br><span class="line">            Iterator&lt;SelectionKey&gt; keyIterator = selectedKeys.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (keyIterator.hasNext()) &#123;</span><br><span class="line">                <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> keyIterator.next();</span><br><span class="line">                keyIterator.remove(); <span class="comment">// Ensure key is removed to prevent re-processing</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!key.isValid()) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>; <span class="comment">// Skip invalid keys</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line">                        handleAccept(key, selector);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (CancelledKeyException e) &#123;</span><br><span class="line">                    System.err.println(<span class="string">&quot;CancelledKeyException: &quot;</span> + e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleAccept</span><span class="params">(SelectionKey key, Selector selector)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ServerSocketChannel</span> <span class="variable">serverChannel</span> <span class="operator">=</span> (ServerSocketChannel) key.channel();</span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">clientChannel</span> <span class="operator">=</span> serverChannel.accept();</span><br><span class="line">        clientChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        clientChannel.setOption(java.net.StandardSocketOptions.TCP_NODELAY, <span class="literal">true</span>);</span><br><span class="line">        clientChannel.register(selector, SelectionKey.OP_READ);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;Accepted connection from &quot;</span> + clientChannel.getRemoteAddress());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Submit task to thread pool for processing</span></span><br><span class="line">        threadPool.submit(() -&gt; handleRequest(clientChannel));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleRequest</span><span class="params">(SocketChannel clientChannel)</span> &#123;</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">bytesRead</span> <span class="operator">=</span> clientChannel.read(buffer);</span><br><span class="line">            <span class="keyword">if</span> (bytesRead == -<span class="number">1</span>) &#123;</span><br><span class="line">                clientChannel.close();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            buffer.flip();</span><br><span class="line">            <span class="type">String</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(buffer.array(), <span class="number">0</span>, buffer.limit());</span><br><span class="line">            System.out.println(<span class="string">&quot;Received request: \n&quot;</span> + request);</span><br><span class="line"></span><br><span class="line">            sendFileUsingZeroCopy(clientChannel, FILE_PATH);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Error handling client request: &quot;</span> + e.getMessage());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                clientChannel.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">                System.err.println(<span class="string">&quot;Error closing client connection: &quot;</span> + ex.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendFileUsingZeroCopy</span><span class="params">(SocketChannel clientChannel, String filePath)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">FileChannel</span> <span class="variable">fileChannel</span> <span class="operator">=</span> FileChannel.open(Paths.get(filePath))) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">fileSize</span> <span class="operator">=</span> fileChannel.size();</span><br><span class="line">            <span class="type">String</span> <span class="variable">headers</span> <span class="operator">=</span> constructHttpHeaders(fileSize);</span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">headerBuffer</span> <span class="operator">=</span> ByteBuffer.wrap(headers.getBytes());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Write headers first</span></span><br><span class="line">            <span class="keyword">while</span> (headerBuffer.hasRemaining()) &#123;</span><br><span class="line">                clientChannel.write(headerBuffer);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Use zero-copy to send file content</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">position</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (position &lt; fileSize) &#123;</span><br><span class="line">                position += fileChannel.transferTo(position, fileSize - position, clientChannel);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            clientChannel.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Error sending file: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">constructHttpHeaders</span><span class="params">(<span class="type">long</span> contentLength)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;HTTP/1.1 200 OK\r\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;Content-Type: text/plain\r\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;Content-Length: &quot;</span> + contentLength + <span class="string">&quot;\r\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;Connection: close\r\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>压测结果如下,整体性能有明显提升</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Running 30s test @ http://localhost:8888</span><br><span class="line">  10 threads and 10000 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency     7.64ms    8.85ms  27.32ms   82.47%</span><br><span class="line">    Req/Sec   113.30     99.51   300.00     80.00%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%    2.09ms</span><br><span class="line">     75%   13.33ms</span><br><span class="line">     90%   23.46ms</span><br><span class="line">     99%   27.32ms</span><br><span class="line">  113 requests in 30.10s, 22.73KB read</span><br><span class="line">  Socket errors: connect 7967, read 191435, write 12, timeout 0</span><br><span class="line">Requests/sec:      3.75</span><br><span class="line">Transfer/sec:     773.29B</span><br></pre></td></tr></table></figure>

<p><img src="/../images/java/netty28.png" alt="netty"></p>
<p><img src="/../images/java/netty29.png" alt="netty"></p>
<h3 id="BOSS-Worker模式"><a href="#BOSS-Worker模式" class="headerlink" title="BOSS-Worker模式"></a>BOSS-Worker模式</h3><p>之前的代码里面，Worker线程接收到请求以后进行工作，这个时候就会占用这个请求连接，在工作。就相当于干了两份活</p>
<ul>
<li>接收请求</li>
<li>处理任务</li>
</ul>
<p>将这两个活，分给两个人，就能提升效率，BOSS线程池仅仅接收请求，再把请求分配给Worker线程，Worker线程仅仅需要处理任务。还有一个好处就是，BOSS可以有多个，比如多个领导负责分配任务。</p>
<p>新的代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NIOBossWorkerHttpServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PORT</span> <span class="operator">=</span> <span class="number">8888</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">BUFFER_SIZE</span> <span class="operator">=</span> <span class="number">1024</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">BOSS_THREAD_COUNT</span> <span class="operator">=</span> <span class="number">1</span>;  <span class="comment">// Boss 线程数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">WORKER_THREAD_COUNT</span> <span class="operator">=</span> <span class="number">10</span>; <span class="comment">// Worker 线程数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FILE_PATH</span> <span class="operator">=</span> <span class="string">&quot;HelloWorld.java&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// Boss 线程池</span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">bossThreadPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(BOSS_THREAD_COUNT);</span><br><span class="line">        <span class="comment">// Worker 线程池</span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">workerThreadPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(WORKER_THREAD_COUNT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建一个主选择器（Boss Selector）</span></span><br><span class="line">        <span class="type">Selector</span> <span class="variable">bossSelector</span> <span class="operator">=</span> Selector.open();</span><br><span class="line">        <span class="type">ServerSocketChannel</span> <span class="variable">serverChannel</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">        serverChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        serverChannel.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(PORT));</span><br><span class="line">        serverChannel.register(bossSelector, SelectionKey.OP_ACCEPT);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;HTTP Server started on port &quot;</span> + PORT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Boss 线程负责分发连接</span></span><br><span class="line">        bossThreadPool.submit(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    bossSelector.select(); <span class="comment">// 等待事件</span></span><br><span class="line">                    Iterator&lt;SelectionKey&gt; iterator = bossSelector.selectedKeys().iterator();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                        <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">                        iterator.remove();</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line">                            <span class="type">SocketChannel</span> <span class="variable">clientChannel</span> <span class="operator">=</span> serverChannel.accept();</span><br><span class="line">                            clientChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">                            System.out.println(<span class="string">&quot;Accepted new connection: &quot;</span> + clientChannel.getRemoteAddress());</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// 将新连接交给 Worker 线程池处理</span></span><br><span class="line">                            workerThreadPool.submit(() -&gt; handleClient(clientChannel));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                System.err.println(<span class="string">&quot;Error in Boss thread: &quot;</span> + e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Worker 线程处理客户端连接的读写操作</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handleClient</span><span class="params">(SocketChannel clientChannel)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Selector</span> <span class="variable">workerSelector</span> <span class="operator">=</span> Selector.open()) &#123;</span><br><span class="line">            clientChannel.register(workerSelector, SelectionKey.OP_READ);</span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(BUFFER_SIZE);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (clientChannel.isOpen()) &#123;</span><br><span class="line">                workerSelector.select(); <span class="comment">// 等待事件</span></span><br><span class="line">                Iterator&lt;SelectionKey&gt; iterator = workerSelector.selectedKeys().iterator();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                    <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">                    iterator.remove();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">                        <span class="type">SocketChannel</span> <span class="variable">channel</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">                        buffer.clear();</span><br><span class="line">                        <span class="type">int</span> <span class="variable">bytesRead</span> <span class="operator">=</span> channel.read(buffer);</span><br><span class="line">                        <span class="keyword">if</span> (bytesRead == -<span class="number">1</span>) &#123;</span><br><span class="line">                            closeChannel(channel);</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 请求解析 (这里只简单返回文件内容作为响应)</span></span><br><span class="line">                        buffer.flip();</span><br><span class="line">                        sendFile(channel, FILE_PATH);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Error in Worker thread: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            closeChannel(clientChannel);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用零拷贝技术发送文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sendFile</span><span class="params">(SocketChannel clientChannel, String filePath)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">FileChannel</span> <span class="variable">fileChannel</span> <span class="operator">=</span> FileChannel.open(Paths.get(filePath))) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">fileSize</span> <span class="operator">=</span> fileChannel.size();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 构造 HTTP 响应头</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="string">&quot;HTTP/1.1 200 OK\r\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;Content-Type: text/plain\r\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;Content-Length: &quot;</span> + fileSize + <span class="string">&quot;\r\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">headerBuffer</span> <span class="operator">=</span> ByteBuffer.wrap(headers.getBytes());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 发送响应头</span></span><br><span class="line">            <span class="keyword">while</span> (headerBuffer.hasRemaining()) &#123;</span><br><span class="line">                clientChannel.write(headerBuffer);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 使用零拷贝发送文件内容</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">position</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (position &lt; fileSize) &#123;</span><br><span class="line">                position += fileChannel.transferTo(position, fileSize - position, clientChannel);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;File sent successfully to: &quot;</span> + clientChannel.getRemoteAddress());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Error sending file: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭通道</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">closeChannel</span><span class="params">(Channel channel)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (channel != <span class="literal">null</span> &amp;&amp; channel.isOpen()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                channel.close();</span><br><span class="line">                System.out.println(<span class="string">&quot;Channel closed.&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                System.err.println(<span class="string">&quot;Error closing channel: &quot;</span> + e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当BOSS数量为1个的时候，压测结果。可以看到吞吐量大大提升了一波。整体性能更好了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Running 30s test @ http://localhost:8888</span><br><span class="line">  10 threads and 10000 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency   326.78ms   66.97ms   1.18s    95.07%</span><br><span class="line">    Req/Sec     7.73      9.44    40.00     87.74%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%  310.27ms</span><br><span class="line">     75%  340.00ms</span><br><span class="line">     90%  369.37ms</span><br><span class="line">     99%  488.59ms</span><br><span class="line">  912 requests in 30.10s, 166.80KB read</span><br><span class="line">  Socket errors: connect 7967, read 187538, write 0, timeout 0</span><br><span class="line">Requests/sec:     30.30</span><br><span class="line">Transfer/sec:      5.54KB</span><br></pre></td></tr></table></figure>

<p>当BOSS数量为4个的时候，压测结果，能看到性能再次提升了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Running 30s test @ http://localhost:8888</span><br><span class="line">  10 threads and 10000 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency   221.00ms   25.30ms 331.05ms   85.11%</span><br><span class="line">    Req/Sec    23.14     14.81    70.00     50.55%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%  211.31ms</span><br><span class="line">     75%  226.24ms</span><br><span class="line">     90%  257.96ms</span><br><span class="line">     99%  297.11ms</span><br><span class="line">  1350 requests in 30.10s, 246.66KB read</span><br><span class="line">  Socket errors: connect 7967, read 242633, write 0, timeout 0</span><br><span class="line">Requests/sec:     44.85</span><br><span class="line">Transfer/sec:      8.19KB</span><br></pre></td></tr></table></figure>


<p><img src="/../images/java/netty20.png" alt="netty"></p>
<p><img src="/../images/java/netty21.png" alt="netty"></p>
<p><img src="/../images/java/netty30.png" alt="netty"></p>
<h3 id="netty-1"><a href="#netty-1" class="headerlink" title="netty"></a>netty</h3><p>Netty是一个NIO客户端服务器框架，可以快速轻松地开发网络应用程序，例如协议服务器和客户端。它极大地简化了网络编程，如TCP和UDP套接字服务器。</p>
<p>netty就是基于上述的网络编程实现的，区别就是netty封装的更好，更完善，做了一些优化，支持了更多的协议。参考netty官网的架构图。</p>
<p>可以看到支持TCP、UDP, 支持大文件传输，支持压缩，支持HTTP、HTTPS、SMTP邮件、Google Protobuf一般用来实现RPC，通过事件模型实现，还实现了零拷贝技术。</p>
<p><img src="/../images/java/netty22.png" alt="netty"></p>
<h4 id="如何使用netty来实现上面的服务器"><a href="#如何使用netty来实现上面的服务器" class="headerlink" title="如何使用netty来实现上面的服务器"></a>如何使用netty来实现上面的服务器</h4><p>通过netty实现的话，代码简单了很多，只需要关注读取文件并返回给客户端这个逻辑就可以了。但是其根本模型没有变化，比如BOSS和Worker，还有零拷贝，线程池，NIO技术，这些是netty的核心，他只是增加了更多的逻辑，支持，优化等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.ServerBootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.Unpooled;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.*;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.*;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.stream.ChunkedWriteHandler;</span><br><span class="line"><span class="keyword">import</span> io.netty.util.CharsetUtil;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PORT</span> <span class="operator">=</span> <span class="number">8888</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// Boss 线程池: 接收客户端连接</span></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// Worker 线程池: 处理 I/O 操作</span></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 创建 ServerBootstrap</span></span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            b.group(bossGroup, workerGroup)</span><br><span class="line">                    .channel(io.netty.channel.socket.nio.NioServerSocketChannel.class)</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;Channel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(Channel ch)</span> &#123;</span><br><span class="line">                            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">HttpServerCodec</span>()); <span class="comment">// HTTP 编解码</span></span><br><span class="line">                            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">HttpObjectAggregator</span>(<span class="number">65536</span>)); <span class="comment">// 处理 HTTP 请求体</span></span><br><span class="line">                            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ChunkedWriteHandler</span>()); <span class="comment">// 支持大文件传输</span></span><br><span class="line">                            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">HelloWorldServerHandler</span>()); <span class="comment">// 自定义处理逻辑</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 绑定端口并启动</span></span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">f</span> <span class="operator">=</span> b.bind(PORT).sync();</span><br><span class="line">            System.out.println(<span class="string">&quot;Server started on port 8888...&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 等待服务器关闭</span></span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HelloWorldServerHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;FullHttpRequest&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, FullHttpRequest msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 读取文件内容</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;./HelloWorld.java&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (file.exists()) &#123;</span><br><span class="line">            <span class="type">byte</span>[] fileContent = Files.readAllBytes(file.toPath());</span><br><span class="line">            <span class="type">FullHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(HttpVersion.HTTP_1_1, HttpResponseStatus.OK,</span><br><span class="line">                    Unpooled.copiedBuffer(fileContent));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 设置响应头</span></span><br><span class="line">            response.headers().set(HttpHeaders.Names.CONTENT_TYPE, <span class="string">&quot;text/plain; charset=UTF-8&quot;</span>);</span><br><span class="line">            response.headers().set(HttpHeaders.Names.CONTENT_LENGTH, response.content().readableBytes());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 发送响应</span></span><br><span class="line">            ctx.writeAndFlush(response).addListener(ChannelFutureListener.CLOSE);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 文件不存在时返回 404</span></span><br><span class="line">            <span class="type">FullHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(HttpVersion.HTTP_1_1, HttpResponseStatus.NOT_FOUND,</span><br><span class="line">                    Unpooled.copiedBuffer(<span class="string">&quot;File Not Found&quot;</span>.getBytes(CharsetUtil.UTF_8)));</span><br><span class="line"></span><br><span class="line">            response.headers().set(HttpHeaders.Names.CONTENT_TYPE, <span class="string">&quot;text/plain; charset=UTF-8&quot;</span>);</span><br><span class="line">            response.headers().set(HttpHeaders.Names.CONTENT_LENGTH, response.content().readableBytes());</span><br><span class="line"></span><br><span class="line">            ctx.writeAndFlush(response).addListener(ChannelFutureListener.CLOSE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>压测结果，性能很高。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Running 30s test @ http://localhost:8888</span><br><span class="line">  10 threads and 10000 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency     8.39ms   12.28ms 113.55ms   92.66%</span><br><span class="line">    Req/Sec   192.24    343.10     2.51k    88.08%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%    4.41ms</span><br><span class="line">     75%    9.55ms</span><br><span class="line">     90%   17.22ms</span><br><span class="line">     99%   72.18ms</span><br><span class="line">  15693 requests in 30.10s, 3.02MB read</span><br><span class="line">  Socket errors: connect 7967, read 22110, write 1, timeout 0</span><br><span class="line">Requests/sec:    521.32</span><br><span class="line">Transfer/sec:    102.84KB</span><br></pre></td></tr></table></figure>

<h4 id="并发测试对比"><a href="#并发测试对比" class="headerlink" title="并发测试对比"></a>并发测试对比</h4><p>上面都是10个线程并发10000测试的结果。我们现在改成并发1000，再做个对比。</p>
<p>netty实现的压测结果，和10000没什么区别</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Running 30s test @ http://localhost:8888</span><br><span class="line">  10 threads and 1000 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency    94.20ms  178.90ms 896.17ms   86.02%</span><br><span class="line">    Req/Sec   324.69    443.24     2.20k    85.19%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%   10.05ms</span><br><span class="line">     75%   49.68ms</span><br><span class="line">     90%  365.89ms</span><br><span class="line">     99%  724.64ms</span><br><span class="line">  16390 requests in 30.05s, 3.16MB read</span><br><span class="line">  Socket errors: connect 0, read 36092, write 117, timeout 0</span><br><span class="line">Requests/sec:    545.36</span><br><span class="line">Transfer/sec:    107.58KB</span><br></pre></td></tr></table></figure>

<p>我们自己实现的BOSS-Worker代码，压测结果，1000并发的性能提升很明显。因为我们的实现更加原始，而netty的实现更重。更注重高并发，对于低并发而言我们的实现更好，这也说明我们确实实现了netty的核心功能。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Running 30s test @ http://localhost:8888</span><br><span class="line">  10 threads and 1000 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency   205.91us  529.03us  75.25ms   99.30%</span><br><span class="line">    Req/Sec    15.51k     5.85k   25.50k    62.44%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%  177.00us</span><br><span class="line">     75%  207.00us</span><br><span class="line">     90%  245.00us</span><br><span class="line">     99%  518.00us</span><br><span class="line">  1389306 requests in 30.09s, 247.76MB read</span><br><span class="line">  Socket errors: connect 0, read 10787, write 0, timeout 0</span><br><span class="line">Requests/sec:  46169.43</span><br><span class="line">Transfer/sec:      8.23MB</span><br></pre></td></tr></table></figure>

<p>接下来是线程池+NIO+零拷贝的实现压测结果。对于低并发的性能同样很好，但是比BOSS-Worker实现低了很多很多。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Running 30s test @ http://localhost:8888</span><br><span class="line">  10 threads and 1000 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency     7.38ms   13.68ms 201.55ms   91.31%</span><br><span class="line">    Req/Sec   102.92    287.63     2.54k    92.41%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%    3.65ms</span><br><span class="line">     75%    6.38ms</span><br><span class="line">     90%   18.18ms</span><br><span class="line">     99%   68.71ms</span><br><span class="line">  11677 requests in 30.08s, 2.29MB read</span><br><span class="line">  Socket errors: connect 0, read 454831, write 242, timeout 0</span><br><span class="line">Requests/sec:    388.15</span><br><span class="line">Transfer/sec:     78.09KB</span><br></pre></td></tr></table></figure>

<p>接下来试试NIO+零拷贝的实现压测结果。可以看到结果也很棒</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Running 30s test @ http://localhost:8888</span><br><span class="line">  10 threads and 1000 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency     4.49ms    9.53ms 178.38ms   93.80%</span><br><span class="line">    Req/Sec   127.52    313.84     2.42k    91.95%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%    2.21ms</span><br><span class="line">     75%    4.10ms</span><br><span class="line">     90%    8.91ms</span><br><span class="line">     99%   41.68ms</span><br><span class="line">  13680 requests in 30.06s, 2.69MB read</span><br><span class="line">  Socket errors: connect 0, read 80895, write 7, timeout 0</span><br><span class="line">Requests/sec:    455.12</span><br><span class="line">Transfer/sec:     91.56KB</span><br></pre></td></tr></table></figure>

<p>再看看NIO的实现压测结果，因为没有零拷贝，所以执行时间增加了很多。尤其是最大延迟，吞吐量也有降低。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Running 30s test @ http://localhost:8888</span><br><span class="line">  10 threads and 1000 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency     8.24ms   27.62ms 675.49ms   96.24%</span><br><span class="line">    Req/Sec   125.39    301.56     3.01k    91.31%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%    2.22ms</span><br><span class="line">     75%    9.52ms</span><br><span class="line">     90%   24.23ms</span><br><span class="line">     99%   45.71ms</span><br><span class="line">  11657 requests in 30.10s, 2.08MB read</span><br><span class="line">  Socket errors: connect 0, read 87555, write 1308, timeout 0</span><br><span class="line">Requests/sec:    387.33</span><br><span class="line">Transfer/sec:     70.73KB</span><br></pre></td></tr></table></figure>

<p>最后看看BIO的实现吧。可以看到吞吐量还是低了不少的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Running 30s test @ http://localhost:8888</span><br><span class="line">  10 threads and 1000 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency    55.22ms   48.14ms 181.62ms   65.71%</span><br><span class="line">    Req/Sec    83.94    221.86     1.33k    93.39%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%   48.44ms</span><br><span class="line">     75%   68.44ms</span><br><span class="line">     90%  153.94ms</span><br><span class="line">     99%  170.59ms</span><br><span class="line">  5304 requests in 30.09s, 1.08MB read</span><br><span class="line">  Socket errors: connect 0, read 60714, write 723, timeout 0</span><br><span class="line">Requests/sec:    176.29</span><br><span class="line">Transfer/sec:     36.67KB</span><br></pre></td></tr></table></figure>

<p>整体总结而言，主要的提升手段是NIO和BOSS-Worker模型，零拷贝也有一定的性能提升。</p>
<p><img src="/../images/java/netty31.png" alt="netty"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://thepatterraining.github.io/%E6%88%91%E6%98%AF%E5%A6%82%E4%BD%95%E4%B8%80%E4%B8%AA%E5%B0%8F%E6%97%B6%E6%95%99%E4%BC%9A%E5%B0%8F%E7%99%BD%E6%89%8B%E5%86%99%E7%BD%91%E5%85%B3%E7%9A%84%20copy.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpeg">
      <meta itemprop="name" content="Thepatter">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/%E6%88%91%E6%98%AF%E5%A6%82%E4%BD%95%E4%B8%80%E4%B8%AA%E5%B0%8F%E6%97%B6%E6%95%99%E4%BC%9A%E5%B0%8F%E7%99%BD%E6%89%8B%E5%86%99%E7%BD%91%E5%85%B3%E7%9A%84%20copy.html" class="post-title-link" itemprop="url">黄子韬送车，抖音却出现bug了，又有一个人的年终奖泡汤了</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-12-15 10:12:47" itemprop="dateCreated datePublished" datetime="2024-12-15T10:12:47+08:00">2024-12-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-02-17 10:21:34" itemprop="dateModified" datetime="2025-02-17T10:21:34+08:00">2025-02-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
            </span>

          
            <span id="/%E6%88%91%E6%98%AF%E5%A6%82%E4%BD%95%E4%B8%80%E4%B8%AA%E5%B0%8F%E6%97%B6%E6%95%99%E4%BC%9A%E5%B0%8F%E7%99%BD%E6%89%8B%E5%86%99%E7%BD%91%E5%85%B3%E7%9A%84%20copy.html" class="post-meta-item leancloud_visitors" data-flag-title="黄子韬送车，抖音却出现bug了，又有一个人的年终奖泡汤了" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/%E6%88%91%E6%98%AF%E5%A6%82%E4%BD%95%E4%B8%80%E4%B8%AA%E5%B0%8F%E6%97%B6%E6%95%99%E4%BC%9A%E5%B0%8F%E7%99%BD%E6%89%8B%E5%86%99%E7%BD%91%E5%85%B3%E7%9A%84%20copy.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/%E6%88%91%E6%98%AF%E5%A6%82%E4%BD%95%E4%B8%80%E4%B8%AA%E5%B0%8F%E6%97%B6%E6%95%99%E4%BC%9A%E5%B0%8F%E7%99%BD%E6%89%8B%E5%86%99%E7%BD%91%E5%85%B3%E7%9A%84%20copy.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="黄子韬送车，抖音却出现bug了，又有一个人的年终奖泡汤了"><a href="#黄子韬送车，抖音却出现bug了，又有一个人的年终奖泡汤了" class="headerlink" title="黄子韬送车，抖音却出现bug了，又有一个人的年终奖泡汤了"></a>黄子韬送车，抖音却出现bug了，又有一个人的年终奖泡汤了</h1><p>1月10日下午4点，黄子韬发布视频，称晚上7点将直播送车，并再次声明规则：“你只要来了都可以参与。”此前，黄子韬曾在直播中承诺，其短视频账号超过1500万粉丝将赠送国产汽车10台。消息一出，黄子韬的评论区立马成为了网友的许愿池，大家纷纷在评论区留言自己想要的车型。</p>
<p>当晚，黄子稻进行直播，在线观看人数达到了1100多万人，点赞数更是爆了！</p>
<h2 id="抖音重大bug"><a href="#抖音重大bug" class="headerlink" title="抖音重大bug"></a>抖音重大bug</h2><p>点赞数持续上涨，最终更是超过了Int的最大值<code>2147483647</code>。也就是超过了2<sup>31</sup> - 1。</p>
<p>接下来，神奇的一幕发生了，点赞数变成了负数！</p>
<p><img src="/../images/1736676504909.jpg" alt="list1.png"></p>
<p>大家知道这是怎么回事吗？</p>
<p>在Java中，只存在有符号整数，而没有无符号整数。具体各个类型的大小如下表所示。</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>最小值</th>
<th>最大值</th>
</tr>
</thead>
<tbody><tr>
<td>byte</td>
<td>-128</td>
<td>127</td>
</tr>
<tr>
<td>short</td>
<td>-32768</td>
<td>32767</td>
</tr>
<tr>
<td>int</td>
<td>-2147483648</td>
<td>2147483647</td>
</tr>
<tr>
<td>long</td>
<td>-9223372036854775808</td>
<td>9223372036854775807</td>
</tr>
</tbody></table>
<p>什么是<code>有符号整数</code>和<code>无符号整数</code>呢？</p>
<h2 id="有符号整数（Signed-Integer）"><a href="#有符号整数（Signed-Integer）" class="headerlink" title="有符号整数（Signed Integer）"></a>有符号整数（Signed Integer）</h2><p>有符号整数是指可以表示正数、负数和零的整数类型。在计算机中，有符号整数通常使用最高位（即最左边的位）作为符号位来表示正负。最高位为0表示正数，最高位为1表示负数。</p>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><h4 id="8位有符号整数（byte）"><a href="#8位有符号整数（byte）" class="headerlink" title="8位有符号整数（byte）"></a>8位有符号整数（byte）</h4><p>范围：-128 到 127<br>二进制表示：<br>0000 0000 表示 0<br>0000 0001 表示 1<br>0111 1111 表示 127<br>1000 0000 表示 -128<br>1000 0001 表示 -127<br>1111 1111 表示 -1</p>
<h4 id="32位有符号整数（int）"><a href="#32位有符号整数（int）" class="headerlink" title="32位有符号整数（int）"></a>32位有符号整数（int）</h4><p>范围：-2,147,483,648 到 2,147,483,647<br>二进制表示：<br>0000 0000 0000 0000 0000 0000 0000 0000 表示 0<br>0000 0000 0000 0000 0000 0000 0000 0001 表示 1<br>0111 1111 1111 1111 1111 1111 1111 1111 表示 2,147,483,647<br>1000 0000 0000 0000 0000 0000 0000 0000 表示 -2,147,483,648<br>1000 0000 0000 0000 0000 0000 0000 0001 表示 -2,147,483,647<br>1111 1111 1111 1111 1111 1111 1111 1111 表示 -1</p>
<h2 id="无符号整数（Unsigned-Integer）"><a href="#无符号整数（Unsigned-Integer）" class="headerlink" title="无符号整数（Unsigned Integer）"></a>无符号整数（Unsigned Integer）</h2><p>无符号整数是指只能表示非负数（即零和正数）的整数类型。无符号整数没有符号位，所有位都用于表示数值，因此其范围是从0到最大值。</p>
<h3 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h3><h4 id="8位无符号整数"><a href="#8位无符号整数" class="headerlink" title="8位无符号整数"></a>8位无符号整数</h4><p>范围：0 到 255<br>二进制表示：<br>0000 0000 表示 0<br>0000 0001 表示 1<br>0111 1111 表示 127<br>1000 0000 表示 128<br>1111 1111 表示 255</p>
<h4 id="32位无符号整数"><a href="#32位无符号整数" class="headerlink" title="32位无符号整数"></a>32位无符号整数</h4><p>范围：0 到 4,294,967,295<br>二进制表示：<br>0000 0000 0000 0000 0000 0000 0000 0000 表示 0<br>0000 0000 0000 0000 0000 0000 0000 0001 表示 1<br>0111 1111 1111 1111 1111 1111 1111 1111 表示 2,147,483,647<br>1000 0000 0000 0000 0000 0000 0000 0000 表示 2,147,483,648<br>1111 1111 1111 1111 1111 1111 1111 1111 表示 4,294,967,295</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>有符号整数</th>
<th>无符号整数</th>
</tr>
</thead>
<tbody><tr>
<td><strong>范围</strong></td>
<td>包含负数、零和正数</td>
<td>只包含零和正数</td>
</tr>
<tr>
<td><strong>最高位</strong></td>
<td>用于表示符号</td>
<td>用于表示数值</td>
</tr>
<tr>
<td><strong>8位</strong></td>
<td>-128 到 127</td>
<td>0 到 255</td>
</tr>
<tr>
<td><strong>16位</strong></td>
<td>-32768 到 32767</td>
<td>0 到 65535</td>
</tr>
<tr>
<td><strong>32位</strong></td>
<td>-2,147,483,648 到 2,147,483,647</td>
<td>0 到 4,294,967,295</td>
</tr>
<tr>
<td><strong>64位</strong></td>
<td>-9,223,372,036,854,775,808 到 9,223,372,036,854,775,807</td>
<td>0 到 18,446,744,073,709,551,615</td>
</tr>
</tbody></table>
<p>在Java中，没有原生的无符号整数类型，但可以使用BigInteger类来模拟无符号整数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.math.BigInteger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IntegerExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 有符号整数</span></span><br><span class="line">        <span class="type">byte</span> <span class="variable">signedByte</span> <span class="operator">=</span> <span class="number">127</span>;</span><br><span class="line">        <span class="type">short</span> <span class="variable">signedShort</span> <span class="operator">=</span> <span class="number">32767</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">signedInt</span> <span class="operator">=</span> <span class="number">2147483647</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">signedLong</span> <span class="operator">=</span> <span class="number">9223372036854775807L</span>;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;有符号 byte 最大值: &quot;</span> + signedByte);</span><br><span class="line">        System.out.println(<span class="string">&quot;有符号 short 最大值: &quot;</span> + signedShort);</span><br><span class="line">        System.out.println(<span class="string">&quot;有符号 int 最大值: &quot;</span> + signedInt);</span><br><span class="line">        System.out.println(<span class="string">&quot;有符号 long 最大值: &quot;</span> + signedLong);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 无符号整数（使用 BigInteger 模拟）</span></span><br><span class="line">        <span class="type">BigInteger</span> <span class="variable">unsignedByte</span> <span class="operator">=</span> BigInteger.valueOf(<span class="number">255</span>);</span><br><span class="line">        <span class="type">BigInteger</span> <span class="variable">unsignedShort</span> <span class="operator">=</span> BigInteger.valueOf(<span class="number">65535</span>);</span><br><span class="line">        <span class="type">BigInteger</span> <span class="variable">unsignedInt</span> <span class="operator">=</span> BigInteger.valueOf(<span class="number">4294967295L</span>);</span><br><span class="line">        <span class="type">BigInteger</span> <span class="variable">unsignedLong</span> <span class="operator">=</span> BigInteger.valueOf(<span class="number">18446744073709551615L</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;无符号 byte 最大值: &quot;</span> + unsignedByte);</span><br><span class="line">        System.out.println(<span class="string">&quot;无符号 short 最大值: &quot;</span> + unsignedShort);</span><br><span class="line">        System.out.println(<span class="string">&quot;无符号 int 最大值: &quot;</span> + unsignedInt);</span><br><span class="line">        System.out.println(<span class="string">&quot;无符号 long 最大值: &quot;</span> + unsignedLong);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">有符号 byte 最大值: 127</span><br><span class="line">有符号 short 最大值: 32767</span><br><span class="line">有符号 int 最大值: 2147483647</span><br><span class="line">有符号 long 最大值: 9223372036854775807</span><br><span class="line">无符号 byte 最大值: 255</span><br><span class="line">无符号 short 最大值: 65535</span><br><span class="line">无符号 int 最大值: 4294967295</span><br><span class="line">无符号 long 最大值: 18446744073709551615</span><br></pre></td></tr></table></figure>

<h2 id="有符号整数溢出"><a href="#有符号整数溢出" class="headerlink" title="有符号整数溢出"></a>有符号整数溢出</h2><p>有符号整数溢出是指在进行算术运算时，结果超出了该整数类型所能表示的范围。由于有符号整数有固定的范围，当运算结果超过这个范围时，就会发生溢出。溢出会导致结果“回绕”到范围的另一端，这可能会导致一些意外的行为。</p>
<p>下图展示了有符号整数的整个范围，将范围看作一个圆，我特意切开了这个圆，左边表示<code>正数</code>，右边表示<code>负数</code>。从这里可以看到，当正数的最大值再加上1，就会变成负数的最大值。</p>
<p><img src="/../images/kepu.png" alt="list1.png"></p>
<p>这个是为什么呢，可以从二进制看到答案。</p>
<p>32位最大值是<code>2147483647</code>，用二进制表示如下,也就是符号为是0表示正数，剩下31位是1.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">01111111111111111111111111111111</span><br></pre></td></tr></table></figure>

<p>这个数再加1是多少呢，二进制加法和十进制加法是一样的，<code>逢2进1</code>。那么一直进位，二进制结果如下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10000000000000000000000000000000</span><br></pre></td></tr></table></figure>

<p>可以看到结果是符号位是1，剩下31位是0.这个结果就是<code>-2147483648</code>。</p>
<h2 id="真实点赞数"><a href="#真实点赞数" class="headerlink" title="真实点赞数"></a>真实点赞数</h2><p>接下来，我们可以算一下，真实的点赞数到底是多少呢？</p>
<p>假设当前的点赞数是<code>-1671321474</code>。</p>
<p>已知：</p>
<ol>
<li>当前是有符号整数</li>
<li>当前是Int类型</li>
<li>当Int类型达到最大值<code>2147483647</code>以后再加1就会溢出。</li>
</ol>
<p>所以真实的点赞数 &#x3D; 0 + Int最大值 + 1（溢出到最小值） + x &#x3D; -1671321474<br>                &#x3D; -2147483648 + x &#x3D; -1671321474</p>
<p>因此 x &#x3D; -1671321474 + 2147483648 &#x3D; 476162174</p>
<p>也就是说真实的点赞数 &#x3D; 2147483647 + 1 + 476162174 &#x3D; 2623645822</p>
<p>也就是26亿。千分位表示：2,623,645,822</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>有人说服务端是好的，只是安卓端的老代码使用的是Int，因此造成了这个Bug，这不就是传说中的屎山代码吗？</p>
<p>也不知道又有哪些人要倒霉的没有年终奖啦，大家也要注意这个问题啊～</p>
<p>我相信最开始的程序员也没有想到一场直播的点赞数能干爆Int吧～</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://thepatterraining.github.io/%E6%88%91%E6%98%AF%E5%A6%82%E4%BD%95%E4%B8%80%E4%B8%AA%E5%B0%8F%E6%97%B6%E6%95%99%E4%BC%9A%E5%B0%8F%E7%99%BD%E6%89%8B%E5%86%99%E7%BD%91%E5%85%B3%E7%9A%84.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpeg">
      <meta itemprop="name" content="Thepatter">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/%E6%88%91%E6%98%AF%E5%A6%82%E4%BD%95%E4%B8%80%E4%B8%AA%E5%B0%8F%E6%97%B6%E6%95%99%E4%BC%9A%E5%B0%8F%E7%99%BD%E6%89%8B%E5%86%99%E7%BD%91%E5%85%B3%E7%9A%84.html" class="post-title-link" itemprop="url">我是如何一个小时教会小白手写网关的</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-12-15 10:12:47" itemprop="dateCreated datePublished" datetime="2024-12-15T10:12:47+08:00">2024-12-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-02-17 10:21:34" itemprop="dateModified" datetime="2025-02-17T10:21:34+08:00">2025-02-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
            </span>

          
            <span id="/%E6%88%91%E6%98%AF%E5%A6%82%E4%BD%95%E4%B8%80%E4%B8%AA%E5%B0%8F%E6%97%B6%E6%95%99%E4%BC%9A%E5%B0%8F%E7%99%BD%E6%89%8B%E5%86%99%E7%BD%91%E5%85%B3%E7%9A%84.html" class="post-meta-item leancloud_visitors" data-flag-title="我是如何一个小时教会小白手写网关的" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/%E6%88%91%E6%98%AF%E5%A6%82%E4%BD%95%E4%B8%80%E4%B8%AA%E5%B0%8F%E6%97%B6%E6%95%99%E4%BC%9A%E5%B0%8F%E7%99%BD%E6%89%8B%E5%86%99%E7%BD%91%E5%85%B3%E7%9A%84.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/%E6%88%91%E6%98%AF%E5%A6%82%E4%BD%95%E4%B8%80%E4%B8%AA%E5%B0%8F%E6%97%B6%E6%95%99%E4%BC%9A%E5%B0%8F%E7%99%BD%E6%89%8B%E5%86%99%E7%BD%91%E5%85%B3%E7%9A%84.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="网关"><a href="#网关" class="headerlink" title="网关"></a>网关</h1><p>今天，小白的老师让小白写一个网关，小白学艺不精，过来向大头求救了。</p>
<p><img src="https://thepatterraining.github.io/images/java/gateway/gateway1.jpg" alt="netty服务器"></p>
<p><img src="https://thepatterraining.github.io/images/java/gateway/gateway2.jpg" alt="netty服务器"></p>
<p><img src="https://thepatterraining.github.io/images/java/gateway/gateway3.jpg" alt="netty服务器"></p>
<p>网关是什么？看图说话，很明显，她是介于<code>客户端</code>和<code>服务器</code>之间的一个中间层。</p>
<p>那么为什么要有网关？</p>
<ul>
<li>网关可以承接更多的流量</li>
<li>网关可以对流量做减法</li>
<li>网关可以添加其他和业务无关的能力，和业务解藕</li>
<li>网关可以实现负载均衡</li>
</ul>
<h2 id="网关可以承接更多的流量"><a href="#网关可以承接更多的流量" class="headerlink" title="网关可以承接更多的流量"></a>网关可以承接更多的流量</h2><p>服务器的逻辑通常是来一个请求A,出现一个A线程进行处理。来一个请求B，出现一个B线程进行处理。</p>
<p>而有了网关就变成了</p>
<ul>
<li>请求A -&gt; 网关main线程 -&gt; 网关worker1线程 -&gt; 服务器A线程</li>
<li>请求B -&gt; 网关main线程 -&gt; 网关worker2线程 -&gt; 服务器B线程</li>
</ul>
<p>为什么能承接更多的流量，因为承接流量的线程，实在Main线程上面，而Main线程，仅仅负责<code>分发请求</code>。所以它很快。</p>
<h2 id="网关可以对流量做减法"><a href="#网关可以对流量做减法" class="headerlink" title="网关可以对流量做减法"></a>网关可以对流量做减法</h2><p>网关就如同一个漏斗，可以对流量做减法。</p>
<p>比如实现限流、权限检查、缓存处理。那么进来的10个请求，可能只有1个请求到达服务器，减轻了服务器的压力。</p>
<p>请求流程如下：</p>
<ul>
<li>请求A -&gt; 网关main线程 -&gt; 网关worker1线程 -&gt; 网关权限检查不通过，返回错误</li>
<li>请求B -&gt; 网关main线程 -&gt; 网关worker2线程 -&gt; 服务器A线程</li>
</ul>
<h2 id="网关可以添加其他和业务无关的能力，和业务解藕"><a href="#网关可以添加其他和业务无关的能力，和业务解藕" class="headerlink" title="网关可以添加其他和业务无关的能力，和业务解藕"></a>网关可以添加其他和业务无关的能力，和业务解藕</h2><p>如同上面说的，网关可以实现一些和业务无关的能力，比如现限流、权限检查、缓存处理。</p>
<p>目前用的最多的网关应该是<code>nginx</code>。nginx可以通过<code>lua</code>来扩展实现一些功能。比如上面说的这些。</p>
<p>还有一些比如像<code>OpenResty</code>这种，也就是基于<code>nginx</code>和<code>lua</code>来进行扩展。</p>
<h2 id="网关可以实现负载均衡"><a href="#网关可以实现负载均衡" class="headerlink" title="网关可以实现负载均衡"></a>网关可以实现负载均衡</h2><p>什么是负载均衡？简单来说就是后端有多个服务器，通过负载均衡可以把请求流量转发给不同的服务器去处理。</p>
<p>这个具体后面会实操讲解。</p>
<h1 id="第一版网关实现"><a href="#第一版网关实现" class="headerlink" title="第一版网关实现"></a>第一版网关实现</h1><p><img src="https://thepatterraining.github.io/images/java/gateway/gateway4.jpg" alt="netty服务器"></p>
<p><img src="https://thepatterraining.github.io/images/java/gateway/gateway5.jpg" alt="netty服务器"></p>
<p>第一版网关的基本原理如上面说的，仅仅是实现了<code>服务器端，也就是Main线程</code>和<code>客户端，也就是Worker线程</code>。</p>
<p>执行流程如下：</p>
<ol>
<li>通过Netty实现一个服务器，接收真正客户端的请求</li>
<li>然后把请求给Worker线程</li>
<li>Worker线程启动一个客户端请求真正的服务器。</li>
<li>Worker线程接收到真正服务器的返回数据。</li>
<li>Worker线程将数据返回给真正的客户端。</li>
</ol>
<p>部分代码如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个netty服务端，接收客户端的请求</span></span><br><span class="line"><span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">1</span>);</span><br><span class="line"><span class="type">EventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 一些参数 初始化</span></span><br><span class="line">    <span class="type">ServerBootstrap</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">    b.option(ChannelOption.SO_BACKLOG, <span class="number">128</span>)</span><br><span class="line">            .childOption(ChannelOption.TCP_NODELAY, <span class="literal">true</span>)</span><br><span class="line">            .childOption(ChannelOption.SO_KEEPALIVE, <span class="literal">true</span>)</span><br><span class="line">            .childOption(ChannelOption.SO_REUSEADDR, <span class="literal">true</span>)</span><br><span class="line">            .childOption(ChannelOption.SO_RCVBUF, <span class="number">32</span> * <span class="number">1024</span>)</span><br><span class="line">            .childOption(ChannelOption.SO_SNDBUF, <span class="number">32</span> * <span class="number">1024</span>)</span><br><span class="line">            .childOption(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT);</span><br><span class="line"></span><br><span class="line">    b.group(bossGroup, workerGroup).channel(NioServerSocketChannel.class)</span><br><span class="line">            .handler(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.DEBUG))</span><br><span class="line">            .childHandler(<span class="keyword">new</span> <span class="title class_">HttpInboundInitializer</span>(<span class="built_in">this</span>.proxyServers));</span><br><span class="line"></span><br><span class="line">    <span class="type">Channel</span> <span class="variable">ch</span> <span class="operator">=</span> b.bind(port).sync().channel();</span><br><span class="line">    System.out.println(<span class="string">&quot;开启netty http服务器，监听地址和端口为 http://127.0.0.1:&quot;</span> + port + <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">    ch.closeFuture().sync();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    bossGroup.shutdownGracefully();</span><br><span class="line">    workerGroup.shutdownGracefully();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端处理代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">fetchGet</span><span class="params">(<span class="keyword">final</span> FullHttpRequest inbound, <span class="keyword">final</span> ChannelHandlerContext ctx, <span class="keyword">final</span> String url)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">HttpGet</span> <span class="variable">httpGet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpGet</span>(url);</span><br><span class="line">    httpGet.setHeader(HTTP.CONN_DIRECTIVE, HTTP.CONN_KEEP_ALIVE);</span><br><span class="line"></span><br><span class="line">    httpclient.execute(httpGet, <span class="keyword">new</span> <span class="title class_">FutureCallback</span>&lt;HttpResponse&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">completed</span><span class="params">(<span class="keyword">final</span> HttpResponse endpointResponse)</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                handleResponse(inbound, ctx, endpointResponse);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">failed</span><span class="params">(<span class="keyword">final</span> Exception ex)</span> &#123;</span><br><span class="line">            httpGet.abort();</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cancelled</span><span class="params">()</span> &#123;</span><br><span class="line">            httpGet.abort();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleResponse</span><span class="params">(<span class="keyword">final</span> FullHttpRequest fullRequest, <span class="keyword">final</span> ChannelHandlerContext ctx, <span class="keyword">final</span> HttpResponse endpointResponse)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">FullHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] body = EntityUtils.toByteArray(endpointResponse.getEntity());</span><br><span class="line"></span><br><span class="line">        response = <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(HTTP_1_1, OK, Unpooled.wrappedBuffer(body));</span><br><span class="line"></span><br><span class="line">        response.headers().set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">        response.headers().setInt(<span class="string">&quot;Content-Length&quot;</span>, Integer.parseInt(endpointResponse.getFirstHeader(<span class="string">&quot;Content-Length&quot;</span>).getValue()));</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        response = <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(HTTP_1_1, NO_CONTENT);</span><br><span class="line">        exceptionCaught(ctx, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (fullRequest != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!HttpUtil.isKeepAlive(fullRequest)) &#123;</span><br><span class="line">                ctx.write(response).addListener(ChannelFutureListener.CLOSE);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ctx.write(response);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ctx.flush();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>来看一下有网关和没网关的服务器请求架构图吧。</p>
<p><img src="https://thepatterraining.github.io/images/java/gateway/gateway6.jpg" alt="netty服务器"></p>
<h1 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h1><p>完成以后小白很高兴</p>
<p><img src="https://thepatterraining.github.io/images/java/gateway/gateway7.jpg" alt="netty服务器"></p>
<p><img src="https://thepatterraining.github.io/images/java/gateway/gateway8.jpg" alt="netty服务器"></p>
<p>接下来再给简陋的网关加点装饰，实现一些业务外的功能，给服务器减减压。</p>
<p>filter可以做什么，看一下下面filter的架构图。</p>
<p><img src="https://thepatterraining.github.io/images/java/gateway/gateway9.jpg" alt="netty服务器"></p>
<p><code>Req Filter</code>在每次请求执行之前运行。那么它能干什么呢？它可以实现权限检查。流程如下</p>
<ul>
<li>请求A -&gt; 网关main线程 -&gt; 网关worker1线程 -&gt; Req Filter: 权限检查不通过，返回错误</li>
<li>请求B -&gt; 网关main线程 -&gt; 网关worker2线程 -&gt; Req Filter: 权限检查通过，继续请求 -&gt; 服务器A线程</li>
</ul>
<p>Filter可以是链式的，也就是可以增加多个Filter.实现不同的功能。比如在权限检查以外还要做跨域支持。</p>
<ul>
<li>请求A -&gt; 网关main线程 -&gt; 网关worker1线程 -&gt; Req Filter1: 跨域检查不通过，返回错误</li>
<li>请求B -&gt; 网关main线程 -&gt; 网关worker1线程 -&gt; Req Filter1: 跨域检查通过，继续请求 -&gt; Req Filter2: 权限检查不通过，返回错误</li>
<li>请求C -&gt; 网关main线程 -&gt; 网关worker2线程 -&gt; Req Filter1: 跨域检查通过，继续请求 -&gt; Req Filter2: 权限检查通过，继续请求 -&gt; 服务器A线程</li>
</ul>
<p><code>Res Filter</code>在每次请求执行之后运行，那么它能干什么呢？它可以配合<code>Req Filter</code>实现缓存处理。</p>
<p>比如每次请求回来以后放入缓存，每次请求之前判断缓存是否存在，有的话直接返回。</p>
<p>处理流程如下：</p>
<ul>
<li>请求A -&gt; 网关main线程 -&gt; 网关worker1线程 -&gt; Req Filter1: 判断缓存不存在，继续请求 -&gt; 服务器A线程 -&gt; Res Filter1: 请求成功，结果放到缓存</li>
<li>请求A -&gt; 网关main线程 -&gt; 网关worker1线程 -&gt; Req Filter1: 判断缓存存在，获取缓存并返回。</li>
</ul>
<p>开始代码改造，增加Req filter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(<span class="keyword">final</span> FullHttpRequest fullRequest, <span class="keyword">final</span> ChannelHandlerContext ctx, HttpRequestFilter filter)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">backendUrl</span> <span class="operator">=</span> <span class="built_in">this</span>.backendUrls.get(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> backendUrl + fullRequest.uri();</span><br><span class="line">    <span class="comment">// Req filter 请求前执行</span></span><br><span class="line">    filter.filter(fullRequest, ctx);</span><br><span class="line">    proxyService.submit(()-&gt;fetchGet(fullRequest, ctx, url));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续增加Res Filter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleResponse</span><span class="params">(<span class="keyword">final</span> FullHttpRequest fullRequest, <span class="keyword">final</span> ChannelHandlerContext ctx, <span class="keyword">final</span> HttpResponse endpointResponse)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">FullHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] body = EntityUtils.toByteArray(endpointResponse.getEntity());</span><br><span class="line"></span><br><span class="line">        response = <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(HTTP_1_1, OK, Unpooled.wrappedBuffer(body));</span><br><span class="line"></span><br><span class="line">        response.headers().set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">        response.headers().setInt(<span class="string">&quot;Content-Length&quot;</span>, Integer.parseInt(endpointResponse.getFirstHeader(<span class="string">&quot;Content-Length&quot;</span>).getValue()));</span><br><span class="line">        <span class="comment">// res filter 请求结束执行</span></span><br><span class="line">        filter.filter(response);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        response = <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(HTTP_1_1, NO_CONTENT);</span><br><span class="line">        exceptionCaught(ctx, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (fullRequest != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!HttpUtil.isKeepAlive(fullRequest)) &#123;</span><br><span class="line">                ctx.write(response).addListener(ChannelFutureListener.CLOSE);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ctx.write(response);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ctx.flush();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Filter的具体实现，应该先有两个接口</p>
<ul>
<li>Req Filter</li>
<li>Res Filter</li>
</ul>
<p>在有具体的实现类，可以通过配置文件，配置使用不同的Filter。</p>
<p>比如实现一个权限检查的Req Filter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheRequestFilter</span> <span class="keyword">implements</span> <span class="title class_">HttpRequestFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">filter</span><span class="params">(FullHttpRequest fullRequest, ChannelHandlerContext ctx)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取token</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> fullRequest.headers().get(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">        <span class="comment">// 处理token</span></span><br><span class="line">        <span class="keyword">if</span> (!jwt.check(token)) &#123;</span><br><span class="line">            <span class="comment">// 返回错误</span></span><br><span class="line">            <span class="type">byte</span>[] body;</span><br><span class="line">            <span class="type">FullHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(HttpResponseStatus.HTTP_1_1, HttpResponseStatus.FORBIDDEN, Unpooled.wrappedBuffer(body));</span><br><span class="line"></span><br><span class="line">            response.headers().set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">            response.headers().setInt(<span class="string">&quot;Content-Length&quot;</span>, <span class="number">0</span>);</span><br><span class="line">            ctx.write(response);</span><br><span class="line">            ctx.flush();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h1><p><img src="https://thepatterraining.github.io/images/java/gateway/gateway10.jpg" alt="netty服务器"></p>
<p><img src="https://thepatterraining.github.io/images/java/gateway/gateway11.jpg" alt="netty服务器"></p>
<p>负载均衡（Load Balancing）是一种计算机技术，用于在多个计算资源（如服务器、网络链路等）之间分配工作负载，以提高系统的整体性能、可靠性和可扩展性。</p>
<p>负载均衡的基本原理</p>
<ul>
<li>资源分配：将用户的请求按照一定的算法和规则，均匀地分配到多个后端服务器上。这样可以避免单点服务器因承受过多请求而过载，同时充分利用所有可用服务器的资源。</li>
<li>健康检查：负载均衡器会定期检查后端服务器的健康状态。例如，通过发送心跳包或尝试建立连接等方式，来确定服务器是否正常运行。如果发现某台服务器出现故障，负载均衡器会自动停止将请求分配到该服务器，直到其恢复正常。</li>
</ul>
<p>利用软件程序来实现负载均衡。软件负载均衡器可以安装在通用的服务器上，通过软件代码来处理请求的分发。这种方式相对硬件负载均衡成本较低，并且具有更好的灵活性，方便进行定制化和扩展。</p>
<p>看一下<code>Nginx</code>的实现吧。</p>
<p>Nginx：这是一个非常流行的开源软件负载均衡器。它可以作为反向代理服务器，将客户端请求转发到后端服务器。Nginx 支持多种负载均衡算法，如轮询（Round - Robin）、加权轮询（Weighted Round - Robin）、IP 哈希（IP - Hash）等。例如，在轮询算法中，Nginx 会按照顺序依次将请求分配到后端服务器列表中的每一台服务器上。假设后端有服务器 A、服务器 B 和服务器 C，第一个请求会被发送到服务器 A，第二个请求发送到服务器 B，第三个请求发送到服务器 C，然后再从服务器 A 开始循环。</p>
<p>负载均衡的优势</p>
<ul>
<li>提高性能：通过将负载均匀分布在多个服务器上，可以充分利用服务器的资源，避免单点出现性能瓶颈。例如，在一个网站流量高峰期，如果只有一台服务器处理请求，可能会因为 CPU、内存或网络带宽等资源耗尽而导致响应速度变慢。而使用负载均衡将请求分散到多台服务器后，每台服务器处理的请求数量减少，响应时间可以得到有效缩短。</li>
<li>增强可靠性：当某一台后端服务器出现故障时，负载均衡器可以将请求自动切换到其他正常的服务器，从而保证服务的连续性。这对于需要高可用性的应用（如电子商务网站、金融服务等）至关重要。例如，一个在线购物网站，如果没有负载均衡和容错机制，当一台服务器宕机时，可能会导致部分用户无法访问商品信息或进行购物操作，而有了负载均衡后，即使一台服务器出现问题，其他服务器仍可以继续处理请求，用户可能只是感觉到短暂的延迟，而不会出现服务完全中断的情况。</li>
<li>便于扩展：随着业务的增长，可以方便地添加新的服务器到负载均衡池中，以应对不断增加的请求量。例如，一个新兴的互联网公司，其网站的用户访问量逐月增加。通过负载均衡，公司可以根据流量增长情况逐步添加服务器，而不需要对整个系统架构进行大规模的重新设计。负载均衡器可以自动将新添加的服务器纳入请求分配的范围，实现无缝的系统扩展。</li>
</ul>
<p>在看一下实现负载均衡以后的网关架构吧。</p>
<p><img src="https://thepatterraining.github.io/images/java/gateway/gateway12.jpg" alt="netty服务器"></p>
<h2 id="负载均衡的算法"><a href="#负载均衡的算法" class="headerlink" title="负载均衡的算法"></a>负载均衡的算法</h2><p>那负载均衡具体是如何实现呢？看大头怎么说。</p>
<p><img src="https://thepatterraining.github.io/images/java/gateway/gateway13.jpg" alt="netty服务器"></p>
<h3 id="轮询算法"><a href="#轮询算法" class="headerlink" title="轮询算法"></a>轮询算法</h3><p><img src="https://thepatterraining.github.io/images/java/gateway/gateway14.jpg" alt="netty服务器"></p>
<p>下面是轮询算法的时序图。</p>
<p><img src="https://thepatterraining.github.io/images/java/gateway/gateway15.jpg" alt="netty服务器"></p>
<ul>
<li>原理：按照顺序依次将请求分配到后端服务的各个实例上。例如，有三个后端服务实例 A、B、C，第一个请求被路由到 A，第二个请求路由到 B，第三个请求路由到 C，然后又从 A 开始循环分配。这种算法简单公平，能均匀地分配请求负载。</li>
<li>适用场景：适用于后端服务实例性能相近，处理能力相对均衡的情况。例如，多个相同配置的 Web 服务器提供相同的静态网页服务，使用轮询算法可以很好地平衡请求流量。</li>
</ul>
<p>轮询的基本执行流程如下：</p>
<ul>
<li>请求A -&gt; 网关main线程 -&gt; 网关worker1线程 -&gt; 服务器1</li>
<li>请求B -&gt; 网关main线程 -&gt; 网关worker2线程 -&gt; 服务器2</li>
<li>请求C -&gt; 网关main线程 -&gt; 网关worker2线程 -&gt; 服务器3</li>
<li>请求D -&gt; 网关main线程 -&gt; 网关worker1线程 -&gt; 服务器1</li>
<li>请求E -&gt; 网关main线程 -&gt; 网关worker2线程 -&gt; 服务器2</li>
<li>请求F -&gt; 网关main线程 -&gt; 网关worker2线程 -&gt; 服务器3</li>
</ul>
<p>看一段代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RoundRobinRouter</span> <span class="keyword">implements</span> <span class="title class_">HttpEndpointRouter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">current</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">route</span><span class="params">(List&lt;String&gt; urls)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> urls.get(current);</span><br><span class="line">        current++;</span><br><span class="line">        current = current % urls.size();</span><br><span class="line">        <span class="keyword">return</span> url;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="加权轮询算法"><a href="#加权轮询算法" class="headerlink" title="加权轮询算法"></a>加权轮询算法</h3><p><img src="https://thepatterraining.github.io/images/java/gateway/gateway16.jpg" alt="netty服务器"></p>
<p>下面是加权轮询算法的时序图。</p>
<p><img src="https://thepatterraining.github.io/images/java/gateway/gateway17.jpg" alt="netty服务器"></p>
<ul>
<li>原理：为每个后端服务实例分配一个权重值，权重表示该实例相对处理能力的大小。在分配请求时，按照权重比例来分配。例如，服务实例 A 的权重为 5，服务实例 B 的权重为 3，服务实例 C 的权重为 2，那么在总共 10 次请求分配中，A 会被分配 5 次，B 会被分配 3 次，C 会被分配 2 次。</li>
<li>适用场景：当后端服务实例的性能不同，比如部分实例配置更高、处理能力更强时，通过加权轮询可以让性能强的实例处理更多的请求。例如，有新老两代服务器，新服务器性能是老服务器的两倍，就可以给新服务器分配更高的权重，让其承担更多的请求负载。</li>
</ul>
<p>加设3个服务器权重是5，3，2.</p>
<p>加权轮询的基本执行流程如下：</p>
<ul>
<li>请求A -&gt; 网关main线程 -&gt; 网关worker1线程 -&gt; 服务器权重为5 3 2 因此选择服务器1   PS:当前服务器权重为-5 3 2</li>
<li>请求B -&gt; 网关main线程 -&gt; 网关worker2线程 -&gt; 服务器权重为0 6 4 因此选择服务器2   PS:当前服务器权重为0 -4 4</li>
<li>请求C -&gt; 网关main线程 -&gt; 网关worker3线程 -&gt; 服务器权重为5 -1 6 因此选择服务器3  PS:当前服务器权重为5 -1 -4</li>
<li>请求D -&gt; 网关main线程 -&gt; 网关worker4线程 -&gt; 服务器权重为10 2 -2 因此选择服务器1   PS:当前服务器权重为0 2 -2</li>
<li>请求E -&gt; 网关main线程 -&gt; 网关worker1线程 -&gt; 服务器权重为5 5 0 因此选择服务器1   PS:当前服务器权重为-5 5 0</li>
<li>请求F -&gt; 网关main线程 -&gt; 网关worker2线程 -&gt; 服务器权重为0 8 2 因此选择服务器2   PS:当前服务器权重为0 -2 2</li>
<li>请求A -&gt; 网关main线程 -&gt; 网关worker3线程 -&gt; 服务器权重为5 1 4 因此选择服务器1  PS:当前服务器权重为-5 1 4</li>
<li>请求B -&gt; 网关main线程 -&gt; 网关worker4线程 -&gt; 服务器权重为0 4 6 因此选择服务器3   PS:当前服务器权重为0 4 -4</li>
<li>请求C -&gt; 网关main线程 -&gt; 网关worker1线程 -&gt; 服务器权重为5 7 -2 因此选择服务器2   PS:当前服务器权重为5 -3 -2</li>
<li>请求D -&gt; 网关main线程 -&gt; 网关worker2线程 -&gt; 服务器权重为10 0 0 因此选择服务器1   PS:当前服务器权重为0 0 0</li>
</ul>
<p>可以看到上面10次请求结果，服务器1分配了5次请求，服务器2分配了3次请求，服务器3分配了2次请求。</p>
<p>看一段代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WeightedRoundRobinRouter</span> <span class="keyword">implements</span> <span class="title class_">HttpEndpointRouter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">current</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">route</span><span class="params">(List&lt;BackendServer&gt; urls)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">totalWeight</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        BackendServer selectedServer;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 第一步：计算总权重，并更新每个服务器的当前权重</span></span><br><span class="line">        <span class="keyword">for</span> (BackendServer server : urls) &#123;</span><br><span class="line">            totalWeight += server.weight;</span><br><span class="line">            server.currentWeight += server.weight;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 第二步：找出当前权重最大的服务器作为本次选择的服务器</span></span><br><span class="line">        <span class="keyword">for</span> (BackendServer server : urls) &#123;</span><br><span class="line">            <span class="keyword">if</span> (server.currentWeight &gt; selectedServer.currentWeight) &#123;</span><br><span class="line">                selectedServer = server;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 第三步：将选中的服务器的当前权重减去总权重，用于下一轮的权重计算和比较</span></span><br><span class="line">        selectedServer.currentWeight -= totalWeight;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> selectedServer.url;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="哈希算法"><a href="#哈希算法" class="headerlink" title="哈希算法"></a>哈希算法</h3><p><img src="https://thepatterraining.github.io/images/java/gateway/gateway18.jpg" alt="netty服务器"></p>
<p>下面是哈希算法的时序图。</p>
<p><img src="https://thepatterraining.github.io/images/java/gateway/gateway19.jpg" alt="netty服务器"></p>
<p>使用IP进行哈希算法</p>
<ul>
<li>原理：根据请求客户端的 IP 地址计算一个哈希值，然后通过这个哈希值来确定将请求路由到后端服务的哪个实例。相同 IP 地址的请求会始终被路由到同一个后端实例，除非后端实例的数量发生变化。</li>
<li>适用场景：适用于需要保证特定客户端的请求始终由同一个后端实例处理的场景。例如，在一些有状态的服务中，如需要保持用户会话状态（如购物车信息等），通过 IP 哈希可以确保用户的每次请求都能路由到保存其会话状态的后端服务器。</li>
</ul>
<p>哈希算法的基本执行流程如下：</p>
<ul>
<li>请求A -&gt; 网关main线程 -&gt; 网关worker1线程 -&gt; hash(ip) % 3 结果是0，因此选择服务器1</li>
<li>请求B -&gt; 网关main线程 -&gt; 网关worker2线程 -&gt; hash(ip) % 3 结果是1，因此选择服务器2</li>
<li>请求C -&gt; 网关main线程 -&gt; 网关worker3线程 -&gt; hash(ip) % 3 结果是2，因此选择服务器3</li>
</ul>
<p>看一段代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HashRouter</span> <span class="keyword">implements</span> <span class="title class_">HttpEndpointRouter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">current</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">route</span><span class="params">(List&lt;String&gt; urls, ip)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> hash(ip) % urls.size();</span><br><span class="line">        <span class="keyword">return</span> urls.get(index);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="随机算法"><a href="#随机算法" class="headerlink" title="随机算法"></a>随机算法</h3><p><img src="https://thepatterraining.github.io/images/java/gateway/gateway20.jpg" alt="netty服务器"></p>
<p>随机算法的时序图，原理啥的就不放了，因为太简单了，就是取一个(0,2)开区间的一个随机数。是0就服务器1，1就服务器2，2就服务器3.</p>
<p>简单的代码实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RandomRouter</span> <span class="keyword">implements</span> <span class="title class_">HttpEndpointRouter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">route</span><span class="params">(List&lt;String&gt; urls)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> urls.size();</span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>(System.currentTimeMillis());</span><br><span class="line">        <span class="keyword">return</span> urls.get(random.nextInt(size));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来只要修改一下获取请求url的代码就可以了。改成从负载均衡获取请求的url，而不是固定取第一个。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(<span class="keyword">final</span> FullHttpRequest fullRequest, <span class="keyword">final</span> ChannelHandlerContext ctx, HttpRequestFilter filter)</span> &#123;</span><br><span class="line">    <span class="comment">// 这里通过负载均衡的路由获取请求的url</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">backendUrl</span> <span class="operator">=</span> router.route(<span class="built_in">this</span>.backendUrls);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> backendUrl + fullRequest.uri();</span><br><span class="line">    <span class="comment">// Req filter 请求前执行</span></span><br><span class="line">    filter.filter(fullRequest, ctx);</span><br><span class="line">    proxyService.submit(()-&gt;fetchGet(fullRequest, ctx, url));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="健康检查"><a href="#健康检查" class="headerlink" title="健康检查"></a>健康检查</h2><p>当实现这些以后，小白很高兴。</p>
<p><img src="https://thepatterraining.github.io/images/java/gateway/gateway21.jpg" alt="netty服务器"></p>
<p>小白想知道当后端多个服务器，一个挂了怎么办呢？网关又不知道它挂了，把流量请求过去了，结果服务器挂了，那不就请求失败了吗？</p>
<p><img src="https://thepatterraining.github.io/images/java/gateway/gateway22.jpg" alt="netty服务器"></p>
<p>我们可以通过<code>健康检查机制</code>来解决，添加<code>Zookeeper</code>作为健康检查机制，服务器向Zookeeper注册服务，如果服务器挂了那么Zookeeper就会知道。网关通过Zookeeper来获取现在的服务器列表，然后再通过负载均衡选择服务器。</p>
<p>一般最常用的就是<code>心跳检测</code>。</p>
<p>什么是心跳检测呢？</p>
<p>就是每隔一段时间，发送一个请求，看是否正常返回，如果是，那么服务器就正常，如果不是，比如超时之类的就认为服务器挂了，那么接下来的请求流量就不分给这个服务器了，从服务器列表中移除，啥时候发送心跳检测，发现服务器正常返回了，那么就再放到服务器列表中。</p>
<p>也可以直接通过<code>Zookeeper</code>这种额外的组件来实现。服务器跟<code>Zookeeper</code>通信，服务器列表通过<code>Zookeeper</code>获取。</p>
<p>具体的时序图如下。<br><img src="https://thepatterraining.github.io/images/java/gateway/gateway23.jpg" alt="netty服务器"></p>
<p>健康检查的代码就不放了，就当作作业了哈哈，有兴趣的小伙伴可以自己实现一个放到评论区哦～</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>小白又自己实现了一个网关程序，可以开心的回去交差啦。</p>
<p><img src="https://thepatterraining.github.io/images/java/gateway/gateway24.jpg" alt="netty服务器"></p>
<p>一个基本的单体网关就实现完成了。</p>
<p>其实还有一些其他的问题，比如网关挂了怎么办？那么可以部署多个网关节点，组成集群。</p>
<p>那么集群的话就需要引入<code>Raft</code>这种分布式共识协议来进行leader节点选择，信息同步。</p>
<p>那么多个网关节点的元信息放在哪里呢？当然也可以放在<code>Zookeeper</code>里面啦～</p>
<p>更多知识下期介绍～</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/19/">19</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Thepatter"
      src="/images/header.jpeg">
  <p class="site-author-name" itemprop="name">Thepatter</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">187</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">37</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">81</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Thepatterraining" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Thepatterraining" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:ztzhoutao041@163.com" title="E-Mail → mailto:ztzhoutao041@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://blog.csdn.net/Thepatterraining" title="CSDN → http:&#x2F;&#x2F;blog.csdn.net&#x2F;Thepatterraining" rel="noopener" target="_blank"><i class="fa fa-fw fa-CSDN"></i>CSDN</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Thepatter</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

        






<script>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              leancloudSelector(url).innerText = 'Counter not initialized! More info at console err msg.';
              console.error('ATTENTION! LeanCloud counter has security bug, see how to solve it here: https://github.com/theme-next/hexo-leancloud-counter-security. \n However, you can still use LeanCloud without security, by setting `security` option to `false`.');
            
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    let { app_id, app_key, server_url } = {"enable":true,"app_id":"RWllimOI5okO7WFTUmJ4EeeD-gzGzoHsz","app_key":"hXeefwCw8aDKTJ1Xqye7fLYb","security":true};
    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script>


      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'RWllimOI5okO7WFTUmJ4EeeD-gzGzoHsz',
      appKey     : 'hXeefwCw8aDKTJ1Xqye7fLYb',
      placeholder: "给我的文章加点评论吧~",
      avatar     : 'mp',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
