<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="YwTcBpc08sCpJAE8mKZglCGHjZc1BiK9UUagC8ldlaA">
  <meta name="msvalidate.01" content="true">
  <meta name="yandex-verification" content="true">
  <meta name="baidu-site-verification" content="3PbJKzlOf0">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"thepatterraining.github.io","root":"/","scheme":"Mist","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="dream">
<meta property="og:url" content="https://thepatterraining.github.io/page/14/index.html">
<meta property="og:site_name" content="dream">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Thepatter">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://thepatterraining.github.io/page/14/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>dream</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="dream" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">dream</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">一个菜鸟程序员的成长历程</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://thepatterraining.github.io/php-thinkphp-%E6%8A%A5%E9%94%99Creating%20default%20object%20from%20empty%20value.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpeg">
      <meta itemprop="name" content="Thepatter">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/php-thinkphp-%E6%8A%A5%E9%94%99Creating%20default%20object%20from%20empty%20value.html" class="post-title-link" itemprop="url">php-thinkphp-报错Creating default object from empty value</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-25 10:12:47" itemprop="dateCreated datePublished" datetime="2020-08-25T10:12:47+08:00">2020-08-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-01-26 10:07:53" itemprop="dateModified" datetime="2025-01-26T10:07:53+08:00">2025-01-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/" itemprop="url" rel="index"><span itemprop="name">php</span></a>
                </span>
            </span>

          
            <span id="/php-thinkphp-%E6%8A%A5%E9%94%99Creating%20default%20object%20from%20empty%20value.html" class="post-meta-item leancloud_visitors" data-flag-title="php-thinkphp-报错Creating default object from empty value" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/php-thinkphp-%E6%8A%A5%E9%94%99Creating%20default%20object%20from%20empty%20value.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/php-thinkphp-%E6%8A%A5%E9%94%99Creating%20default%20object%20from%20empty%20value.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="php-thinkphp-报错Creating-default-object-from-empty-value"><a href="#php-thinkphp-报错Creating-default-object-from-empty-value" class="headerlink" title="php-thinkphp-报错Creating default object from empty value"></a>php-thinkphp-报错Creating default object from empty value</h1><p>报错第一步，打印，打印日志，在你用到对象的地方，把对象都打印出来看看，你以为他是个对象，但他。。。不一定是个对象！！！</p>
<p>如果你确定你从数据库查询出来的没有错，是个对象，那么。。请看一下你别的对象是不是一个对象！！！</p>
<p>要相信报错，一定是对象错了，但你不确定，所以，请打印日志，如果你这里没问题，别人那里有问题，那么可能是参数的问题。打印日志在别人那就能看到你想的对象可能在他那里不是一个对象！！！</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://thepatterraining.github.io/thinkphp-queue%E9%98%9F%E5%88%97%E4%BD%BF%E7%94%A8.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpeg">
      <meta itemprop="name" content="Thepatter">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/thinkphp-queue%E9%98%9F%E5%88%97%E4%BD%BF%E7%94%A8.html" class="post-title-link" itemprop="url">thinkphp-queue队列使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-25 10:12:47" itemprop="dateCreated datePublished" datetime="2020-08-25T10:12:47+08:00">2020-08-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-01-26 10:07:53" itemprop="dateModified" datetime="2025-01-26T10:07:53+08:00">2025-01-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/" itemprop="url" rel="index"><span itemprop="name">php</span></a>
                </span>
            </span>

          
            <span id="/thinkphp-queue%E9%98%9F%E5%88%97%E4%BD%BF%E7%94%A8.html" class="post-meta-item leancloud_visitors" data-flag-title="thinkphp-queue队列使用" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/thinkphp-queue%E9%98%9F%E5%88%97%E4%BD%BF%E7%94%A8.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/thinkphp-queue%E9%98%9F%E5%88%97%E4%BD%BF%E7%94%A8.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="thinkphp-queue队列使用"><a href="#thinkphp-queue队列使用" class="headerlink" title="thinkphp-queue队列使用"></a>thinkphp-queue队列使用</h1><p>在我们写程序的时候，经常会用到队列来完成一些操作，关于队列的介绍和使用场景，注意事项可以看我的这个文章<a target="_blank" rel="noopener" href="https://blog.csdn.net/Thepatterraining/article/details/105344675">你不知道的队列使用技巧</a></p>
<h2 id="在tp里面使用队列"><a href="#在tp里面使用队列" class="headerlink" title="在tp里面使用队列"></a>在tp里面使用队列</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p><code>tp</code>框架提供了一个扩展包，叫做<code>think-queue</code>。我们先来安装这个扩展包。</p>
<blockquote>
<p>composer require topthink&#x2F;think-queue</p>
</blockquote>
<h3 id="配置消息队列"><a href="#配置消息队列" class="headerlink" title="配置消息队列"></a>配置消息队列</h3><p>等待安装完成之后，我们需要进行配置，消息队列的消息存放在哪里，可以配置成redis。</p>
<p>配置在你的<code>config/queue.php</code>里面。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">&#x27;default&#x27;</span>     =&gt; <span class="string">&#x27;redis&#x27;</span>,  <span class="comment">//默认是sync，改成redis</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;connections&#x27;</span> =&gt; [</span><br><span class="line">        <span class="string">&#x27;redis&#x27;</span>    =&gt; [</span><br><span class="line">            <span class="string">&#x27;type&#x27;</span>       =&gt; <span class="string">&#x27;redis&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;queue&#x27;</span>      =&gt; <span class="string">&#x27;default&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;host&#x27;</span>       =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&#x27;queue.host&#x27;</span>, <span class="string">&#x27;127.0.0.1&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;port&#x27;</span>       =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&#x27;queue.port&#x27;</span>, <span class="number">6379</span>),</span><br><span class="line">            <span class="string">&#x27;password&#x27;</span>   =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&#x27;queue.password&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;select&#x27;</span>     =&gt; <span class="number">0</span>,      <span class="comment">// 使用哪一个 db，默认为 db0</span></span><br><span class="line">            <span class="string">&#x27;timeout&#x27;</span>    =&gt; <span class="number">0</span>,      <span class="comment">// redis连接的超时时间</span></span><br><span class="line">            <span class="string">&#x27;persistent&#x27;</span> =&gt; <span class="literal">false</span>,  <span class="comment">// 是否是长连接</span></span><br><span class="line">        ],</span><br><span class="line">    ],</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="创建消息"><a href="#创建消息" class="headerlink" title="创建消息"></a>创建消息</h3><p>配置完成以后我们就可以开始使用了。</p>
<p>在我们的<code>controller</code>里面把一个消息推送到队列里面。这里我们定义一个队列名称叫做<code>message</code>,定义一个处理队列消息的消费者类<code>app\common\queue\consumer</code>。然后调用<code>Queue</code>门面的<code>push</code>方法，把消费者，队列名称，数据传入进去就可以了。这个时候就会把数据放到<code>message</code>这个队列里面。然后消费者取出数据进行处理。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">api</span>\<span class="title class_">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">BaseController</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">facade</span>\<span class="title">Queue</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> <span class="keyword">extends</span> <span class="title">BaseController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$consumer</span> = <span class="string">&#x27;app\common\queue\consumer&#x27;</span>;  <span class="comment">//消费者类</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$queue</span> = <span class="string">&#x27;message&#x27;</span>; <span class="comment">//队列名称</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;request-&gt;<span class="title function_ invoke__">isPost</span>()) &#123;</span><br><span class="line">            <span class="comment">//要推送到队列里面的数据</span></span><br><span class="line">            <span class="variable">$jobData</span> = [];</span><br><span class="line">            <span class="variable">$jobData</span>[<span class="string">&quot;a&quot;</span>] = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">            <span class="variable">$jobData</span>[<span class="string">&#x27;b&#x27;</span>] = <span class="string">&#x27;b&#x27;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$res</span> = <span class="title class_">Queue</span>::<span class="title function_ invoke__">push</span>(<span class="variable language_">$this</span>-&gt;consumer, <span class="variable">$data</span>, <span class="variable language_">$this</span>-&gt;queue);</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">json</span>([]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="消费消息"><a href="#消费消息" class="headerlink" title="消费消息"></a>消费消息</h3><p>我们接下来实现我们上面定义的消费者。来处理我们的逻辑。</p>
<p>消费者<code>app\common\queue\consumer</code>类。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> <span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">common</span>\<span class="title class_">queue</span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">use</span> <span class="title">think</span>\<span class="title">queue</span>\<span class="title">Job</span>;</span><br><span class="line"></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">consumer</span> </span>&#123;</span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * fire方法是消息队列默认调用的方法</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param</span> Job            $job      当前的任务对象</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param</span> array|mixed    $data     发布任务时自定义的数据</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">     <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fire</span>(<span class="params">Job <span class="variable">$job</span>,<span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function">     </span>&#123;</span><br><span class="line">         <span class="comment">// 有些消息在到达消费者时,可能已经不再需要执行了</span></span><br><span class="line">         <span class="variable">$isJobStillNeedToBeDone</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">check</span>(<span class="variable">$data</span>);</span><br><span class="line">         <span class="keyword">if</span>(!<span class="variable">$isJobStillNeedToBeDone</span>)&#123;</span><br><span class="line">             <span class="variable">$job</span>-&gt;<span class="title function_ invoke__">delete</span>();  <span class="comment">//删除任务</span></span><br><span class="line">             <span class="keyword">return</span>;</span><br><span class="line">         &#125;</span><br><span class="line">       </span><br><span class="line">         <span class="comment">//执行任务</span></span><br><span class="line">         <span class="variable">$isJobDone</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">doJob</span>(<span class="variable">$data</span>);</span><br><span class="line">       </span><br><span class="line">         <span class="keyword">if</span> (<span class="variable">$isJobDone</span>) &#123;</span><br><span class="line">             <span class="comment">// 如果任务执行成功， 记得删除任务</span></span><br><span class="line">             <span class="variable">$job</span>-&gt;<span class="title function_ invoke__">delete</span>();</span><br><span class="line">         &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">             <span class="keyword">if</span> (<span class="variable">$job</span>-&gt;<span class="title function_ invoke__">attempts</span>() &gt; <span class="number">3</span>) &#123;</span><br><span class="line">                 <span class="comment">//通过这个方法可以检查这个任务已经重试了几次了</span></span><br><span class="line"> 				  <span class="variable">$job</span>-&gt;<span class="title function_ invoke__">delete</span>();</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * 有些消息在到达消费者时,可能已经不再需要执行了</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param</span> array|mixed    $data     发布任务时自定义的数据</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@return</span> boolean                 任务执行的结果</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">     <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * 根据消息中的数据进行实际的业务处理...</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">     <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">doJob</span>(<span class="params"><span class="variable">$data</span></span>) </span></span><br><span class="line"><span class="function">     </span>&#123;</span><br><span class="line">         <span class="title function_ invoke__">dump</span>(<span class="variable">$data</span>);</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这样我们就完成了代码的逻辑，也就是发布消息，消费消息。</p>
<p>接下来我们启动这个队列。</p>
<h3 id="启动队列"><a href="#启动队列" class="headerlink" title="启动队列"></a>启动队列</h3><p>启动队列有两种方式。</p>
<ul>
<li>work</li>
<li>listen</li>
</ul>
<p><code>work</code>方式启动。这种方式是单进程运行。如果你更新了代码需要手动重启队列。</p>
<blockquote>
<p>php think queue:work –queue message  &#x2F;&#x2F;我们刚刚定义的队列名称</p>
</blockquote>
<p><code>listen</code>方式启动。这种方式是master-worker模型。一个master主进程来监听，当请求进来了启动一个work子进程来运行上面的work方式启动。</p>
<blockquote>
<p>php think queue:listen –queue message</p>
</blockquote>
<p>我更推荐listen方式来运行。这种方式更新代码后也不需要手动重启。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://thepatterraining.github.io/thinkphp-queue%E9%98%9F%E5%88%97%E5%AF%BC%E8%87%B4MySQL%20server%20has%20gone%20away.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpeg">
      <meta itemprop="name" content="Thepatter">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/thinkphp-queue%E9%98%9F%E5%88%97%E5%AF%BC%E8%87%B4MySQL%20server%20has%20gone%20away.html" class="post-title-link" itemprop="url">thinkphp-queue队列导致MySQL server has gone away</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-25 10:12:47" itemprop="dateCreated datePublished" datetime="2020-08-25T10:12:47+08:00">2020-08-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-01-26 10:07:53" itemprop="dateModified" datetime="2025-01-26T10:07:53+08:00">2025-01-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/" itemprop="url" rel="index"><span itemprop="name">php</span></a>
                </span>
            </span>

          
            <span id="/thinkphp-queue%E9%98%9F%E5%88%97%E5%AF%BC%E8%87%B4MySQL%20server%20has%20gone%20away.html" class="post-meta-item leancloud_visitors" data-flag-title="thinkphp-queue队列导致MySQL server has gone away" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/thinkphp-queue%E9%98%9F%E5%88%97%E5%AF%BC%E8%87%B4MySQL%20server%20has%20gone%20away.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/thinkphp-queue%E9%98%9F%E5%88%97%E5%AF%BC%E8%87%B4MySQL%20server%20has%20gone%20away.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="thinkphp-queue队列导致MySQL-server-has-gone-away"><a href="#thinkphp-queue队列导致MySQL-server-has-gone-away" class="headerlink" title="thinkphp-queue队列导致MySQL server has gone away"></a>thinkphp-queue队列导致MySQL server has gone away</h1><p>虽然队列一时爽，不过还是有缺点的，比如当队列运行时间长了会报错 MySQL server has gone away</p>
<p>原因是使用<code>work</code>模式运行时间长了以后没有释放mysql数据库的链接，导致时间长了以后被mysql server端判断超时切断了链接。</p>
<p>可以改用<code>listen</code>模式运行，这样每次都是启动一个新的work进程来运行程序，每次都会新链接数据库。</p>
<p>可以使用tp的断线重连功能。修改配置文件<code>config/database.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 数据库连接配置信息</span></span><br><span class="line">    <span class="string">&#x27;connections&#x27;</span>     =&gt; [</span><br><span class="line">        <span class="string">&#x27;mysql&#x27;</span> =&gt; [</span><br><span class="line">            <span class="comment">// 是否需要断线重连</span></span><br><span class="line">            <span class="string">&#x27;break_reconnect&#x27;</span>   =&gt; <span class="literal">true</span>,</span><br><span class="line">        ],</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://thepatterraining.github.io/php-mpdf%E6%89%A9%E5%B1%95%E5%8C%85%E4%B8%AD%E6%96%87%E4%B9%B1%E7%A0%81%E9%97%AE%E9%A2%98.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpeg">
      <meta itemprop="name" content="Thepatter">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/php-mpdf%E6%89%A9%E5%B1%95%E5%8C%85%E4%B8%AD%E6%96%87%E4%B9%B1%E7%A0%81%E9%97%AE%E9%A2%98.html" class="post-title-link" itemprop="url">php-mpdf扩展包中文乱码问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-24 10:12:47" itemprop="dateCreated datePublished" datetime="2020-08-24T10:12:47+08:00">2020-08-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-01-26 10:07:53" itemprop="dateModified" datetime="2025-01-26T10:07:53+08:00">2025-01-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/" itemprop="url" rel="index"><span itemprop="name">php</span></a>
                </span>
            </span>

          
            <span id="/php-mpdf%E6%89%A9%E5%B1%95%E5%8C%85%E4%B8%AD%E6%96%87%E4%B9%B1%E7%A0%81%E9%97%AE%E9%A2%98.html" class="post-meta-item leancloud_visitors" data-flag-title="php-mpdf扩展包中文乱码问题" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/php-mpdf%E6%89%A9%E5%B1%95%E5%8C%85%E4%B8%AD%E6%96%87%E4%B9%B1%E7%A0%81%E9%97%AE%E9%A2%98.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/php-mpdf%E6%89%A9%E5%B1%95%E5%8C%85%E4%B8%AD%E6%96%87%E4%B9%B1%E7%A0%81%E9%97%AE%E9%A2%98.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="php-mpdf扩展包中文乱码问题"><a href="#php-mpdf扩展包中文乱码问题" class="headerlink" title="php-mpdf扩展包中文乱码问题"></a>php-mpdf扩展包中文乱码问题</h1><p><a target="_blank" rel="noopener" href="http://mpdf.github.io/fonts-languages/fonts-in-mpdf-7-x.html">mpdf</a>是一个可以把html网页转换成pdf文件的扩展包。一开始使用的时候，发现中文乱码了。。在网上查了半天，好多方法都不管用。</p>
<p>最后，在他的文档里面找到了问题原因。</p>
<p>想要输出中文，有两个参数至关重要！！！</p>
<ul>
<li>autoLangToFont 这个值一定要设置为true才可以</li>
<li>autoScriptToLang 这个值也一定要设置为true才可以</li>
</ul>
<p>只要上面两个设置为true，那么你的中文就可以正常输出了。相信我，不能正常输出你来打我。</p>
<p>看一下mpdf文档上面的描述。</p>
<p><img src="/images/mpdf1.png" alt="mpdf"></p>
<p><img src="/images/mpdf2.png" alt="mpdf"></p>
<p>可以看到默认值是false，所以我们使用的时候需要改成true。</p>
<p>设置这两个值也很简单。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Mpdf</span>\<span class="title">Mpdf</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$pdf</span> = <span class="keyword">new</span> Mpdf;</span><br><span class="line">    <span class="variable">$pdf</span>-&gt;autoLangToFont = <span class="literal">true</span>;</span><br><span class="line">    <span class="variable">$pdf</span>-&gt;autoScriptToLang = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$pdf</span>-&gt;<span class="title function_ invoke__">writeHTML</span>(<span class="string">&#x27;&lt;h1&gt;123&lt;/h1&gt;&#x27;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$pdf</span>-&gt;<span class="title function_ invoke__">output</span>(<span class="string">&#x27;./test.pdf&#x27;</span>, <span class="string">&#x27;D&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实，mpdf的文档最开始是有错误的，他的文档中写的默认值是<code>true</code>而不是现在的<code>false</code>。不过从他的源码上可以看到他的默认值其实是<code>false</code>。</p>
<p>源码位置：<code>vendor/mpdf/mpdf/src/Config/ConfigVariables.php</code>里面。<br>这个文件里面是很多变量的默认值，在这里面搜索可以看到这两个值是false。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// AUTOMATIC FONT SELECTION</span></span><br><span class="line"><span class="comment">// Based on script and/or language</span></span><br><span class="line"><span class="comment">// mPDF 6.0 (similar to previously using function SetAutoFont() )</span></span><br><span class="line"><span class="string">&#x27;autoScriptToLang&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment">// mPDF 6.0 (similar to old useLang)</span></span><br><span class="line"><span class="string">&#x27;autoLangToFont&#x27;</span> =&gt; <span class="literal">false</span>,</span><br></pre></td></tr></table></figure>

<p>我给他们的github上面提了一个issue，他们才把文档改过来了。</p>
<p><img src="/images/mpdf3.png" alt="mpdf"></p>
<p>最后附上mpdf官方文档：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://mpdf.github.io/fonts-languages/fonts-in-mpdf-7-x.html">http://mpdf.github.io/fonts-languages/fonts-in-mpdf-7-x.html</a></p>
</blockquote>
<p>我给他们提的issue:</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/mpdf/mpdf.github.io/issues/141">https://github.com/mpdf/mpdf.github.io/issues/141</a></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://thepatterraining.github.io/thinkphp-tp6%E4%BD%BF%E7%94%A8chunk%E5%88%86%E5%9D%97%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E7%9A%84%E5%9D%91.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpeg">
      <meta itemprop="name" content="Thepatter">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/thinkphp-tp6%E4%BD%BF%E7%94%A8chunk%E5%88%86%E5%9D%97%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E7%9A%84%E5%9D%91.html" class="post-title-link" itemprop="url">thinkphp-tp6使用chunk分块操作数据的坑</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-24 10:12:47" itemprop="dateCreated datePublished" datetime="2020-08-24T10:12:47+08:00">2020-08-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-01-26 10:07:53" itemprop="dateModified" datetime="2025-01-26T10:07:53+08:00">2025-01-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/" itemprop="url" rel="index"><span itemprop="name">php</span></a>
                </span>
            </span>

          
            <span id="/thinkphp-tp6%E4%BD%BF%E7%94%A8chunk%E5%88%86%E5%9D%97%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E7%9A%84%E5%9D%91.html" class="post-meta-item leancloud_visitors" data-flag-title="thinkphp-tp6使用chunk分块操作数据的坑" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/thinkphp-tp6%E4%BD%BF%E7%94%A8chunk%E5%88%86%E5%9D%97%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E7%9A%84%E5%9D%91.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/thinkphp-tp6%E4%BD%BF%E7%94%A8chunk%E5%88%86%E5%9D%97%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E7%9A%84%E5%9D%91.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="thinkphp-tp6使用chunk分块操作数据的坑"><a href="#thinkphp-tp6使用chunk分块操作数据的坑" class="headerlink" title="thinkphp-tp6使用chunk分块操作数据的坑"></a>thinkphp-tp6使用chunk分块操作数据的坑</h1><p>有的时候我们会遇到需要定时操作数据的需求，比如定时更新所有用户的权益，徽章等等。这个时候你不能一次性取出所有数据来进行操作，因为数据量太大了，我们一次取出全部，先不说mysql数据库会很慢，就算取出来传给你，网络开销也很大。这时候你通过网络接收到数据以后，会把这些数据放到一个变量里面。这个变量是存在内存中的，如果过大还会导致内存溢出，内存不足的问题。</p>
<p>所以我们就需要分页取出数据来进行操作，比如每次取出100条，操作完了再取出下100条。而tp框架提供了一个方便的<code>chunk</code>方法来供我们使用，免去了我们需要手动<code>limit</code>分页的麻烦。</p>
<p>我之前使用过laravel的chunk，以为两个差不多，看了文档也觉得差不多。下图是tp6文档的描述。</p>
<p><img src="/../images/tp-chunk1.png" alt="tp"></p>
<p>其实单表这么写也没有什么问题，不过一旦你使用了连表查询，就出现问题了。。而他的文档并没有说连表的问题。</p>
<p>虽然他的文档有这么一段也说明了主键和排序的问题。</p>
<p><img src="/../images/tp-chunk2.png" alt="tp"></p>
<p>但是，没想到连表的时候是必须，注意，必须！！！传主键，不然他不知道是哪个表的主键。而laravel就没有这个问题。。</p>
<p>我当时写的时候去找了他的源码，才看到这个问题，因为我正常写完后一直报错。。</p>
<p>看一下他的源码。源码位置在<code>./vendor/topthink/think-orm/src/db/query.php</code>里面的<code>chunk</code>方法。</p>
<p><img src="/../images/tp-chunk3.png" alt="tp"></p>
<p><img src="/../images/tp-chunk4.png" alt="tp"></p>
<p>从这里可以看到他有4个参数。</p>
<ul>
<li>count 每次处理的数量</li>
<li>callback 处理的回调函数</li>
<li>column 处理的字段名 默认 null</li>
<li>order 字段排序 默认asc</li>
</ul>
<p>前两个我们必传，后面的可选。</p>
<p>他的第二行代码，如果你传了第三个参数，那么使用你传的，不然调用getPk这个函数。这个函数在源码里面也有，就是获取主键。假设你不传，你的主键是id，那么<code>column</code>这个变量就是id。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$column</span>  = <span class="variable">$column</span> ?: <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getPk</span>();</span><br></pre></td></tr></table></figure>

<p>接下来的代码你会发现你的<code>column</code>参数，还可以传一个数组。如果是一个数组，那么他在这里不使用这个参数。</p>
<p>如果你传的不是一个数组，那么看有没有<code>.</code>也就是连不连表。因为连表你传的是<code>a.id</code>。如果连表那么<code>explode</code>分割成数组[a,id]的形式。</p>
<p>如果你传的就是<code>id</code>那么直接赋值给变量<code>key</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$column</span>)) &#123;</span><br><span class="line">    <span class="variable">$times</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="variable">$query</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">options</span>(<span class="variable">$options</span>)-&gt;<span class="title function_ invoke__">page</span>(<span class="variable">$times</span>, <span class="variable">$count</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$query</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">options</span>(<span class="variable">$options</span>)-&gt;<span class="title function_ invoke__">limit</span>(<span class="variable">$count</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$column</span>, <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">        [<span class="variable">$alias</span>, <span class="variable">$key</span>] = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$column</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$key</span> = <span class="variable">$column</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来就是真正获取数据，然后调用回调函数，再重复获取数据的过程了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$resultSet</span> = <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">order</span>(<span class="variable">$column</span>, <span class="variable">$order</span>)-&gt;<span class="title function_ invoke__">select</span>();</span><br></pre></td></tr></table></figure>

<p>这里可以看到，我们传数组，那么数组就会直接给<code>order</code>函数，如果是连表的主键<code>a.id</code>，那么就会把[a,id]给<code>order</code>函数，如果是单表，那么默认<code>id</code>主键给<code>order</code>函数。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://thepatterraining.github.io/2022%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpeg">
      <meta itemprop="name" content="Thepatter">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93.html" class="post-title-link" itemprop="url">2022年终总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-21 10:12:47" itemprop="dateCreated datePublished" datetime="2020-08-21T10:12:47+08:00">2020-08-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-01-26 10:07:53" itemprop="dateModified" datetime="2025-01-26T10:07:53+08:00">2025-01-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/2022%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/" itemprop="url" rel="index"><span itemprop="name">2022年终总结</span></a>
                </span>
            </span>

          
            <span id="/2022%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93.html" class="post-meta-item leancloud_visitors" data-flag-title="2022年终总结" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="2022年终总结"><a href="#2022年终总结" class="headerlink" title="2022年终总结"></a>2022年终总结</h1><p>2022年天灾人祸不断，疫情严重，年中的时候就居家办公了一个月，十一之后又开始了居家办公。好消息是年终的时候疫情结束了，大家一起阳。</p>
<p>这一年里钱没挣到，没攒下。工作也是稀里哗啦。开始了从php转java的路子。刚开始转java很不适应。很多写法，习惯不一样，很多工具不知道，不会用。不断的踩坑，填坑。</p>
<p>到年终的时候总算把java搞得差不多了，写项目也没有在踩坑之类的了。不过关于java的内存，gc，多线程这些还是有待提高。</p>
<p>同样的，因为java的不适应和踩坑，再加上作为第一批转java的，接了难活等等，年底绩效背了c。</p>
<p>2022年花钱如流水，换了3部手机，买了一个mac pro。</p>
<p>也完成了我的求婚。结婚也要提上日程了。</p>
<p>新的一年希望越来越好。</p>
<h2 id="2023年小目标"><a href="#2023年小目标" class="headerlink" title="2023年小目标"></a>2023年小目标</h2><p>学习</p>
<ul>
<li>csapp</li>
<li>伯克利cs61b</li>
<li>cmu 15-445</li>
</ul>
<p>自考本科完成</p>
<p>读书</p>
<ul>
<li>离散数学及其应用</li>
<li>概率论</li>
<li>csapp</li>
<li>每个人的经济学</li>
<li>置身事内</li>
</ul>
<p>证书</p>
<ul>
<li>公共英语三级</li>
<li>软考高级</li>
</ul>
<p>java</p>
<ul>
<li>内存</li>
<li>gc</li>
<li>多线程</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://thepatterraining.github.io/JAVA-stream%E7%BB%93%E6%9E%9C%E6%80%81%E5%8E%9F%E7%90%86.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpeg">
      <meta itemprop="name" content="Thepatter">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/JAVA-stream%E7%BB%93%E6%9E%9C%E6%80%81%E5%8E%9F%E7%90%86.html" class="post-title-link" itemprop="url">JAVA-stream创建原理和数据结构操作</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-21 10:12:47" itemprop="dateCreated datePublished" datetime="2020-08-21T10:12:47+08:00">2020-08-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-01-26 10:07:53" itemprop="dateModified" datetime="2025-01-26T10:07:53+08:00">2025-01-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
            </span>

          
            <span id="/JAVA-stream%E7%BB%93%E6%9E%9C%E6%80%81%E5%8E%9F%E7%90%86.html" class="post-meta-item leancloud_visitors" data-flag-title="JAVA-stream创建原理和数据结构操作" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/JAVA-stream%E7%BB%93%E6%9E%9C%E6%80%81%E5%8E%9F%E7%90%86.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/JAVA-stream%E7%BB%93%E6%9E%9C%E6%80%81%E5%8E%9F%E7%90%86.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="stream"><a href="#stream" class="headerlink" title="stream"></a>stream</h1><h3 id="stream的结果态"><a href="#stream的结果态" class="headerlink" title="stream的结果态"></a>stream的结果态</h3><p>当前使用的结果态方法是<code>collect</code>。主要作用是收集。看一下源码。作为结果态方法，不再返回stream类型的对象。接受一个<code>Collector</code>类型的对象作为参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> &lt;R, A&gt; R <span class="title function_">collect</span><span class="params">(Collector&lt;? <span class="built_in">super</span> P_OUT, A, R&gt; collector)</span> &#123;</span><br><span class="line">    <span class="comment">//声明一个变量</span></span><br><span class="line">    A container;</span><br><span class="line">    <span class="comment">//判断是否并行流。短路，直接走else</span></span><br><span class="line">    <span class="keyword">if</span> (isParallel()</span><br><span class="line">            &amp;&amp; (collector.characteristics().contains(Collector.Characteristics.CONCURRENT))</span><br><span class="line">            &amp;&amp; (!isOrdered() || collector.characteristics().contains(Collector.Characteristics.UNORDERED))) &#123;</span><br><span class="line">        container = collector.supplier().get();</span><br><span class="line">        BiConsumer&lt;A, ? <span class="built_in">super</span> P_OUT&gt; accumulator = collector.accumulator();</span><br><span class="line">        forEach(u -&gt; accumulator.accept(container, u));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//调用evaluate方法</span></span><br><span class="line">        container = evaluate(ReduceOps.makeRef(collector));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> collector.characteristics().contains(Collector.Characteristics.IDENTITY_FINISH)</span><br><span class="line">            ? (R) container</span><br><span class="line">            : collector.finisher().apply(container);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先看一下<code>ReduceOps</code> 类的 <code>makeRef</code>方法。构造一个结果态对象，对引用类型的值执行可变的计算，规约。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/** Constructs a TerminalOp that implements a mutable reduce on reference values.</span></span><br><span class="line"><span class="comment">    形参:</span></span><br><span class="line"><span class="comment">    collector – a Collector defining the reduction</span></span><br><span class="line"><span class="comment">    返回值:</span></span><br><span class="line"><span class="comment">    a ReduceOp implementing the reduction</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T, I&gt; TerminalOp&lt;T, I&gt; <span class="title function_">makeRef</span><span class="params">(Collector&lt;? <span class="built_in">super</span> T, I, ?&gt; collector)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//参数校验不为空并且获取到collector的 supplier</span></span><br><span class="line">    Supplier&lt;I&gt; supplier = Objects.requireNonNull(collector).supplier();</span><br><span class="line">    <span class="comment">// 获取到 collector的 accumulator</span></span><br><span class="line">    BiConsumer&lt;I, ? <span class="built_in">super</span> T&gt; accumulator = collector.accumulator();</span><br><span class="line">    <span class="comment">// 获取到 collector的 combiner</span></span><br><span class="line">    BinaryOperator&lt;I&gt; combiner = collector.combiner();</span><br><span class="line">    <span class="comment">// 内部类 </span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">ReducingSink</span> <span class="keyword">extends</span> <span class="title class_">Box</span>&lt;I&gt;</span><br><span class="line">            <span class="keyword">implements</span> <span class="title class_">AccumulatingSink</span>&lt;T, I, ReducingSink&gt; &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">begin</span><span class="params">(<span class="type">long</span> size)</span> &#123;</span><br><span class="line">            state = supplier.get();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(T t)</span> &#123;</span><br><span class="line">            accumulator.accept(state, t);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">combine</span><span class="params">(ReducingSink other)</span> &#123;</span><br><span class="line">            state = combiner.apply(state, other.state);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//创建一个 ReduceOp 的对象</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ReduceOp</span>&lt;T, I, ReducingSink&gt;(StreamShape.REFERENCE) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> ReducingSink <span class="title function_">makeSink</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ReducingSink</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOpFlags</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> collector.characteristics().contains(Collector.Characteristics.UNORDERED)</span><br><span class="line">                    ? StreamOpFlag.NOT_ORDERED</span><br><span class="line">                    : <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>看一下<code>ReduceOp</code>类。他根据指定的流类型创建ReduceOp对象。 使用指定的<code>supplier</code>创建 accumulating sinks。 对流进行预估并将结果发送至 accumulating sinks。然后执行计算操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ReduceOp</span>&lt;T, R, S <span class="keyword">extends</span> <span class="title class_">AccumulatingSink</span>&lt;T, R, S&gt;&gt;</span><br><span class="line">            <span class="keyword">implements</span> <span class="title class_">TerminalOp</span>&lt;T, R&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StreamShape inputShape;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * Create a &#123;<span class="doctag">@code</span> ReduceOp&#125; of the specified stream shape which uses</span></span><br><span class="line"><span class="comment">        * the specified &#123;<span class="doctag">@code</span> Supplier&#125; to create accumulating sinks.</span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> shape The shape of the stream pipeline</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    ReduceOp(StreamShape shape) &#123;</span><br><span class="line">        <span class="comment">//这里 shape 是 REFERENCE 也就是引用类型</span></span><br><span class="line">        inputShape = shape;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>创建完结果态对象以后，将结果态对象传入<code>evaluate</code>方法。预估管道的结果态操作并产生一个结果。</p>
<ul>
<li>container &#x3D; evaluate(ReduceOps.makeRef(collector));</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Evaluate the pipeline with a terminal operation to produce a result.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> &lt;R&gt; the type of result</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> terminalOp the terminal operation to be applied to the pipeline.</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> the result</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">//这里的参数就是上面刚生成的结果态对象。</span></span><br><span class="line"><span class="keyword">final</span> &lt;R&gt; R <span class="title function_">evaluate</span><span class="params">(TerminalOp&lt;E_OUT, R&gt; terminalOp)</span> &#123;</span><br><span class="line">    <span class="comment">//断言类型是否是引用类型</span></span><br><span class="line">    <span class="comment">//getOutputShape是ReferencePipeline类的方法，直接返回的就是 REFERENCE, 刚才生成的结果态的shape也是 REFERENCE</span></span><br><span class="line">    <span class="keyword">assert</span> <span class="title function_">getOutputShape</span><span class="params">()</span> == terminalOp.inputShape();</span><br><span class="line">    <span class="comment">//判断是否已经消费 如果已经消费了 抛出非法状态异常。</span></span><br><span class="line">    <span class="keyword">if</span> (linkedOrConsumed)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(MSG_STREAM_LINKED);</span><br><span class="line">    <span class="comment">//标记为已消费</span></span><br><span class="line">    linkedOrConsumed = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">//如果是并行流调用结果态的并行流方法，否则调用顺序流方法。</span></span><br><span class="line">    <span class="keyword">return</span> isParallel()</span><br><span class="line">            ? terminalOp.evaluateParallel(<span class="built_in">this</span>, sourceSpliterator(terminalOp.getOpFlags()))</span><br><span class="line">            : terminalOp.evaluateSequential(<span class="built_in">this</span>, sourceSpliterator(terminalOp.getOpFlags()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用顺序流处理方法之前，参数先调用了<code>sourceSpliterator</code>方法。而在调用<code>sourceSpliterator</code>之前，还调用了结果态的<code>getOpFlags</code>方法。</p>
<p><code>getOpFlags</code>方法在创建结果态的时候增加的，代码在下面，一起回顾一下。这个方法很简单，就是看collector的characteristics是否无序。</p>
<ul>
<li>如果无序，返回StreamOpFlag.NOT_ORDERED标志，即32</li>
<li>否则返回0</li>
</ul>
<p>我们这里返回的是0，因为list并不需要有序。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//创建一个 ReduceOp 的对象</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ReduceOp</span>&lt;T, I, ReducingSink&gt;(StreamShape.REFERENCE) &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ReducingSink <span class="title function_">makeSink</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ReducingSink</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOpFlags</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> collector.characteristics().contains(Collector.Characteristics.UNORDERED)</span><br><span class="line">                ? StreamOpFlag.NOT_ORDERED</span><br><span class="line">                : <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>接下来看<code>sourceSpliterator</code>方法。作用如下：</p>
<ul>
<li>如果是一个顺序流或无状态并行流，返回初始化的spliterator对象。</li>
<li>如果是一个有状态并行流，返回一个spliterator对象，包含所有最近状态操作的计算结果。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get the source spliterator for this pipeline stage.  For a sequential or</span></span><br><span class="line"><span class="comment"> * stateless parallel pipeline, this is the source spliterator.  For a</span></span><br><span class="line"><span class="comment"> * stateful parallel pipeline, this is a spliterator describing the results</span></span><br><span class="line"><span class="comment"> * of all computations up to and including the most recent stateful</span></span><br><span class="line"><span class="comment"> * operation.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="comment">//参数是0</span></span><br><span class="line"><span class="keyword">private</span> Spliterator&lt;?&gt; sourceSpliterator(<span class="type">int</span> terminalFlags) &#123;</span><br><span class="line">    <span class="comment">// Get the source spliterator of the pipeline</span></span><br><span class="line">    <span class="comment">//声明 spliterator = null</span></span><br><span class="line">    Spliterator&lt;?&gt; spliterator = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">//判断 sourceStage指针的sourceSpliterator是否为null</span></span><br><span class="line">    <span class="comment">//sourceStage指针指向头节点，所以是判断 头节点的 sourceSpliterator是否为null。</span></span><br><span class="line">    <span class="comment">//在最开始初始化的时候，头节点的 sourceSpliterator 指向了一个 ArrayListSpliterator 对象，所以这里不是null</span></span><br><span class="line">    <span class="comment">//不是null的话我们会取出 头节点的 sourceSpliterator</span></span><br><span class="line">    <span class="keyword">if</span> (sourceStage.sourceSpliterator != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 本地变量 spliterator = 头节点的 ArrayListSpliterator 对象 里面包含我们的源数据 list。</span></span><br><span class="line">        spliterator = sourceStage.sourceSpliterator;</span><br><span class="line">        <span class="comment">// 删除头节点的 sourceSpliterator</span></span><br><span class="line">        sourceStage.sourceSpliterator = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//这里在初始化的时候并没有 初始化 头节点的 sourceSupplier ，所以这里是null，并不会走到这里</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (sourceStage.sourceSupplier != <span class="literal">null</span>) &#123;</span><br><span class="line">        spliterator = (Spliterator&lt;?&gt;) sourceStage.sourceSupplier.get();</span><br><span class="line">        sourceStage.sourceSupplier = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(MSG_CONSUMED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断是否是并行流，触发短路。</span></span><br><span class="line">    <span class="keyword">if</span> (isParallel() &amp;&amp; sourceStage.sourceAnyStateful) &#123;</span><br><span class="line">        <span class="comment">// Adapt the source spliterator, evaluating each stateful op</span></span><br><span class="line">        <span class="comment">// in the pipeline up to and including this pipeline stage.</span></span><br><span class="line">        <span class="comment">// The depth and flags of each pipeline stage are adjusted accordingly.</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">depth</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="meta">@SuppressWarnings(&quot;rawtypes&quot;)</span> <span class="type">AbstractPipeline</span> <span class="variable">u</span> <span class="operator">=</span> sourceStage, p = sourceStage.nextStage, e = <span class="built_in">this</span>;</span><br><span class="line">             u != e;</span><br><span class="line">             u = p, p = p.nextStage) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">thisOpFlags</span> <span class="operator">=</span> p.sourceOrOpFlags;</span><br><span class="line">            <span class="keyword">if</span> (p.opIsStateful()) &#123;</span><br><span class="line">                depth = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (StreamOpFlag.SHORT_CIRCUIT.isKnown(thisOpFlags)) &#123;</span><br><span class="line">                    <span class="comment">// Clear the short circuit flag for next pipeline stage</span></span><br><span class="line">                    <span class="comment">// This stage encapsulates short-circuiting, the next</span></span><br><span class="line">                    <span class="comment">// stage may not have any short-circuit operations, and</span></span><br><span class="line">                    <span class="comment">// if so spliterator.forEachRemaining should be used</span></span><br><span class="line">                    <span class="comment">// for traversal</span></span><br><span class="line">                    thisOpFlags = thisOpFlags &amp; ~StreamOpFlag.IS_SHORT_CIRCUIT;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                spliterator = p.opEvaluateParallelLazy(u, spliterator);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Inject or clear SIZED on the source pipeline stage</span></span><br><span class="line">                <span class="comment">// based on the stage&#x27;s spliterator</span></span><br><span class="line">                thisOpFlags = spliterator.hasCharacteristics(Spliterator.SIZED)</span><br><span class="line">                        ? (thisOpFlags &amp; ~StreamOpFlag.NOT_SIZED) | StreamOpFlag.IS_SIZED</span><br><span class="line">                        : (thisOpFlags &amp; ~StreamOpFlag.IS_SIZED) | StreamOpFlag.NOT_SIZED;</span><br><span class="line">            &#125;</span><br><span class="line">            p.depth = depth++;</span><br><span class="line">            p.combinedFlags = StreamOpFlag.combineOpFlags(thisOpFlags, u.combinedFlags);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//直接到这里，由于传进来的是0，所以直接返回了</span></span><br><span class="line">    <span class="keyword">if</span> (terminalFlags != <span class="number">0</span>)  &#123;</span><br><span class="line">        <span class="comment">// Apply flags from the terminal operation to last pipeline stage</span></span><br><span class="line">        <span class="comment">// 合并结果态操作到最后一个流操作的标志</span></span><br><span class="line">        combinedFlags = StreamOpFlag.combineOpFlags(terminalFlags, combinedFlags);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//直接到这里返回 头节点的 ArrayListSpliterator</span></span><br><span class="line">    <span class="keyword">return</span> spliterator;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>回到上面<code>evaluate</code>方法的这段代码<code>terminalOp.evaluateSequential(this, sourceSpliterator(terminalOp.getOpFlags()));</code></p>
<ul>
<li>第一个参数是this</li>
<li>第二个参数是刚才返回的 头节点的 ArrayListSpliterator</li>
<li>复习一下ArrayListSpliterator的属性<ul>
<li>list &#x3D; list</li>
<li>index &#x3D; 0</li>
<li>fence &#x3D; -1</li>
<li>expectedModCount &#x3D; 0</li>
</ul>
</li>
</ul>
<p>接下来走到了 结果态 对象的 <code>evaluateSequential</code> 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;P_IN&gt; R <span class="title function_">evaluateSequential</span><span class="params">(PipelineHelper&lt;T&gt; helper,</span></span><br><span class="line"><span class="params">                                    Spliterator&lt;P_IN&gt; spliterator)</span> &#123;</span><br><span class="line">    <span class="comment">//调用stream流的wrapAndCopyInto方法</span></span><br><span class="line">    <span class="comment">//第一个参数是 makeSink 方法生成的 ReducingSink 对象，第二个参数是 ArrayListSpliterator</span></span><br><span class="line">    <span class="keyword">return</span> helper.wrapAndCopyInto(makeSink(), spliterator).get();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//makeSink是上面生成 结果态 对象的时候在 ReduceOp 对象里面加的</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ReducingSink <span class="title function_">makeSink</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 返回了一个 ReducingSink 对象。</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ReducingSink</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这个类，提供了三个方法。等用到的时候说。</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReducingSink</span> <span class="keyword">extends</span> <span class="title class_">Box</span>&lt;I&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">AccumulatingSink</span>&lt;T, I, ReducingSink&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">begin</span><span class="params">(<span class="type">long</span> size)</span> &#123;</span><br><span class="line">        state = supplier.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(T t)</span> &#123;</span><br><span class="line">        accumulator.accept(state, t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">combine</span><span class="params">(ReducingSink other)</span> &#123;</span><br><span class="line">        state = combiner.apply(state, other.state);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看一下流的<code>wrapAndCopyInto</code>方法。这个方法在 <code>AbstractPipeline</code> 类里面。</p>
<ul>
<li>第一个参数是 ReducingSink 对象</li>
<li>第二个参数是 ArrayListSpliterator 对象</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">final</span> &lt;P_IN, S <span class="keyword">extends</span> <span class="title class_">Sink</span>&lt;E_OUT&gt;&gt; S <span class="title function_">wrapAndCopyInto</span><span class="params">(S sink, Spliterator&lt;P_IN&gt; spliterator)</span> &#123;</span><br><span class="line">    <span class="comment">//调用过来 copyInfo 方法，第一个参数又调用了 wrapSink方法</span></span><br><span class="line">    copyInto(wrapSink(Objects.requireNonNull(sink)), spliterator);</span><br><span class="line">    <span class="keyword">return</span> sink;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//参数是 ReducingSink 对象</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="keyword">final</span> &lt;P_IN&gt; Sink&lt;P_IN&gt; <span class="title function_">wrapSink</span><span class="params">(Sink&lt;E_OUT&gt; sink)</span> &#123;</span><br><span class="line">    <span class="comment">//参数校验</span></span><br><span class="line">    Objects.requireNonNull(sink);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// for循环 p = 当前节点，如果p的深度 &gt; 0, 就循环，然后p = p的前一个节点</span></span><br><span class="line">    <span class="comment">// 也就是从当前节点往前遍历，一直到头节点。</span></span><br><span class="line">    <span class="comment">// 当前节点按照我们写的就是 filter 节点。</span></span><br><span class="line">    <span class="keyword">for</span> ( <span class="meta">@SuppressWarnings(&quot;rawtypes&quot;)</span> AbstractPipeline p=AbstractPipeline.<span class="built_in">this</span>; p.depth &gt; <span class="number">0</span>; p=p.previousStage) &#123;</span><br><span class="line">        <span class="comment">// 调用每个节点的 opWrapSink 方法，传入前一个节点的标志位和 sink 对象。第一次是 ReducingSink</span></span><br><span class="line">        <span class="comment">// 调用 filter 节点的结束后 把包装好的 sink链 也就是 ChainedReference 对象赋值给 sink。</span></span><br><span class="line">        <span class="comment">// 调用 map 节点的时候，传入的sink变成了 filter 返回的 ChainedReference 对象。</span></span><br><span class="line">        sink = p.opWrapSink(p.previousStage.combinedFlags, sink);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (Sink&lt;P_IN&gt;) sink;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>回顾一下 <code>filter</code> 节点的 <code>opWrapSink</code> 方法 。这是在中间态节点生成的时候，创建无状态对象的时候添加的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StatelessOp</span>&lt;P_OUT, P_OUT&gt;(<span class="built_in">this</span>, StreamShape.REFERENCE, StreamOpFlag.NOT_SIZED) &#123;</span><br><span class="line">    <span class="comment">//增加了opWrapSink方法，第一个参数是标志 = 90，第二个是 ReducingSink 对象</span></span><br><span class="line">    <span class="comment">//这个方法会在结果态的时候调用</span></span><br><span class="line">    Sink&lt;P_OUT&gt; <span class="title function_">opWrapSink</span><span class="params">(<span class="type">int</span> flags, Sink&lt;P_OUT&gt; sink)</span> &#123;</span><br><span class="line">        <span class="comment">//创建一个 Sink.ChainedReference类的对象并返回。传入 ReducingSink 对象</span></span><br><span class="line">        <span class="comment">//简单来说就是包装 sink 对象，并创建出一个 sink 执行链。</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Sink</span>.ChainedReference&lt;P_OUT, P_OUT&gt;(sink) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="comment">//这里重写了 ChainedReference 的 begin 方法</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">begin</span><span class="params">(<span class="type">long</span> size)</span> &#123;</span><br><span class="line">                <span class="comment">//调用 ReducingSink 的 begin 并传入 -1</span></span><br><span class="line">                downstream.begin(-<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//重写了 accept 方法</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(P_OUT u)</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (predicate.test(u))</span><br><span class="line">                    downstream.accept(u);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ChainedReference</span>&lt;T, E_OUT&gt; <span class="keyword">implements</span> <span class="title class_">Sink</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Sink&lt;? <span class="built_in">super</span> E_OUT&gt; downstream;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//这里的 downstream = ReducingSink 赋值给对象的 downstream 属性。</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ChainedReference</span><span class="params">(Sink&lt;? <span class="built_in">super</span> E_OUT&gt; downstream)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.downstream = Objects.requireNonNull(downstream);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">begin</span><span class="params">(<span class="type">long</span> size)</span> &#123;</span><br><span class="line">        downstream.begin(size);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">end</span><span class="params">()</span> &#123;</span><br><span class="line">        downstream.end();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">cancellationRequested</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> downstream.cancellationRequested();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看一下现在的 sink 链</p>
<p><img src="/../images/stream5.png" alt="stream5.png"></p>
<p>回顾一下 <code>map</code> 节点的 <code>opWrapSink</code> 方法 。这是在中间态节点生成的时候，创建无状态对象的时候添加的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StatelessOp</span>&lt;P_OUT, R&gt;(<span class="built_in">this</span>, StreamShape.REFERENCE,StreamOpFlag.NOT_SORTED | StreamOpFlag.NOT_DISTINCT) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//增加了opWrapSink方法，第一个参数是标志 = 95，第二个是 ChainedReference 对象</span></span><br><span class="line">    <span class="comment">//这个方法会在结果态的时候调用</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    Sink&lt;P_OUT&gt; <span class="title function_">opWrapSink</span><span class="params">(<span class="type">int</span> flags, Sink&lt;R&gt; sink)</span> &#123;</span><br><span class="line">        <span class="comment">//再次创建一个 Sink.ChainedReference类的对象并返回。传入一个 ChainedReference 对象</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Sink</span>.ChainedReference&lt;P_OUT, R&gt;(sink) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//这里重写了 accpet方法</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(P_OUT u)</span> &#123;</span><br><span class="line">                downstream.accept(mapper.apply(u));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ChainedReference</span>&lt;T, E_OUT&gt; <span class="keyword">implements</span> <span class="title class_">Sink</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Sink&lt;? <span class="built_in">super</span> E_OUT&gt; downstream;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//这里的 downstream = ChainedReference 赋值给对象的 downstream 属性。</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ChainedReference</span><span class="params">(Sink&lt;? <span class="built_in">super</span> E_OUT&gt; downstream)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.downstream = Objects.requireNonNull(downstream);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">begin</span><span class="params">(<span class="type">long</span> size)</span> &#123;</span><br><span class="line">        downstream.begin(size);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">end</span><span class="params">()</span> &#123;</span><br><span class="line">        downstream.end();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">cancellationRequested</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> downstream.cancellationRequested();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>看一下现在的 sink 链。</p>
<p><img src="/../images/stream6.png" alt="stream6.png"></p>
<p>现在来到 <code>copyInto</code> 方法。这个方法两个参数</p>
<ul>
<li>第一个是包装好的 sink 链。</li>
<li>第二个是 ArrayListSpliterator 对象</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">final</span> &lt;P_IN&gt; <span class="keyword">void</span> <span class="title function_">copyInto</span><span class="params">(Sink&lt;P_IN&gt; wrappedSink, Spliterator&lt;P_IN&gt; spliterator)</span> &#123;</span><br><span class="line">    <span class="comment">//参数校验</span></span><br><span class="line">    Objects.requireNonNull(wrappedSink);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//getStreamAndOpFlags方法获取标志位 154</span></span><br><span class="line">    <span class="comment">//isKnown返回false</span></span><br><span class="line">    <span class="keyword">if</span> (!StreamOpFlag.SHORT_CIRCUIT.isKnown(getStreamAndOpFlags())) &#123;</span><br><span class="line">        <span class="comment">// getExactSizeIfKnown = 7 因为list的大小是 7</span></span><br><span class="line">        <span class="comment">// 调用了 sink 的 begin。现在的 sink 是 map 的 sink，没有重写 begin</span></span><br><span class="line">        <span class="comment">// 所以 begin 是 downstream.begin(size); size = 7</span></span><br><span class="line">        <span class="comment">// 而map sink的 downstream指向了 filter 的 sink，所以调用了filter sink 的 begin</span></span><br><span class="line">        <span class="comment">// filter 重写了，是 downstream.begin(-1); 调用了 ReducingSink 的 begin</span></span><br><span class="line">        <span class="comment">// ReducingSink 的 begin 是给 state 赋值 supplier.get()的值 是 0</span></span><br><span class="line">        wrappedSink.begin(spliterator.getExactSizeIfKnown());</span><br><span class="line">        <span class="comment">// 循环剩余的数据，传入 sink 链</span></span><br><span class="line">        spliterator.forEachRemaining(wrappedSink);</span><br><span class="line">        <span class="comment">// 执行结束方法</span></span><br><span class="line">        <span class="comment">// 先调用 map sink, 然后 filter sink 然后 collect 的end</span></span><br><span class="line">        wrappedSink.end();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        copyIntoWithCancel(wrappedSink, spliterator);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//判断这个标志是否在流上设置，是否在操作上设置。是否在流和操作的组合上设置。</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">isKnown</span><span class="params">(<span class="type">int</span> flags)</span> &#123;</span><br><span class="line">    <span class="comment">// 154 &amp; 50331648 == 16777216</span></span><br><span class="line">    <span class="comment">// 返回 false</span></span><br><span class="line">    <span class="keyword">return</span> (flags &amp; preserve) == set;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果能获取到size 就返回 size，不然返回 -1</span></span><br><span class="line"><span class="keyword">default</span> <span class="type">long</span> <span class="title function_">getExactSizeIfKnown</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (characteristics() &amp; SIZED) == <span class="number">0</span> ? -<span class="number">1L</span> : estimateSize();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取大小</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">estimateSize</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">long</span>) (getFence() - index);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看循环方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">forEachRemaining</span><span class="params">(Consumer&lt;? <span class="built_in">super</span> E&gt; action)</span> &#123;</span><br><span class="line">    <span class="comment">//声明变量</span></span><br><span class="line">    <span class="type">int</span> i, hi, mc; <span class="comment">// hoist accesses and checks from loop</span></span><br><span class="line">    ArrayList&lt;E&gt; lst; Object[] a;</span><br><span class="line">    <span class="comment">//参数校验，空指针</span></span><br><span class="line">    <span class="keyword">if</span> (action == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//list 是我们的数据 不为空并且取出一个元素也不为空</span></span><br><span class="line">    <span class="keyword">if</span> ((lst = list) != <span class="literal">null</span> &amp;&amp; (a = lst.elementData) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//把大小赋值给hi = 7</span></span><br><span class="line">        <span class="keyword">if</span> ((hi = fence) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            mc = lst.modCount;</span><br><span class="line">            hi = lst.size;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">// mc = 7</span></span><br><span class="line">            mc = expectedModCount;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// index &gt;=0 并且 hi &lt;= list的数量</span></span><br><span class="line">        <span class="comment">// i = 0 index = hi = 7</span></span><br><span class="line">        <span class="keyword">if</span> ((i = index) &gt;= <span class="number">0</span> &amp;&amp; (index = hi) &lt;= a.length) &#123;</span><br><span class="line">            <span class="comment">//开始循环 0 &lt; 7, 执行完循环后 ++i, i = 1</span></span><br><span class="line">            <span class="keyword">for</span> (; i &lt; hi; ++i) &#123;</span><br><span class="line">                <span class="comment">//取出一个元素</span></span><br><span class="line">                <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span> <span class="type">E</span> <span class="variable">e</span> <span class="operator">=</span> (E) a[i];</span><br><span class="line">                <span class="comment">//调用 sink 链的 accpet方法 传入 该元素。</span></span><br><span class="line">                action.accept(e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//循环完以后判断一下是否全部都处理完了 完成就返回</span></span><br><span class="line">            <span class="keyword">if</span> (lst.modCount == mc)</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//抛出异常</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConcurrentModificationException</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//map的 accpet方法</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(P_OUT u)</span> &#123;</span><br><span class="line">    <span class="comment">//先进行处理 mapper.apply相当于调用了我们map传入的方法</span></span><br><span class="line">    <span class="comment">//将结果沿着sink链传播</span></span><br><span class="line">    downstream.accept(mapper.apply(u));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//filter的 accept 方法</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(P_OUT u)</span> &#123;</span><br><span class="line">    <span class="comment">//predicate.test就相当于调用了我们 filter 的时候传入的方法。</span></span><br><span class="line">    <span class="comment">//看过滤结果是否成功，如果成功继续沿着sink链流动。</span></span><br><span class="line">    <span class="comment">//不成功则不流动。</span></span><br><span class="line">    <span class="keyword">if</span> (predicate.test(u))</span><br><span class="line">        downstream.accept(u);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//结果态的collect的 accept 方法</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReducingSink</span> <span class="keyword">extends</span> <span class="title class_">Box</span>&lt;I&gt; <span class="keyword">implements</span> <span class="title class_">AccumulatingSink</span>&lt;T, I, ReducingSink&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">begin</span><span class="params">(<span class="type">long</span> size)</span> &#123;</span><br><span class="line">        <span class="comment">// 初始化</span></span><br><span class="line">        state = supplier.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(T t)</span> &#123;</span><br><span class="line">        <span class="comment">// 执行累加器的 accpet</span></span><br><span class="line">        <span class="comment">// 这个就是 state.add(t) 具体后面会讲</span></span><br><span class="line">        accumulator.accept(state, t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>最后，回到开始的collect方法中。evaluate会返回我们刚才一系列操作以后收集到的满足条件的list</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> &lt;R, A&gt; R <span class="title function_">collect</span><span class="params">(Collector&lt;? <span class="built_in">super</span> P_OUT, A, R&gt; collector)</span> &#123;</span><br><span class="line">    <span class="comment">//声明一个变量</span></span><br><span class="line">    A container;</span><br><span class="line">    <span class="comment">//判断是否并行流。短路，直接走else</span></span><br><span class="line">    <span class="keyword">if</span> (isParallel()</span><br><span class="line">            &amp;&amp; (collector.characteristics().contains(Collector.Characteristics.CONCURRENT))</span><br><span class="line">            &amp;&amp; (!isOrdered() || collector.characteristics().contains(Collector.Characteristics.UNORDERED))) &#123;</span><br><span class="line">        container = collector.supplier().get();</span><br><span class="line">        BiConsumer&lt;A, ? <span class="built_in">super</span> P_OUT&gt; accumulator = collector.accumulator();</span><br><span class="line">        forEach(u -&gt; accumulator.accept(container, u));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//调用evaluate方法</span></span><br><span class="line">        container = evaluate(ReduceOps.makeRef(collector));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//判断标志位，collector.characteristics() = IDENTITY_FINISH</span></span><br><span class="line">    <span class="comment">// 所以这里直接返回 收集的 list</span></span><br><span class="line">    <span class="keyword">return</span> collector.characteristics().contains(Collector.Characteristics.IDENTITY_FINISH)</span><br><span class="line">            ? (R) container</span><br><span class="line">            : collector.finisher().apply(container);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://thepatterraining.github.io/php%20yii2%E6%A1%86%E6%9E%B6%E5%89%8D%E7%AB%AF%E5%8A%A0%E8%BD%BDcss%E5%92%8Cjs%E6%96%87%E4%BB%B6%E7%9A%84%E6%96%B9%E6%B3%95.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpeg">
      <meta itemprop="name" content="Thepatter">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/php%20yii2%E6%A1%86%E6%9E%B6%E5%89%8D%E7%AB%AF%E5%8A%A0%E8%BD%BDcss%E5%92%8Cjs%E6%96%87%E4%BB%B6%E7%9A%84%E6%96%B9%E6%B3%95.html" class="post-title-link" itemprop="url">php yii2框架前端加载css和js文件的方法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-21 10:12:47" itemprop="dateCreated datePublished" datetime="2020-08-21T10:12:47+08:00">2020-08-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-01-26 10:07:53" itemprop="dateModified" datetime="2025-01-26T10:07:53+08:00">2025-01-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/" itemprop="url" rel="index"><span itemprop="name">php</span></a>
                </span>
            </span>

          
            <span id="/php%20yii2%E6%A1%86%E6%9E%B6%E5%89%8D%E7%AB%AF%E5%8A%A0%E8%BD%BDcss%E5%92%8Cjs%E6%96%87%E4%BB%B6%E7%9A%84%E6%96%B9%E6%B3%95.html" class="post-meta-item leancloud_visitors" data-flag-title="php yii2框架前端加载css和js文件的方法" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/php%20yii2%E6%A1%86%E6%9E%B6%E5%89%8D%E7%AB%AF%E5%8A%A0%E8%BD%BDcss%E5%92%8Cjs%E6%96%87%E4%BB%B6%E7%9A%84%E6%96%B9%E6%B3%95.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/php%20yii2%E6%A1%86%E6%9E%B6%E5%89%8D%E7%AB%AF%E5%8A%A0%E8%BD%BDcss%E5%92%8Cjs%E6%96%87%E4%BB%B6%E7%9A%84%E6%96%B9%E6%B3%95.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="php-yii2框架前端加载css和js文件的方法"><a href="#php-yii2框架前端加载css和js文件的方法" class="headerlink" title="php yii2框架前端加载css和js文件的方法"></a>php yii2框架前端加载css和js文件的方法</h1><p>这两天有一个以前的项目是用<code>yii2</code>框架写的，前后端没有做分离，现在需要用vue接手后续的前端开发。</p>
<p>把vue的项目放到yii2里面，这时候遇到一个加载静态资源的问题，原来html的引用方式不管用了。</p>
<p>后来看到yii2官方文档里面，需要改一下引用方式。</p>
<p>改成下面这样就可以了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">registerCssFile</span>(<span class="string">&quot;@web/static_vue/css/index.css&quot;</span>)</span><br><span class="line"><span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">registerJsFile</span>(<span class="string">&quot;@web/static_vue/js/index.js&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>所有都使用这两个php代码进行引入，引入后就可以了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://thepatterraining.github.io/wsl%E5%AE%89%E8%A3%85go%E7%8E%AF%E5%A2%83.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpeg">
      <meta itemprop="name" content="Thepatter">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/wsl%E5%AE%89%E8%A3%85go%E7%8E%AF%E5%A2%83.html" class="post-title-link" itemprop="url">wsl安装go环境</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-21 10:12:47" itemprop="dateCreated datePublished" datetime="2020-08-21T10:12:47+08:00">2020-08-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-01-26 10:07:53" itemprop="dateModified" datetime="2025-01-26T10:07:53+08:00">2025-01-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
                </span>
            </span>

          
            <span id="/wsl%E5%AE%89%E8%A3%85go%E7%8E%AF%E5%A2%83.html" class="post-meta-item leancloud_visitors" data-flag-title="wsl安装go环境" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/wsl%E5%AE%89%E8%A3%85go%E7%8E%AF%E5%A2%83.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/wsl%E5%AE%89%E8%A3%85go%E7%8E%AF%E5%A2%83.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="wsl"><a href="#wsl" class="headerlink" title="wsl"></a>wsl</h1><p>wsl是可以在windows里面运行linux的一个软件。是微软官方发行的。</p>
<h2 id="安装go"><a href="#安装go" class="headerlink" title="安装go"></a>安装go</h2><p>先去到安装目录<code>/usr/local/src</code>。</p>
<p>从go官网下载go tar包。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo wget https://golang.org/dl/go1.16.3.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>

<p>然后解压</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tar -zxvf go1.16.3.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>

<p>接下来需要配置环境变量。可以设置在&#x2F;etc&#x2F;profile文件里面也可以设置在其他地方，我用的是zsh，所以我的环境变量配置在~&#x2F;.zshrc文件里面。</p>
<p>执行<code>vim ~/.zshrc</code>。然后添加变量信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export GOROOT=&quot;/usr/local/src/go&quot;</span><br><span class="line">export PATH=&quot;$PATH:$GOROOT/bin&quot;</span><br></pre></td></tr></table></figure>

<p>接下来重新加载一下配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.zshrc</span><br></pre></td></tr></table></figure>

<p>现在go就安装好了。可以执行<code>go version</code>查看go的版本。</p>
<h2 id="创建第一个go-项目"><a href="#创建第一个go-项目" class="headerlink" title="创建第一个go 项目"></a>创建第一个go 项目</h2><p>我把项目放在<code>~/go</code>目录下。所以把这个目录添加到配置文件里面。因为这个目录也相当于<code>$HOME/go</code>。所以我们直接添加。</p>
<p>执行<code>vim ~/.zshrc</code>。然后添加变量信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export GOPATH=&quot;$HOME/go&quot;</span><br></pre></td></tr></table></figure>


<p>接下来重新加载一下配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.zshrc</span><br></pre></td></tr></table></figure>

<p>在项目目录下面创建第一个文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ~/go/hello.go</span><br></pre></td></tr></table></figure>

<p>添加下面的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">package main</span><br><span class="line"></span><br><span class="line">import &quot;fmt&quot;</span><br><span class="line"></span><br><span class="line">func main () &#123;</span><br><span class="line">        fmt.Printf(&quot;hello world\n&quot;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进行编译</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go build ~/go/hello.go</span><br></pre></td></tr></table></figure>

<p>编译完成出现<code>hello</code>文件，直接执行。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/go/hello</span><br></pre></td></tr></table></figure>

<p>就可以看到输出了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://thepatterraining.github.io/wsl%E5%AE%89%E8%A3%85php%E7%8E%AF%E5%A2%83.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpeg">
      <meta itemprop="name" content="Thepatter">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dream">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/wsl%E5%AE%89%E8%A3%85php%E7%8E%AF%E5%A2%83.html" class="post-title-link" itemprop="url">wsl安装php环境</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-21 10:12:47" itemprop="dateCreated datePublished" datetime="2020-08-21T10:12:47+08:00">2020-08-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-01-26 10:07:53" itemprop="dateModified" datetime="2025-01-26T10:07:53+08:00">2025-01-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/" itemprop="url" rel="index"><span itemprop="name">php</span></a>
                </span>
            </span>

          
            <span id="/wsl%E5%AE%89%E8%A3%85php%E7%8E%AF%E5%A2%83.html" class="post-meta-item leancloud_visitors" data-flag-title="wsl安装php环境" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/wsl%E5%AE%89%E8%A3%85php%E7%8E%AF%E5%A2%83.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/wsl%E5%AE%89%E8%A3%85php%E7%8E%AF%E5%A2%83.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="wsl"><a href="#wsl" class="headerlink" title="wsl"></a>wsl</h1><p>wsl是可以在windows里面运行linux的一个软件。是微软官方发行的。</p>
<h2 id="安装php"><a href="#安装php" class="headerlink" title="安装php"></a>安装php</h2><p>从php官网下载php tar包。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo wget https://www.php.net/distributions/php-7.4.12.tar.gz</span><br></pre></td></tr></table></figure>

<p>然后解压</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tar -zxvf php-7.4.12.tar.gz</span><br></pre></td></tr></table></figure>

<p>接下来需要安装一些扩展来支持php。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install gcc make pkg-config libxml2-dev libssl-dev libsqlite3-dev libcurl4-openssl-dev libonig-dev zlib1g-dev libffi-dev libpng-dev libzip-dev</span><br></pre></td></tr></table></figure>

<p>不安装上面的扩展会导致接下来报错。</p>
<p>切换目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd ./php-7.4.12</span><br></pre></td></tr></table></figure>

<p>执行configure,注意这里<code>prefix</code>一定要是&#x2F;usr&#x2F;local&#x2F;php7，要不然找不到配置文件php.ini。这里有这个坑。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ./configure --enable-fpm --with-mysql --with-pear --with-zip --enable-sockets --enable-soap --with-pdo-mysql  --enable-gd --enable-ftp --with-ffi  --with-zlib  --with-curl --with-openssl --enable-mbstring --prefix=/usr/local/php7 --with-config-file-path=/usr/local/php7 --with-external-gd --with-webp  --with-jpeg  --with-xpm  --with-freetype  --enable-bcmath</span><br></pre></td></tr></table></figure>

<p>执行完上面一步如果没有错误就可以了。</p>
<p>接下来执行make</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo make &amp;&amp; sudo make install</span><br></pre></td></tr></table></figure>

<p>复制一些配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo cp /usr/local/src/php7/etc/php-fpm.conf.default /usr/local/src/php7/etc/php-fpm.conf</span><br><span class="line">sudo cp /usr/local/src/php7/etc/php-fpm.d/www.conf.default /usr/local/src/php7/etc/php-fpm.d/www.conf</span><br></pre></td></tr></table></figure>

<p>修改php-fpm的用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /usr/local/src/php7/etc/php-fpm.d/www.conf</span><br></pre></td></tr></table></figure>

<p>找到 <code>user</code> 和 <code>group</code> 这两个参数，原来的值是 <code>nobody</code>改成<code>www-data</code>，然后保存退出。</p>
<p>建立软连接或者环境变量。我们要配置全局的环境变量有两种方式。</p>
<ul>
<li>在环境变量目录里面增加软连接</li>
<li>把php目录增加到环境变量里面</li>
</ul>
<p>我采用的是软连接的方式。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo ln -s /usr/local/php7/bin/php /usr/local/bin/php</span><br><span class="line">sudo ln -s /usr/local/php7/bin/phpize /usr/local/bin/phpize</span><br><span class="line">sudo ln -s /usr/local/php7/sbin/php-fpm /usr/local/bin/php-fpm</span><br></pre></td></tr></table></figure>

<p>接下来就可以全局使用php命令了</p>
<h3 id="php-fpm启动，重启方法"><a href="#php-fpm启动，重启方法" class="headerlink" title="php-fpm启动，重启方法"></a>php-fpm启动，重启方法</h3><p>启动</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo php-fpm</span><br></pre></td></tr></table></figure>

<p>重启 先找到进程 然后发送<code>USR2</code>信号</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ps -aux | grep php</span><br><span class="line"></span><br><span class="line">sudo kill -USR2 进程id</span><br></pre></td></tr></table></figure>


<h2 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h2><p>访问nginx的<a target="_blank" rel="noopener" href="https://nginx.org/en/download.html">官网</a>进行下载。</p>
<p>复制下载地址。比如我下载的1.19.5,直接下载</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo wget https://nginx.org/download/nginx-1.19.5.tar.gz</span><br></pre></td></tr></table></figure>

<p>然后解压</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tar -zxvf nginx-1.19.5.tar.gz</span><br></pre></td></tr></table></figure>

<p>接下来需要安装一些扩展来支持php。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libpcre3 libpcre3-dev</span><br></pre></td></tr></table></figure>

<p>切换目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd ./nginx-1.19.5</span><br></pre></td></tr></table></figure>

<p>执行安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ./configure --with-file-aio --with-http_ssl_module --with-http_v2_module --with-http_realip_module --prefix=/usr/local/src/nginx</span><br><span class="line">sudo make &amp;&amp; sudo make install</span><br></pre></td></tr></table></figure>

<p>好了，安装完成。</p>
<p>同意，建立软连接。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ln -s /usr/local/src/nginx/sbin/nginx /usr/local/bin/nginx</span><br></pre></td></tr></table></figure>

<p>接下来启动nginx看看效果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx</span><br></pre></td></tr></table></figure>

<p>访问localhost就可以看到效果了。</p>
<h2 id="配置网站"><a href="#配置网站" class="headerlink" title="配置网站"></a>配置网站</h2><p>接下来配置一下网站。</p>
<p>修改nginx.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /usr/local/src/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure>

<p>在http块里面加上这句话，引入其他的配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include     conf.d/*.conf;</span><br></pre></td></tr></table></figure>

<p>然后我们创建这个目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir /usr/local/src/nginx/conf/conf.d</span><br></pre></td></tr></table></figure>

<p>配置我们的网站文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /usr/local/src/nginx/conf/conf.d/test.com.conf</span><br></pre></td></tr></table></figure>

<p>复制下面内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  test.com;</span><br><span class="line">        root   &quot;/home/wwwroot/test/public/&quot;;</span><br><span class="line">        location / &#123;</span><br><span class="line">            index index.php index.html error/index.html;</span><br><span class="line">            autoindex  off;</span><br><span class="line">            if (!-e $request_filename) &#123;</span><br><span class="line">                rewrite ^(.*)$ /index.php?s=/$1 last;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        location ~ \.php(.*)$ &#123;</span><br><span class="line">            fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">            fastcgi_index  index.php;</span><br><span class="line">            fastcgi_split_path_info  ^((?U).+\.php)(/?.+)$;</span><br><span class="line">            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</span><br><span class="line">            fastcgi_param  PATH_INFO  $fastcgi_path_info;</span><br><span class="line">            fastcgi_param  PATH_TRANSLATED  $document_root$fastcgi_path_info;</span><br><span class="line">            include        fastcgi_params;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在修改hosts文件就好了。</p>
<h2 id="redis扩展"><a href="#redis扩展" class="headerlink" title="redis扩展"></a>redis扩展</h2><p>如果要装redis扩展，那么手动下载</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://pecl.php.net/package/redis</span><br></pre></td></tr></table></figure>

<p>找到tar包下载</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo wget http://pecl.php.net/get/redis-5.3.2.tgz</span><br></pre></td></tr></table></figure>

<p>解压缩</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tar -zxvf redis-5.3.2.tgz</span><br></pre></td></tr></table></figure>

<p>进去执行phpize</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ./redis-5.3.2</span><br><span class="line">sudo phpize</span><br></pre></td></tr></table></figure>

<p>然后编译</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ./configure --with-php-config=/usr/local/php7/bin/php-config</span><br><span class="line">sudo make &amp;&amp; sudo make install</span><br></pre></td></tr></table></figure>

<p>接下来会出现下面的目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/php7/lib/php/extensions/no-debug-non-zts-20190902</span><br></pre></td></tr></table></figure>

<p>修改我们的php.ini</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /usr/local/php7/lib/php.ini</span><br></pre></td></tr></table></figure>

<p>修改下面这个</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extension_dir=/usr/local/php7/lib/php/extensions/no-debug-non-zts-20190902</span><br></pre></td></tr></table></figure>

<p>增加redis扩展</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extension=&quot;redis.so&quot;</span><br></pre></td></tr></table></figure>

<p>重启nginx和php-fpm就好了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/13/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><span class="page-number current">14</span><a class="page-number" href="/page/15/">15</a><span class="space">&hellip;</span><a class="page-number" href="/page/21/">21</a><a class="extend next" rel="next" href="/page/15/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Thepatter"
      src="/images/header.jpeg">
  <p class="site-author-name" itemprop="name">Thepatter</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">203</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">38</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">83</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Thepatterraining" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Thepatterraining" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:ztzhoutao041@163.com" title="E-Mail → mailto:ztzhoutao041@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://blog.csdn.net/Thepatterraining" title="CSDN → http:&#x2F;&#x2F;blog.csdn.net&#x2F;Thepatterraining" rel="noopener" target="_blank"><i class="fa fa-fw fa-CSDN"></i>CSDN</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Thepatter</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

        






<script>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              leancloudSelector(url).innerText = 'Counter not initialized! More info at console err msg.';
              console.error('ATTENTION! LeanCloud counter has security bug, see how to solve it here: https://github.com/theme-next/hexo-leancloud-counter-security. \n However, you can still use LeanCloud without security, by setting `security` option to `false`.');
            
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    let { app_id, app_key, server_url } = {"enable":true,"app_id":"RWllimOI5okO7WFTUmJ4EeeD-gzGzoHsz","app_key":"hXeefwCw8aDKTJ1Xqye7fLYb","security":true};
    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script>


      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'RWllimOI5okO7WFTUmJ4EeeD-gzGzoHsz',
      appKey     : 'hXeefwCw8aDKTJ1Xqye7fLYb',
      placeholder: "给我的文章加点评论吧~",
      avatar     : 'mp',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
